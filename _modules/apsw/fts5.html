

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apsw.fts5 &mdash; APSW 3.47.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=72bcf2f2" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/apsw.css?v=3c7e2631" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f152ac2d"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            APSW
              <img src="../../_static/apswlogo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation and customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bestpractice.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apsw.html">APSW Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connection.html">Connections to a database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cursor.html">Cursors (executing SQL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../blob.html">Blob Input/Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backup.html">Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example-fts.html">Full Text Search Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../textsearch.html">Full text search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vtable.html">Virtual Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vfs.html">Virtual File System (VFS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ext.html">Various interesting and useful bits of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exceptions.html">Exceptions and Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../execution.html">Execution and tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dbapi.html">DBAPI notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysqlite.html">sqlite3 module differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">APSW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../apsw.html">apsw</a></li>
      <li class="breadcrumb-item active">apsw.fts5</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for apsw.fts5</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>


<span class="sd">&quot;&quot;&quot;:mod:`apsw.fts5` Various classes and functions to work with full text search.</span>

<span class="sd">This includes :class:`Table` for creating and working with FTS5 tables</span>
<span class="sd">in a Pythonic way, numerous :ref:`tokenizers &lt;all_tokenizers&gt;`, and</span>
<span class="sd">related functionality.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="c1"># avoid clashing with html as a parameter name</span>
<span class="kn">import</span> <span class="nn">html</span> <span class="k">as</span> <span class="nn">html_module</span>
<span class="kn">import</span> <span class="nn">html.parser</span> <span class="k">as</span> <span class="nn">html_parser_module</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">importlib.resources</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">contextvars</span> <span class="kn">import</span> <span class="n">ContextVar</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Self</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Self is only available in py3.11+ but the other items import anyway</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">apsw</span>
<span class="kn">import</span> <span class="nn">apsw._unicode</span>
<span class="kn">import</span> <span class="nn">apsw.ext</span>
<span class="kn">import</span> <span class="nn">apsw.fts5query</span>
<span class="kn">import</span> <span class="nn">apsw.unicode</span>

<span class="n">unicode_categories</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Lu&quot;</span><span class="p">:</span> <span class="s2">&quot;Letter Uppercase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ll&quot;</span><span class="p">:</span> <span class="s2">&quot;Letter Lowercase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Lt&quot;</span><span class="p">:</span> <span class="s2">&quot;Letter titlecase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Lm&quot;</span><span class="p">:</span> <span class="s2">&quot;Letter modifier&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Lo&quot;</span><span class="p">:</span> <span class="s2">&quot;Letter other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mn&quot;</span><span class="p">:</span> <span class="s2">&quot;Mark nonspacing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mc&quot;</span><span class="p">:</span> <span class="s2">&quot;Mark spacing combining&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Me&quot;</span><span class="p">:</span> <span class="s2">&quot;Mark enclosing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Nd&quot;</span><span class="p">:</span> <span class="s2">&quot;Number decimal digit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Nl&quot;</span><span class="p">:</span> <span class="s2">&quot;Number letter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;No&quot;</span><span class="p">:</span> <span class="s2">&quot;Number other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pc&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation connector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pd&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation dash&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ps&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation open&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pe&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation close&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pi&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation initial quote&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pf&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation final quote&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Po&quot;</span><span class="p">:</span> <span class="s2">&quot;Punctuation other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sm&quot;</span><span class="p">:</span> <span class="s2">&quot;Symbol math&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sc&quot;</span><span class="p">:</span> <span class="s2">&quot;Symbol currency&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sk&quot;</span><span class="p">:</span> <span class="s2">&quot;Symbol modifier&quot;</span><span class="p">,</span>
    <span class="s2">&quot;So&quot;</span><span class="p">:</span> <span class="s2">&quot;Symbol other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zs&quot;</span><span class="p">:</span> <span class="s2">&quot;Separator space&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zl&quot;</span><span class="p">:</span> <span class="s2">&quot;Separator line&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Zp&quot;</span><span class="p">:</span> <span class="s2">&quot;Separator paragraph&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cc&quot;</span><span class="p">:</span> <span class="s2">&quot;Other control&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cf&quot;</span><span class="p">:</span> <span class="s2">&quot;Other format&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cs&quot;</span><span class="p">:</span> <span class="s2">&quot;Other surrogate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Co&quot;</span><span class="p">:</span> <span class="s2">&quot;Other private use&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cn&quot;</span><span class="p">:</span> <span class="s2">&quot;Other not assigned&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="s2">&quot;Unicode categories and descriptions for reference&quot;</span>

<span class="n">tokenize_reasons</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DOCUMENT&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_DOCUMENT</span><span class="p">,</span>
    <span class="s2">&quot;QUERY&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span><span class="p">,</span>
    <span class="s2">&quot;QUERY_PREFIX&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span> <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_PREFIX</span><span class="p">,</span>
    <span class="s2">&quot;AUX&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_AUX</span><span class="p">,</span>
<span class="p">}</span>

<span class="s2">&quot;Mapping between friendly strings and constants for `xTokenize flags &lt;https://www.sqlite.org/fts5.html#custom_tokenizers&gt;`__&quot;</span>


<div class="viewcode-block" id="convert_tokenize_reason">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.convert_tokenize_reason">[docs]</a>
<span class="k">def</span> <span class="nf">convert_tokenize_reason</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a space separated list of :data:`tokenize_reasons` into a set of corresponding values</span>

<span class="sd">    Use with :func:`parse_tokenizer_args`&quot;&quot;&quot;</span>
    <span class="n">res</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tokenize_reasons</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="si">}</span><span class="s2"> is not a tokenizer reason - valid values are </span><span class="si">{</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokenize_reasons</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tokenize_reasons</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="convert_unicode_categories">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.convert_unicode_categories">[docs]</a>
<span class="k">def</span> <span class="nf">convert_unicode_categories</span><span class="p">(</span><span class="n">patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns Unicode categories matching space separated values</span>

<span class="sd">    :func:`fnmatch.fnmatchcase` is used to check matches.  An example</span>
<span class="sd">    pattern is ``L* Pc`` would return ``{&#39;Pc&#39;, &#39;Lm&#39;, &#39;Lo&#39;, &#39;Lu&#39;, &#39;Lt&#39;,</span>
<span class="sd">    &#39;Ll&#39;}``</span>

<span class="sd">    You can also put ! in front to exclude categories, so ``* !*m``</span>
<span class="sd">    would be all categories except those ending in ``m``.</span>

<span class="sd">    .. seealso:</span>

<span class="sd">        * :data:`unicode_categories`</span>
<span class="sd">        * `Wikipedia &lt;https://en.wikipedia.org/wiki/Unicode_character_property#General_Category&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Figure out categories expanding wild cards</span>
    <span class="n">categories</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">unicode_categories</span><span class="p">:</span>
            <span class="n">categories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">negate</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">unicode_categories</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cat</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; doesn&#39;t match any Unicode categories&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
            <span class="n">categories</span> <span class="o">-=</span> <span class="n">found</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">categories</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">categories</span></div>



<div class="viewcode-block" id="convert_string_to_python">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.convert_string_to_python">[docs]</a>
<span class="k">def</span> <span class="nf">convert_string_to_python</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a string to a Python object</span>

<span class="sd">    This is useful to process command line arguments and arguments to</span>
<span class="sd">    tokenizers.  It automatically imports the necessary modules.</span>

<span class="sd">    .. warning::</span>

<span class="sd">         The string is ultimately :func:`evaluated &lt;eval&gt;` allowing</span>
<span class="sd">         arbitrary code execution and side effects.</span>

<span class="sd">    Some examples of what is accepted are:</span>

<span class="sd">    * 3 + 4</span>
<span class="sd">    * apsw.fts5.RegexTokenizer</span>
<span class="sd">    * snowballstemmer.stemmer(&quot;english&quot;).stemWord</span>
<span class="sd">    * nltk.stem.snowball.EnglishStemmer().stem</span>
<span class="sd">    * shutil.rmtree(&quot;a/directory/location&quot;)  **COULD DELETE ALL FILES**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">imports</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span></div>



<div class="viewcode-block" id="convert_number_ranges">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.convert_number_ranges">[docs]</a>
<span class="k">def</span> <span class="nf">convert_number_ranges</span><span class="p">(</span><span class="n">numbers</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts comma separated number ranges</span>

<span class="sd">    Takes input like ``2,3-5,17`` and converts to</span>
<span class="sd">    ``{2, 3, 4, 5, 17}``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">numbers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
                <span class="n">high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to turn &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">part</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; from &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">numbers</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; into a numeric range&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="convert_boolean">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.convert_boolean">[docs]</a>
<span class="k">def</span> <span class="nf">convert_boolean</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts to boolean</span>

<span class="sd">    Accepts ``0``, ``1``, ``false``, and ``true``&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;false&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a boolean value from (0, 1, false, true) not &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="tokenizer_test_strings">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.tokenizer_test_strings">[docs]</a>
<span class="k">def</span> <span class="nf">tokenizer_test_strings</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides utf-8 bytes sequences for interesting test strings</span>

<span class="sd">    :param filename: File to load.  If None then the builtin one is used</span>

<span class="sd">    :returns: A tuple where each item is a tuple of utf8 bytes and comment str</span>

<span class="sd">    The test file should be UTF-8 encoded text.</span>

<span class="sd">    If it starts with a # then it is considered to be multiple text sections</span>
<span class="sd">    where a # line contains a description of the section.  Any lines beginning</span>
<span class="sd">    ## are ignored.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;fts_test_strings&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">apsw</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;No data&quot;</span><span class="p">),)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">),)</span>

    <span class="n">test_strings</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;##&quot;</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">lines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">test_strings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">comment</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">test_strings</span><span class="p">)</span></div>



<div class="viewcode-block" id="StringTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.StringTokenizer">[docs]</a>
<span class="k">def</span> <span class="nf">StringTokenizer</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5TokenizerFactory</span><span class="p">)</span> <span class="o">-&gt;</span><span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for tokenizers that operate on strings</span>

<span class="sd">    FTS5 tokenizers operate on UTF8 bytes for the text and offsets.</span>
<span class="sd">    This decorator provides your tokenizer with text and expects text</span>
<span class="sd">    offsets back, performing the conversions back to UTF8 byte</span>
<span class="sd">    offsets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">string_tokenizer_wrapper</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
        <span class="n">inner_tokenizer</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">inner_tokenizer</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">outer_tokenizer</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">upm</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">_unicode</span><span class="o">.</span><span class="n">to_utf8_position_mapper</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">inner_tokenizer</span><span class="p">(</span><span class="n">upm</span><span class="o">.</span><span class="n">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">upm</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">upm</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="o">*</span><span class="n">tokens</span>

        <span class="k">return</span> <span class="n">outer_tokenizer</span>

    <span class="k">return</span> <span class="n">string_tokenizer_wrapper</span></div>



<div class="viewcode-block" id="QueryTokensTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.QueryTokensTokenizer">[docs]</a>
<span class="k">def</span> <span class="nf">QueryTokensTokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recognises a special tokens marker and returns those tokens for a query.</span>
<span class="sd">    This is useful for making queries directly using tokens, instead</span>
<span class="sd">    of pre-tokenized text.</span>

<span class="sd">    It must be the first tokenizer in the list.  Any text not using</span>
<span class="sd">    the special marker is passed to the following tokenizer.</span>

<span class="sd">    See :class:`apsw.fts5query.QueryTokens` for more details on the</span>
<span class="sd">    marker format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">QueryTokens</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">decoded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">decoded</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">token</span>
                <span class="k">return</span>
        <span class="k">yield from</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">](</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="UnicodeWordsTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.UnicodeWordsTokenizer">[docs]</a>
<span class="nd">@StringTokenizer</span>
<span class="k">def</span> <span class="nf">UnicodeWordsTokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Uses `Unicode segmentation &lt;https://www.unicode.org/reports/tr29/&gt;`__ to extract words</span>

<span class="sd">    The following tokenizer parameters are accepted.  A segment is considered a word</span>
<span class="sd">    if a codepoint matching any of the categories, emoji, or regional indicator is</span>
<span class="sd">    present.</span>

<span class="sd">    categories</span>
<span class="sd">        Default ``L* N*`` to include letters, and numbers.  You should consider ``Pd``</span>
<span class="sd">        for punctuation dash if you want words separated with dashes to be considered one word.</span>
<span class="sd">        ``Sm`` for maths symbols and ``Sc`` for currency symbols may also be relevant,</span>

<span class="sd">    emoji</span>
<span class="sd">        ``0`` or ``1`` (default) if emoji are included.  They will be a word</span>
<span class="sd">        by themselves.</span>

<span class="sd">    regional_indicator</span>
<span class="sd">        ``0`` or ``1`` (default) if `regional indicators</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Regional_indicator_symbol&gt;`__ like ðŸ‡¬ðŸ‡§ ðŸ‡µðŸ‡­</span>
<span class="sd">        are included.  They will be a word  by themselves.</span>

<span class="sd">    This does a lot better than the `unicode61` tokenizer builtin to FTS5.  It</span>
<span class="sd">    understands user perceived characters (made of many codepoints), and punctuation</span>
<span class="sd">    within words (eg ``don&#39;t`` is considered two words ``don`` and ``t`` by `unicode61`),</span>
<span class="sd">    as well as how various languages work.</span>

<span class="sd">    For languages where there is no spacing or similar between words, only a dictionary</span>
<span class="sd">    can determine actual word boundaries.  Examples include Japanese, Chinese, and Khmer.</span>
<span class="sd">    In this case the algorithm returns the user perceived characters individually making</span>
<span class="sd">    it similar to :meth:`NGramTokenizer` which will provide good search experience at</span>
<span class="sd">    the cost of a slightly larger index.</span>

<span class="sd">    Use the :func:`SimplifyTokenizer` to make case insensitive, remove diacritics,</span>
<span class="sd">    combining marks, and use compatibility code points.</span>

<span class="sd">    See the :ref:`example &lt;example_fts_apsw_unicodewords&gt;`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;L* N*&quot;</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_unicode_categories</span><span class="p">,</span> <span class="n">convert_default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;emoji&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
        <span class="s2">&quot;regional_indicator&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">word_iter_with_offsets</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="SimplifyTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.SimplifyTokenizer">[docs]</a>
<span class="k">def</span> <span class="nf">SimplifyTokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tokenizer wrapper that simplifies tokens by neutralizing case, canonicalization, and diacritic/mark removal</span>

<span class="sd">    Put this before another tokenizer to simplify its output.  For example:</span>

<span class="sd">       simplify casefold true unicodewords</span>

<span class="sd">    The following tokenizer arguments are accepted, and are applied to each</span>
<span class="sd">    token in this order.  If you do not specify an argument then it is off.</span>

<span class="sd">    strip</span>
<span class="sd">        Codepoints become their compatibility representation - for example</span>
<span class="sd">        the Roman numeral â…¢ becomes III.  Diacritics, marks, and similar</span>
<span class="sd">        are removed.  See :func:`apsw.unicode.strip`.</span>

<span class="sd">    casefold</span>
<span class="sd">        Neutralizes case distinction.  See :func:`apsw.unicode.casefold`.</span>

<span class="sd">    See the :ref:`example &lt;example_fts_apsw_simplify&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;strip&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
        <span class="s2">&quot;casefold&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c1"># only 4 choices</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
        <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
        <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">casefold</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
        <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">casefold</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
    <span class="p">}[</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;casefold&quot;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
            <span class="n">new_tokens</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new</span> <span class="ow">and</span> <span class="n">new</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                    <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_tokens</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">new_tokens</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="NGramTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.NGramTokenizer">[docs]</a>
<span class="nd">@StringTokenizer</span>
<span class="k">def</span> <span class="nf">NGramTokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates ngrams from the text</span>

<span class="sd">    For example if doing 3 (trigram) then ``a big dog`` would result in</span>
<span class="sd">    ``&#39;a b&#39;, &#39; bi&#39;, &#39;big&#39;, &#39;ig &#39;, &#39;g d&#39;, &#39; do`, &#39;dog&#39;``</span>

<span class="sd">    This is useful for queries where less than an entire word has been</span>
<span class="sd">    provided such as doing completions, substring, or suffix matches.  For</span>
<span class="sd">    example a query of ``ing`` would find all occurrences even at the end</span>
<span class="sd">    of words with ngrams, but not with the :func:`UnicodeWordsTokenizer`</span>
<span class="sd">    which requires the query to provide complete words.</span>

<span class="sd">    This tokenizer works on units of user perceived characters</span>
<span class="sd">    (grapheme clusters) where more than one codepoint can make up one</span>
<span class="sd">    user perceived character.</span>

<span class="sd">    The following tokenizer arguments are accepted</span>

<span class="sd">    ngrams</span>
<span class="sd">        Numeric ranges to generate.  Smaller values allow showing</span>
<span class="sd">        results with less input but a larger index, while larger</span>
<span class="sd">        values will result in quicker searches as the input grows.</span>
<span class="sd">        Default is 3.  You can specify :func:`multiple values &lt;convert_number_ranges&gt;`.</span>

<span class="sd">    categories</span>
<span class="sd">        Which Unicode categories to include, by default all.  You could</span>
<span class="sd">        include everything except punctuation and separators with</span>
<span class="sd">        ``* !P* !Z*``.</span>

<span class="sd">    emoji</span>
<span class="sd">        ``0`` or ``1`` (default) if emoji are included, even if `categories`</span>
<span class="sd">        would exclude them.</span>

<span class="sd">    regional_indicator</span>
<span class="sd">        ``0`` or ``1`` (default) if regional indicators  are included, even if `categories`</span>
<span class="sd">        would exclude them.</span>

<span class="sd">    See :ref:`the example &lt;example_fts_autocomplete&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ngrams&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_number_ranges</span><span class="p">,</span> <span class="n">convert_default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_unicode_categories</span><span class="p">,</span> <span class="n">convert_default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;emoji&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
        <span class="s2">&quot;regional_indicator&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ngram</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">ngram</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;ngrams&quot;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ngrams must be at least 1 in </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ngrams&#39;</span><span class="p">]</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">ntokens</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">grapheme_cluster_stream</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ngrams&quot;</span><span class="p">])</span>

        <span class="c1"># if doing a query, only produce largest possible</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span><span class="p">:</span>
            <span class="n">produce</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ngrams&quot;</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">produce</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ngrams&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">grapheme_iter_with_offsets_filtered</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">categories</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">],</span>
            <span class="n">emoji</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;emoji&quot;</span><span class="p">],</span>
            <span class="n">regional_indicator</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;regional_indicator&quot;</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="n">grapheme_cluster_stream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ntoken</span> <span class="ow">in</span> <span class="n">produce</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ntoken</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span>
                        <span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="o">-</span><span class="n">ntoken</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ntoken</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="n">ntokens</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">grapheme_cluster_stream</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># if doing a query and we didn&#39;t hit the produce then find longest we can</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span> <span class="ow">and</span> <span class="n">ntokens</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">grapheme_cluster_stream</span><span class="p">:</span>
            <span class="n">largest</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ngrams&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">):</span>
                    <span class="n">largest</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">largest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">)</span> <span class="o">-</span> <span class="n">largest</span><span class="p">):</span>
                    <span class="n">ntokens</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="p">(</span>
                        <span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">largest</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">largest</span><span class="p">)),</span>
                    <span class="p">)</span>

        <span class="c1"># text didn&#39;t match any of our lengths, so return as is</span>
        <span class="k">if</span> <span class="n">ntokens</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">grapheme_cluster_stream</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span>
                <span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grapheme_cluster_stream</span><span class="p">))),</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="SynonymTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.SynonymTokenizer">[docs]</a>
<span class="k">def</span> <span class="nf">SynonymTokenizer</span><span class="p">(</span><span class="n">get</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5TokenizerFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds `colocated tokens &lt;https://www.sqlite.org/fts5.html#synonym_support&gt;`__ such as ``1st`` for ``first``.</span>

<span class="sd">    To use you need a callable that takes a str, and returns a str, a sequence of str, or None.</span>
<span class="sd">    For example :meth:`dict.get` does that.</span>

<span class="sd">    The following tokenizer arguments are accepted:</span>

<span class="sd">    reasons</span>
<span class="sd">        Which tokenize :data:`tokenize_reasons` you want the lookups to happen in</span>
<span class="sd">        as a space separated list.  Default is ``QUERY``.</span>

<span class="sd">    get</span>
<span class="sd">        Specify a :func:`get &lt;convert_string_to_python&gt;`, or use as a decorator.</span>

<span class="sd">    See :ref:`the example &lt;example_fts_synonym&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
        <span class="k">nonlocal</span> <span class="n">get</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;reasons&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;QUERY&quot;</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_tokenize_reason</span><span class="p">,</span> <span class="n">convert_default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="p">({}</span> <span class="k">if</span> <span class="n">get</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;get&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_string_to_python</span><span class="p">)}),</span>
        <span class="p">}</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;get&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">get</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">get</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A callable must be provided by decorator, or parameter&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">flags</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;reasons&quot;</span><span class="p">]:</span>
                <span class="k">yield from</span> <span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
                <span class="n">new_tokens</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                        <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                    <span class="n">alt</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">alt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                                <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">alt</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                                    <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">new_tokens</span>

        <span class="k">return</span> <span class="n">tokenize</span>

    <span class="k">return</span> <span class="n">tokenizer</span></div>



<div class="viewcode-block" id="StopWordsTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.StopWordsTokenizer">[docs]</a>
<span class="k">def</span> <span class="nf">StopWordsTokenizer</span><span class="p">(</span><span class="n">test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5TokenizerFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes tokens that are too frequent to be useful</span>

<span class="sd">    To use you need a callable that takes a str, and returns a boolean.  If</span>
<span class="sd">    ``True`` then the token is ignored.</span>

<span class="sd">    The following tokenizer arguments are accepted, or use as a decorator.</span>

<span class="sd">    test</span>
<span class="sd">        Specify a :func:`test &lt;convert_string_to_python&gt;`</span>

<span class="sd">    See :ref:`the example &lt;example_fts_stopwords&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
        <span class="k">nonlocal</span> <span class="n">test</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="p">({}</span> <span class="k">if</span> <span class="n">test</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_string_to_python</span><span class="p">)}),</span>
        <span class="p">}</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;test&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A callable must be provided by decorator, or parameter&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">flags</span> <span class="o">==</span> <span class="n">tokenize_reasons</span><span class="p">[</span><span class="s2">&quot;QUERY_PREFIX&quot;</span><span class="p">]:</span>
                <span class="k">yield from</span> <span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
                <span class="n">new_tokens</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">test</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                        <span class="c1"># stop word - do nothing</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                        <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_tokens</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">new_tokens</span>

        <span class="k">return</span> <span class="n">tokenize</span>

    <span class="k">return</span> <span class="n">tokenizer</span></div>



<div class="viewcode-block" id="TransformTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.TransformTokenizer">[docs]</a>
<span class="k">def</span> <span class="nf">TransformTokenizer</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5TokenizerFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transforms tokens to a different token, such as stemming</span>

<span class="sd">    To use you need a callable that takes a str, and returns a list of</span>
<span class="sd">    str, or just a str to use as replacements.  You can return an</span>
<span class="sd">    empty list to remove the token.</span>

<span class="sd">    The following tokenizer arguments are accepted.</span>

<span class="sd">    transform</span>
<span class="sd">        Specify a :func:`transform &lt;convert_string_to_python&gt;`, or use</span>
<span class="sd">        as a decorator</span>

<span class="sd">    See :ref:`the example &lt;example_fts_transform&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
        <span class="k">nonlocal</span> <span class="n">transform</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="p">({}</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">convertor</span><span class="o">=</span><span class="n">convert_string_to_python</span><span class="p">)}),</span>
        <span class="p">}</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;transform&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A callable must be provided by decorator, or parameter&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
                <span class="n">new_tokens</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">replacement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                            <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">replacement</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_tokens</span><span class="p">:</span>
                                <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_tokens</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">new_tokens</span>

        <span class="k">return</span> <span class="n">tokenize</span>

    <span class="k">return</span> <span class="n">tokenizer</span></div>



<span class="k">def</span> <span class="nf">extract_html_text</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">_unicode</span><span class="o">.</span><span class="n">OffsetMapper</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts text from HTML using :class:`html.parser.HTMLParser` under the hood</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">_HTMLTextExtractor</span><span class="p">(</span><span class="n">html_parser_module</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>
        <span class="c1"># Extracts text from HTML maintaining a table mapping the offsets</span>
        <span class="c1"># of the extracted text back tot he source HTML.</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># we handle charrefs because they are multiple codepoints in</span>
            <span class="c1"># the HTML but only one in text - eg &quot;&amp;amp;&quot; is &quot;&amp;&quot;</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">convert_charrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># offset mapping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">om</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">_unicode</span><span class="o">.</span><span class="n">OffsetMapper</span><span class="p">()</span>
            <span class="c1"># We don&#39;t know the end offset so have to wait till next item&#39;s</span>
            <span class="c1"># start to use as previous end.  this keep track of the item and</span>
            <span class="c1"># its offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># A stack is semantically correct but we (and browsers) don&#39;t</span>
            <span class="c1"># require correctly balanced tags, and a stack doesn&#39;t improve</span>
            <span class="c1"># correctness</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># svg content is ignored.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">svg_nesting_level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># offset in parent class sometimes goes backwards or to zero so</span>
            <span class="c1"># we have to track ourselves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># All the work is done in the constructor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">)</span>
            <span class="c1"># ensure there is a terminator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">append_result_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">separate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">om</span><span class="o">.</span><span class="n">separate</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;svg&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">svg_nesting_level</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separate</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;svg&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">svg_nesting_level</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separate</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">svg_nesting_level</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tag</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">}:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_result_text</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">handle_entityref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">svg_nesting_level</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_result_text</span><span class="p">(</span><span class="n">html_module</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&amp;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">handle_charref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_entityref</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># treat some other markup as white space</span>
        <span class="k">def</span> <span class="nf">ws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">svg_nesting_level</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separate</span><span class="p">()</span>

        <span class="n">handle_comment</span> <span class="o">=</span> <span class="n">handle_decl</span> <span class="o">=</span> <span class="n">handle_pi</span> <span class="o">=</span> <span class="n">unknown_decl</span> <span class="o">=</span> <span class="n">ws</span>

        <span class="k">def</span> <span class="nf">updatepos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="c1"># The parent version does a lot of work trying to keep</span>
            <span class="c1"># track of line numbers which is pointless for us.  We</span>
            <span class="c1"># also have to prevent going backwards.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_offset</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">j</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">_HTMLTextExtractor</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">om</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">om</span>


<div class="viewcode-block" id="HTMLTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.HTMLTokenizer">[docs]</a>
<span class="nd">@StringTokenizer</span>
<span class="k">def</span> <span class="nf">HTMLTokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts text from HTML suitable for passing on to other tokenizers</span>

<span class="sd">    This should be before the actual tokenizer in the tokenizer list.</span>
<span class="sd">    Behind the scenes it extracts text from the HTML, and manages the</span>
<span class="sd">    offset mapping between the HTML and the text passed on to other</span>
<span class="sd">    tokenizers.  It also expands entities and charrefs.  Content</span>
<span class="sd">    inside `SVG tags &lt;https://en.wikipedia.org/wiki/SVG&gt;`__ is</span>
<span class="sd">    ignored.</span>

<span class="sd">    If the html doesn&#39;t start with optional whitespace then ``&lt;`` or</span>
<span class="sd">    ``&amp;``, it is not considered HTML and will be passed on</span>
<span class="sd">    unprocessed.  This would typically be the case for queries.</span>

<span class="sd">    :mod:`html.parser` is used for the HTML processing.</span>

<span class="sd">    See :ref:`the example &lt;example_fts_html&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># we only tokenize what looks like html.  Human typed queries</span>
        <span class="c1"># are unlikely to be html.  We allow for ampersand to catch</span>
        <span class="c1"># entity searches.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*[&lt;&amp;]&quot;</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">string_tokenize</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="n">html</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">text</span><span class="p">,</span> <span class="n">om</span> <span class="o">=</span> <span class="n">extract_html_text</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">string_tokenize</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">om</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">om</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="o">*</span><span class="n">tokens</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<span class="c1"># matches all quoted strings in JSON including if there are</span>
<span class="c1"># backslashes inside</span>
<span class="n">_json_strings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;([^&quot;</span><span class="se">\\</span><span class="s1">]*(?:</span><span class="se">\\</span><span class="s1">.[^&quot;</span><span class="se">\\</span><span class="s1">]*)*)&quot;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

<span class="c1"># we want to reject keys - string followed by whitespace and colon</span>
<span class="n">_json_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*:&quot;</span><span class="p">)</span>

<span class="c1"># what backslashes map to</span>
<span class="n">_json_backslash_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\b</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\f</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">extract_json</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_keys</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">_unicode</span><span class="o">.</span><span class="n">OffsetMapper</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts text values from JSON text</span>

<span class="sd">    Returns the extracted text and an :class:`apsw._unicode.OffsetMapper` to convert locations</span>
<span class="sd">    in the extracted text back to the source text.</span>

<span class="sd">    :param include_keys: ``False`` to only extract values, ``True`` to also extract</span>
<span class="sd">       keys.</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">om</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">_unicode</span><span class="o">.</span><span class="n">OffsetMapper</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">_json_strings</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_json_key</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">continue</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># empty string test</span>
            <span class="k">continue</span>
        <span class="n">span</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">om</span><span class="o">.</span><span class="n">separate</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">span</span><span class="p">:</span>
            <span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">while</span> <span class="n">span</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">span</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">span</span><span class="p">[:</span><span class="n">loc</span><span class="p">],</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">loc</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">loc</span>
            <span class="k">if</span> <span class="n">span</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">loc</span> <span class="o">+</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
                <span class="k">if</span> <span class="mh">0xD800</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mh">0xDFFF</span><span class="p">:</span>
                    <span class="c1"># Surrogate pair.  You get this with json.dumps as</span>
                    <span class="c1"># ensure_ascii parameter defaults to True</span>
                    <span class="k">assert</span> <span class="n">span</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">:</span> <span class="n">loc</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u&quot;</span>
                    <span class="n">code2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">:</span> <span class="n">loc</span> <span class="o">+</span> <span class="mi">12</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x10000</span> <span class="o">+</span> <span class="p">(</span><span class="n">code</span> <span class="o">-</span> <span class="mh">0xD800</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="p">(</span><span class="n">code2</span> <span class="o">-</span> <span class="mh">0xDC00</span><span class="p">))</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">_json_backslash_mapping</span><span class="p">[</span><span class="n">span</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="n">length</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">om</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">length</span>
            <span class="n">span</span> <span class="o">=</span> <span class="n">span</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="n">length</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">om</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">om</span>


<div class="viewcode-block" id="JSONTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.JSONTokenizer">[docs]</a>
<span class="nd">@StringTokenizer</span>
<span class="k">def</span> <span class="nf">JSONTokenizer</span><span class="p">(</span><span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts text from JSON suitable for passing to a tokenizer</span>

<span class="sd">    The following tokenizer arguments are accepted:</span>

<span class="sd">    include_keys</span>
<span class="sd">      ``0`` (default) or ``1`` if keys are extracted in addition to</span>
<span class="sd">      values</span>

<span class="sd">    If the JSON doesn&#39;t start with optional whitespace then ``{`` or</span>
<span class="sd">    ``[``, it is not considered JSON and will be passed on</span>
<span class="sd">    unprocessed.  This would typically be the case for queries.</span>

<span class="sd">    See :ref:`the example &lt;example_fts_json&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;include_keys&quot;</span><span class="p">:</span> <span class="n">TokenizerArgument</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">convertor</span><span class="o">=</span><span class="n">convert_boolean</span><span class="p">),</span>
        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># we only tokenize what looks like json.  Human typed queries</span>
        <span class="c1"># are unlikely to be json.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*[{\[]&quot;</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">string_tokenize</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="n">json</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">text</span><span class="p">,</span> <span class="n">mapper</span> <span class="o">=</span> <span class="n">extract_json</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;include_keys&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">string_tokenize</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">mapper</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">mapper</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="o">*</span><span class="n">tokens</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="string_tokenize">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.string_tokenize">[docs]</a>
<span class="k">def</span> <span class="nf">string_tokenize</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5Tokenizer</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tokenizer caller to get string offsets back</span>

<span class="sd">    Calls the tokenizer doing the conversion of `text` to UTF8, and converting the received</span>
<span class="sd">    UTF8 offsets back to `text` offsets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">upm</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">_unicode</span><span class="o">.</span><span class="n">from_utf8_position_mapper</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bytes_start</span><span class="p">,</span> <span class="n">bytes_end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">upm</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span>
            <span class="n">upm</span><span class="p">(</span><span class="n">bytes_start</span><span class="p">),</span>
            <span class="n">upm</span><span class="p">(</span><span class="n">bytes_end</span><span class="p">),</span>
            <span class="o">*</span><span class="n">tokens</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="RegexTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.RegexTokenizer">[docs]</a>
<span class="nd">@StringTokenizer</span>
<span class="k">def</span> <span class="nf">RegexTokenizer</span><span class="p">(</span>
    <span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Finds tokens using a regular expression</span>

<span class="sd">    :param pattern: The `regular expression</span>
<span class="sd">        &lt;https://docs.python.org/3/library/re.html#regular-expression-syntax&gt;`__.</span>
<span class="sd">        For example :code:`\w+` is all alphanumeric and underscore</span>
<span class="sd">        characters.</span>
<span class="sd">    :param flags: `Regular expression flags</span>
<span class="sd">       &lt;https://docs.python.org/3/library/re.html#flags&gt;`__.  Ignored</span>
<span class="sd">       if `pattern` is an already compiled pattern</span>

<span class="sd">    See the :ref:`example &lt;example_fts_apsw_regex&gt;`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
            <span class="k">yield</span> <span class="o">*</span><span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">(),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="RegexPreTokenizer">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.RegexPreTokenizer">[docs]</a>
<span class="nd">@StringTokenizer</span>
<span class="k">def</span> <span class="nf">RegexPreTokenizer</span><span class="p">(</span>
    <span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Combines regular expressions and another tokenizer</span>

<span class="sd">    :func:`RegexTokenizer` only finds tokens matching a regular</span>
<span class="sd">    expression, and ignores all other text.  This tokenizer calls</span>
<span class="sd">    another tokenizer to handle the gaps between the patterns it</span>
<span class="sd">    finds.  This is useful to extract identifiers and other known</span>
<span class="sd">    patterns, while still doing word search on the rest of the text.</span>

<span class="sd">    :param pattern: The `regular expression</span>
<span class="sd">        &lt;https://docs.python.org/3/library/re.html#regular-expression-syntax&gt;`__.</span>
<span class="sd">        For example :code:`\w+` is all alphanumeric and underscore</span>
<span class="sd">        characters.</span>
<span class="sd">    :param flags: `Regular expression flags</span>
<span class="sd">       &lt;https://docs.python.org/3/library/re.html#flags&gt;`__.  Ignored</span>
<span class="sd">       if `pattern` is an already compiled pattern</span>

<span class="sd">    You must specify an additional tokenizer name and arguments.</span>

<span class="sd">    See the :ref:`example &lt;example_fts_apsw_regexpre&gt;`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_tokenizer_args</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_other</span><span class="p">(</span><span class="n">substring</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="ow">in</span> <span class="n">string_tokenize</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">],</span> <span class="n">substring</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">last_other</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">last_other</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">process_other</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">last_other</span> <span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()],</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="n">last_other</span><span class="p">)</span>
            <span class="k">yield</span> <span class="o">*</span><span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">(),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="n">last_other</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">last_other</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">process_other</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">last_other</span><span class="p">:],</span> <span class="n">flags</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="n">last_other</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tokenize</span></div>



<div class="viewcode-block" id="TokenizerArgument">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.TokenizerArgument">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TokenizerArgument</span><span class="p">:</span>
    <span class="s2">&quot;Used as spec values to :func:`parse_tokenizer_args` - :ref:`example &lt;example_fts_own_2&gt;`&quot;</span>

    <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="s2">&quot;Value - set to default before parsing&quot;</span>
    <span class="n">choices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="s2">&quot;Value must be one of these, after conversion&quot;</span>
    <span class="n">convertor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="s2">&quot;Function to convert string value to desired value&quot;</span>
    <span class="n">convert_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="s2">&quot;True if the default value should be run through the convertor&quot;</span></div>



<div class="viewcode-block" id="parse_tokenizer_args">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.parse_tokenizer_args">[docs]</a>
<span class="k">def</span> <span class="nf">parse_tokenizer_args</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TokenizerArgument</span> <span class="o">|</span> <span class="n">Any</span><span class="p">],</span> <span class="n">con</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses the arguments to a tokenizer based on spec returning corresponding values</span>

<span class="sd">    :param spec: A dictionary where the key is a string, and the value is either</span>
<span class="sd">       the corresponding default, or :class:`TokenizerArgument`.</span>
<span class="sd">    :param con: Used to lookup other tokenizers</span>
<span class="sd">    :param args: A list of strings as received by :class:`apsw.FTS5TokenizerFactory`</span>

<span class="sd">    For example to parse  ``[&quot;arg1&quot;, &quot;3&quot;, &quot;big&quot;, &quot;ship&quot;, &quot;unicode61&quot;, &quot;yes&quot;, &quot;two&quot;]``</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        # spec on input</span>
<span class="sd">        {</span>
<span class="sd">            # Converts to integer</span>
<span class="sd">            &quot;arg1&quot;: TokenizerArgument(convertor=int, default=7),</span>
<span class="sd">            # Limit allowed values</span>
<span class="sd">            &quot;big&quot;: TokenizerArgument(choices=(&quot;ship&quot;, &quot;plane&quot;)),</span>
<span class="sd">            # Accepts any string, with a default</span>
<span class="sd">            &quot;small&quot;: &quot;hello&quot;,</span>
<span class="sd">            # gathers up remaining arguments, if you intend</span>
<span class="sd">            # to process the results of another tokenizer</span>
<span class="sd">            &quot;+&quot;: None</span>
<span class="sd">        }</span>

<span class="sd">        # options on output</span>
<span class="sd">        {</span>
<span class="sd">            &quot;arg1&quot;: 3,</span>
<span class="sd">            &quot;big&quot;: &quot;ship&quot;,</span>
<span class="sd">            &quot;small&quot;: &quot;hello&quot;,</span>
<span class="sd">            &quot;+&quot;: db.Tokenizer(&quot;unicode61&quot;, [&quot;yes&quot;, &quot;two&quot;])</span>
<span class="sd">        }</span>

<span class="sd">        # Using &quot;+&quot; in your ``tokenize`` functions</span>
<span class="sd">        def tokenize(utf8, flags, locale):</span>
<span class="sd">            tok = options[&quot;+&quot;]</span>
<span class="sd">            for start, end, *tokens in tok(utf8, flags, locale):</span>
<span class="sd">                # do something</span>
<span class="sd">                yield start, end, *tokens</span>

<span class="sd">    .. seealso:: Some useful convertors</span>

<span class="sd">        * :func:`convert_unicode_categories`</span>
<span class="sd">        * :func:`convert_tokenize_reason`</span>
<span class="sd">        * :func:`convert_string_to_python`</span>
<span class="sd">        * :func:`convert_number_ranges`</span>

<span class="sd">    See :ref:`the example &lt;example_fts_own_2&gt;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ac</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:]</span>
    <span class="k">while</span> <span class="n">ac</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected parameter name </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">fts5_tokenizer</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ac</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a value for parameter </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">TokenizerArgument</span><span class="p">):</span>
            <span class="n">ta</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ta</span><span class="o">.</span><span class="n">convertor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">convertor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;add_note&quot;</span><span class="p">):</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add_note</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing parameter </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2"> with value &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="n">ta</span><span class="o">.</span><span class="n">choices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ta</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2"> value </span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2"> was not allowed choice </span><span class="si">{</span><span class="w"> </span><span class="n">ta</span><span class="o">.</span><span class="n">choices</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">TokenizerArgument</span><span class="p">):</span>
                <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">default</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">convert_default</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">convertor</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">spec</span> <span class="ow">and</span> <span class="s2">&quot;+&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected additional tokenizer and arguments&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">options</span></div>



<div class="viewcode-block" id="MatchInfo">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.MatchInfo">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MatchInfo</span><span class="p">:</span>
    <span class="s2">&quot;Information about a matched row, returned by :meth:`Table.search`&quot;</span>

    <span class="n">query_info</span><span class="p">:</span> <span class="n">QueryInfo</span>
    <span class="s2">&quot;Overall query information&quot;</span>
    <span class="n">rowid</span><span class="p">:</span> <span class="nb">int</span>
    <span class="s2">&quot;Rowid&quot;</span>
    <span class="n">column_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="s2">&quot;Size of each column in tokens&quot;</span>
    <span class="n">phrase_columns</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
    <span class="s2">&quot;For each phrase a tuple of which columns it occurs in&quot;</span></div>



<div class="viewcode-block" id="QueryInfo">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.QueryInfo">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">QueryInfo</span><span class="p">:</span>
    <span class="s2">&quot;Information relevant to the query as a whole, returned by :meth:`Table.search`&quot;</span>

    <span class="n">phrases</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:attr:`Phrases from the query &lt;apsw.FTS5ExtensionApi.phrases&gt;`</span>

<span class="sd">    ``a OR b NOT c AND d`` would result in ``a, b, c, d`` as</span>
<span class="sd">    4 separate phrases.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<span class="n">map_tokenizers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">HTMLTokenizer</span><span class="p">,</span>
    <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">JSONTokenizer</span><span class="p">,</span>
    <span class="s2">&quot;ngram&quot;</span><span class="p">:</span> <span class="n">NGramTokenizer</span><span class="p">,</span>
    <span class="s2">&quot;querytokens&quot;</span><span class="p">:</span> <span class="n">QueryTokensTokenizer</span><span class="p">,</span>
    <span class="s2">&quot;simplify&quot;</span><span class="p">:</span> <span class="n">SimplifyTokenizer</span><span class="p">,</span>
    <span class="s2">&quot;unicodewords&quot;</span><span class="p">:</span> <span class="n">UnicodeWordsTokenizer</span><span class="p">,</span>
<span class="p">}</span>
<span class="s2">&quot;APSW provided tokenizers for use with :func:`register_tokenizers`&quot;</span>

<span class="n">map_functions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;subsequence&quot;</span><span class="p">:</span> <span class="s2">&quot;apsw.fts5aux.subsequence&quot;</span><span class="p">,</span>
    <span class="s2">&quot;position_rank&quot;</span><span class="p">:</span> <span class="s2">&quot;apsw.fts5aux.position_rank&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="s2">&quot;APSW provided auxiliary functions for use with :func:`register_functions`&quot;</span>


<div class="viewcode-block" id="register_tokenizers">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.register_tokenizers">[docs]</a>
<span class="k">def</span> <span class="nf">register_tokenizers</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="nb">map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers tokenizers named in map with the connection, if not already registered</span>

<span class="sd">    The map contains the tokenizer name, and either the callable or a</span>
<span class="sd">    string which will be automatically :func:`imported</span>
<span class="sd">    &lt;convert_string_to_python&gt;`.</span>

<span class="sd">    See :data:`map_tokenizers`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tok</span> <span class="ow">in</span> <span class="nb">map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">fts5_tokenizer_available</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">db</span><span class="o">.</span><span class="n">register_fts5_tokenizer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">convert_string_to_python</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">tok</span><span class="p">)</span></div>



<div class="viewcode-block" id="register_functions">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.register_functions">[docs]</a>
<span class="k">def</span> <span class="nf">register_functions</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="nb">map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers auxiliary functions named in map with the connection, if not already registered</span>

<span class="sd">    The map contains the function name, and either the callable or a</span>
<span class="sd">    string which will be automatically :func:`imported</span>
<span class="sd">    &lt;convert_string_to_python&gt;`.</span>

<span class="sd">    See :data:`map_functions`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">registered_functions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select name from pragma_function_list&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">registered_functions</span><span class="p">:</span>
            <span class="c1"># function names are case insensitive so check again</span>
            <span class="k">for</span> <span class="n">reg_name</span> <span class="ow">in</span> <span class="n">registered_functions</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">reg_name</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">register_fts5_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">convert_string_to_python</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">func</span><span class="p">)</span></div>



<div class="viewcode-block" id="Table">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table">[docs]</a>
<span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helpful wrapper around a FTS5 table</span>

<span class="sd">    The table must already exist.  You can use the class method</span>
<span class="sd">    :meth:`create` to create a new FTS5 table.</span>

<span class="sd">    :param db: Connection to use</span>
<span class="sd">    :param name: Table name</span>
<span class="sd">    :param schema: Which attached database to use</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">_cache_class</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Data structure representing token cache</span>

<span class="sd">        :meta private:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cookie</span><span class="p">:</span> <span class="nb">int</span>
        <span class="s2">&quot;change cookie at time this information was cached&quot;</span>
        <span class="n">tokens</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="s2">&quot;the tokens with how many rows they appear in&quot;</span>
        <span class="n">row_count</span><span class="p">:</span> <span class="nb">int</span>
        <span class="s2">&quot;number of rows in the table&quot;</span>
        <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span>
        <span class="s2">&quot;Total number of tokens across all indexed columns in all rows&quot;</span>
        <span class="n">tokens_per_column</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="s2">&quot;Count of tokens in each column, across all rows.  Unindexed columns have a value of zero&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qname</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">Table</span><span class="o">.</span><span class="n">_cache_class</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Do some sanity checking</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">columns</span>

        <span class="c1"># our helper functions</span>
        <span class="n">register_functions</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="p">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">func</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_apsw_get_statistical_info</span><span class="p">,</span> <span class="n">_apsw_get_match_info</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="n">register_tokenizers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">map_tokenizers</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;FTS5Table </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2"> at 0x</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="w"> </span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_change_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An int that changes if the content of the table has changed.</span>

<span class="sd">        This is useful to validate cached information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># See https://sqlite.org/forum/forumpost/2a726411b6974502</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select block from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_data&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> where id=10&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
        <span class="p">)</span>

    <span class="n">change_cookie</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_change_cookie</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="s2">&quot;All columns of this table, including unindexed ones.  Unindexed columns are ignored in queries.&quot;</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pragma </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.table_info(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">))</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">columns_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="s2">&quot;All columns of this table, excluding unindexed ones&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pragma </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.table_info(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unindexed</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Table.column_named">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.column_named">[docs]</a>
    <span class="k">def</span> <span class="nf">column_named</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the column matching `name` or `None` if it doesn&#39;t exist</span>

<span class="sd">        SQLite is ascii case-insensitive, so this tells you the declared name,</span>
<span class="sd">        or None if it doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">column</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FTS5TableStructure</span><span class="p">:</span>
        <span class="s2">&quot;Structure of the table from the declared SQL&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">sql</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">sql</span><span class="p">,)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select sql from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.sqlite_schema where type=&#39;table&#39; and lower(tbl_name) = lower(?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">_fts5_vtable_parse</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">quoted_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Provides the full table name for composing your own queries</span>

<span class="sd">        It includes the attached database name and quotes special</span>
<span class="sd">        characters like spaces.</span>

<span class="sd">        You can&#39;t use bindings for table names in queries, so use this</span>
<span class="sd">        when constructing a query string::</span>

<span class="sd">           my_table = apsw.fts5.Table(con, &#39;my_table&#39;)</span>

<span class="sd">           sql = f&quot;&quot;&quot;SELECT ... FROM { my_table.quoted_table_name }</span>
<span class="sd">                        WHERE ....&quot;&quot;&quot;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="Table.search">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.search">[docs]</a>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">MatchInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterates query matches, best matches first</span>

<span class="sd">        This avoids the need to write SQL.  See :ref:`the example</span>
<span class="sd">        &lt;example_fts_search&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">locale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select _apsw_get_match_info(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s2">(fts5_locale(?,?)) order by rank&quot;</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">locale</span><span class="p">,</span>
                <span class="n">query</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select _apsw_get_match_info(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s2">(?) order by rank&quot;</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span><span class="p">,)</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_internal</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_search_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bindings</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValues</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">MatchInfo</span><span class="p">]:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">_search_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">qi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">qi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">qi</span> <span class="o">=</span> <span class="n">_search_context</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">MatchInfo</span><span class="p">(</span><span class="n">query_info</span><span class="o">=</span><span class="n">qi</span><span class="p">,</span> <span class="o">**</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_search_context</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<div class="viewcode-block" id="Table.key_tokens">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.key_tokens">[docs]</a>
    <span class="k">def</span> <span class="nf">key_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rowid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds tokens that are dense in this row, but rare in other rows</span>

<span class="sd">        This is purely statistical and has no understanding of the</span>
<span class="sd">        tokens.  Tokens that occur only in this row are ignored.</span>

<span class="sd">        :param rowid: Which row to examine</span>
<span class="sd">        :param limit: Maximum number to return</span>
<span class="sd">        :param columns: If provided then only look at specified</span>
<span class="sd">            column(s), else all indexed columns.</span>
<span class="sd">        :returns: A sequence of tuples where each is a tuple of token</span>
<span class="sd">           and float score with bigger meaning more unique, sorted</span>
<span class="sd">           highest score first.</span>

<span class="sd">        See the :ref:`example &lt;example_fts_more&gt;`.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`text_for_token` to get original document text</span>
<span class="sd">            corresponding to a token</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># how many times each token occurs in this row</span>
        <span class="n">token_counter</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_indexed</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_by_id</span><span class="p">(</span><span class="n">rowid</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                <span class="c1"># could be None or empty</span>
                <span class="k">continue</span>
            <span class="n">column_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_named</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
            <span class="n">locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select fts5_get_locale(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">column_number</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s2"> where rowid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rowid</span><span class="p">,))</span><span class="o">.</span><span class="n">get</span>
            <span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">include_colocated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_offsets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">):</span>
                <span class="n">token_counter</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">row_token_count</span> <span class="o">=</span> <span class="n">token_counter</span><span class="o">.</span><span class="n">total</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Py &lt;= 3.9 doesn&#39;t have total so do it the hard way</span>
            <span class="n">row_token_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">token_counter</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># calculate per token score</span>
        <span class="n">scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">row_token_count</span><span class="p">)</span> <span class="k">if</span> <span class="n">row_token_count</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">all_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span>

        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">occurrences</span> <span class="ow">in</span> <span class="n">token_counter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">num_docs</span> <span class="o">=</span> <span class="n">all_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_docs</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">occurrences</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># This isn&#39;t particularly sophisticated, but is good enough</span>
            <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">occurrences</span> <span class="o">/</span> <span class="n">row_token_count</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_docs</span>

            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">score</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">limit</span><span class="p">]</span></div>


<div class="viewcode-block" id="Table.more_like">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.more_like">[docs]</a>
    <span class="k">def</span> <span class="nf">more_like</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">token_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">MatchInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Like :meth:`search` providing results similar to the provided ids.</span>

<span class="sd">        This is useful for providing infinite scrolling.  Do a search</span>
<span class="sd">        remembering the rowids.  When you get to the end, call this</span>
<span class="sd">        method with those rowids.</span>

<span class="sd">        :meth:`key_tokens` is used to get key tokens from rows which is</span>
<span class="sd">        purely statistical and has no understanding of the text.</span>

<span class="sd">        :param ids: rowids to consider</span>
<span class="sd">        :param columns: If provided then only look at specified</span>
<span class="sd">            column(s), else all indexed columns.</span>
<span class="sd">        :param token_limit: How many tokens are extracted from each row.</span>
<span class="sd">            Bigger values result in a broader search, while smaller</span>
<span class="sd">            values narrow it.</span>

<span class="sd">        See the :ref:`example &lt;example_fts_more&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_tokens</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">ids</span><span class="p">}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">ids</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">rowid</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_tokens</span><span class="p">(</span><span class="n">rowid</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">token_limit</span><span class="p">):</span>
                <span class="n">all_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="n">sql_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;select _apsw_get_match_info(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s2">(?) where rowid NOT IN (&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
            <span class="o">+</span> <span class="s2">&quot;) order by rank&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_query_tokens</span><span class="p">:</span>
            <span class="n">phrases</span> <span class="o">=</span> <span class="p">[</span><span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">QueryTokens</span><span class="p">([</span><span class="n">token</span><span class="p">])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">all_tokens</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phrases</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_for_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">all_tokens</span><span class="p">]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;@&quot;</span><span class="p">:</span> <span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="s2">&quot;queries&quot;</span><span class="p">:</span> <span class="n">phrases</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;@&quot;</span><span class="p">:</span> <span class="s2">&quot;COLUMNFILTER&quot;</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>

        <span class="n">fts_parsed</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">fts_query</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">to_query_string</span><span class="p">(</span><span class="n">fts_parsed</span><span class="p">)</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_internal</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="p">(</span><span class="n">fts_query</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span></div>


<div class="viewcode-block" id="Table.delete">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.delete">[docs]</a>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes the identified row</span>

<span class="sd">        If you are using an external content table then the delete is directed</span>
<span class="sd">        to that table.</span>

<span class="sd">        :returns: True if a row was deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">target_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;delete from </span><span class="si">{</span><span class="w"> </span><span class="n">target_table</span><span class="si">}</span><span class="s2"> where &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">content_rowid</span> <span class="ow">or</span> <span class="s2">&quot;rowid&quot;</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;=?&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">rowid</span><span class="p">,))</span>
            <span class="k">return</span> <span class="n">c</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()</span></div>


<div class="viewcode-block" id="Table.upsert">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.upsert">[docs]</a>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert or update with columns by positional and keyword arguments</span>

<span class="sd">        You can mix and match positional and keyword arguments::</span>

<span class="sd">           table.upsert(&quot;hello&quot;)</span>
<span class="sd">           table.upsert(&quot;hello&quot;, header=&quot;world&quot;)</span>
<span class="sd">           table.upsert(header=&quot;world&quot;)</span>

<span class="sd">        If you specify a ``rowid`` keyword argument that is used as</span>
<span class="sd">        the rowid for the insert.  If the corresponding row already</span>
<span class="sd">        exists then the row is modified with the provided values.</span>
<span class="sd">        rowids are always integers.</span>

<span class="sd">        The rowid of the inserted/modified row is returned.</span>

<span class="sd">        If you are using an [external</span>
<span class="sd">        content](https://www.sqlite.org/fts5.html#external_content_tables)</span>
<span class="sd">        table:</span>

<span class="sd">        * The insert will be directed to the external content table</span>
<span class="sd">        * ``rowid`` will map to the ``content_rowid`` option if used</span>
<span class="sd">        * The column names and positions of the FTS5 table, not the external content table is used</span>
<span class="sd">        * The FTS5 table is not updated - you should use triggers on</span>
<span class="sd">          the external content table to do that.  See the</span>
<span class="sd">          ``generate_triggers`` option on :meth:`create`.</span>

<span class="sd">        See :ref:`the example &lt;example_fts_update&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsert_sql</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">get</span></div>


    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">_upsert_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_args</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Figure out SQL and column mapping to do the actual upsert&quot;</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">target_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span>

        <span class="n">num_kwargs</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_args</span> <span class="o">+</span> <span class="n">num_kwargs</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">total_args</span> <span class="o">=</span> <span class="n">num_args</span> <span class="o">+</span> <span class="n">num_kwargs</span>
            <span class="c1"># rowid doesn&#39;t count</span>
            <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="s2">&quot;rowid&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
                <span class="n">total_args</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">total_args</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many values supplied (</span><span class="si">{</span><span class="n">total_args</span><span class="si">}</span><span class="s2">) - max </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_args</span> <span class="o">+</span> <span class="n">num_kwargs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must supply some values&quot;</span><span class="p">)</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insert or replace into </span><span class="si">{</span><span class="w"> </span><span class="n">target_table</span><span class="w"> </span><span class="si">}</span><span class="s2"> (&quot;</span>

        <span class="n">query_column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">[:</span><span class="n">num_args</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">[:</span><span class="n">num_args</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39; provided multiple times&quot;</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

                <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="s2">&quot;rowid&quot;</span><span class="p">):</span>
                    <span class="n">query_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">content_rowid</span> <span class="ow">or</span> <span class="s2">&quot;rowid&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># find matching column</span>
                <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">candidate</span><span class="p">):</span>
                        <span class="n">query_column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&#39; is not a column name - </span><span class="si">{</span><span class="n">columns</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_name</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">query_column_names</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;) values (&quot;</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_args</span> <span class="o">+</span> <span class="n">num_kwargs</span><span class="p">))</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;); select last_insert_rowid()&quot;</span>
        <span class="k">return</span> <span class="n">sql</span>

    <span class="c1"># some method helpers pattern, not including all of them yet</span>

<div class="viewcode-block" id="Table.command_delete">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.command_delete">[docs]</a>
    <span class="k">def</span> <span class="nf">command_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="n">column_values</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does `delete &lt;https://www.sqlite.org/fts5.html#the_delete_command&gt;`__</span>

<span class="sd">        See :meth:`delete` for regular row deletion.</span>

<span class="sd">        If you are using an external content table, it is better to use triggers on</span>
<span class="sd">        that table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You need to provide values for every column (</span><span class="si">{</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">) - got </span><span class="si">{</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">column_values</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;(&#39;delete&#39;,?,&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column_values</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">, rowid,&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_name</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="si">}</span><span class="s2"> values </span><span class="si">{</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rowid</span><span class="p">,</span> <span class="o">*</span><span class="n">column_values</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Table.command_delete_all">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.command_delete_all">[docs]</a>
    <span class="k">def</span> <span class="nf">command_delete_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does `delete all &lt;https://www.sqlite.org/fts5.html#the_delete_all_command&gt;`__</span>

<span class="sd">        If you are using an external content table, it is better to use triggers on</span>
<span class="sd">        that table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">) VALUES(&#39;delete-all&#39;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table.command_integrity_check">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.command_integrity_check">[docs]</a>
    <span class="k">def</span> <span class="nf">command_integrity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_content</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does `integrity check &lt;https://www.sqlite.org/fts5.html#the_integrity_check_command&gt;`__</span>

<span class="sd">        If `external_content` is True, then the FTS index is compared to the external content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">, rank) VALUES(&#39;integrity-check&#39;, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">external_content</span><span class="p">),),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Table.command_merge">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.command_merge">[docs]</a>
    <span class="k">def</span> <span class="nf">command_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does `merge &lt;https://www.sqlite.org/fts5.html#the_merge_command&gt;`__</span>

<span class="sd">        See the documentation for what positive and negative values of `n` mean.</span>

<span class="sd">        :returns:  The difference between `sqlite3_total_changes() &lt;https://sqlite.org/c3ref/total_changes.html&gt;`__</span>
<span class="sd">                   before and after running the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">, rank) VALUES(&#39;merge&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()</span> <span class="o">-</span> <span class="n">before</span></div>


<div class="viewcode-block" id="Table.command_optimize">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.command_optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">command_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Does `optimize &lt;https://www.sqlite.org/fts5.html#the_optimize_command&gt;`__&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">) VALUES(&#39;optimize&#39;)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table.command_rebuild">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.command_rebuild">[docs]</a>
    <span class="k">def</span> <span class="nf">command_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Does `rebuild &lt;https://www.sqlite.org/fts5.html#the_rebuild_command&gt;`__&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">) VALUES(&#39;rebuild&#39;)&quot;</span><span class="p">)</span></div>


    <span class="c1"># These are the defaults.  The _config table is not updated unless they are changed</span>
    <span class="c1">#</span>
    <span class="c1"># define FTS5_DEFAULT_PAGE_SIZE   4050</span>
    <span class="c1"># define FTS5_DEFAULT_AUTOMERGE      4</span>
    <span class="c1"># define FTS5_DEFAULT_USERMERGE      4</span>
    <span class="c1"># define FTS5_DEFAULT_CRISISMERGE   16</span>
    <span class="c1"># define FTS5_DEFAULT_HASHSIZE    (1024*1024)</span>
    <span class="c1"># define FTS5_DEFAULT_DELETE_AUTOMERGE 10</span>
    <span class="c1"># define FTS5_DEFAULT_RANK     &quot;bm25&quot;</span>

<div class="viewcode-block" id="Table.config_automerge">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_automerge">[docs]</a>
    <span class="k">def</span> <span class="nf">config_automerge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `automerge &lt;https://www.sqlite.org/fts5.html#the_automerge_configuration_option&gt;`__&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;automerge&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Table.config_crisismerge">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_crisismerge">[docs]</a>
    <span class="k">def</span> <span class="nf">config_crisismerge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `crisismerge &lt;https://www.sqlite.org/fts5.html#the_crisismerge_configuration_option&gt;`__&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;crisismerge&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Table.config_deletemerge">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_deletemerge">[docs]</a>
    <span class="k">def</span> <span class="nf">config_deletemerge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `deletemerge &lt;https://www.sqlite.org/fts5.html#the_deletemerge_configuration_option&gt;`__&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;deletemerge&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Table.config_pgsz">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_pgsz">[docs]</a>
    <span class="k">def</span> <span class="nf">config_pgsz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `page size &lt;https://www.sqlite.org/fts5.html#the_pgsz_configuration_option&gt;`__&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;pgsz&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4050</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Table.config_rank">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_rank">[docs]</a>
    <span class="k">def</span> <span class="nf">config_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `rank &lt;https://www.sqlite.org/fts5.html#the_rank_configuration_option&gt;`__</span>

<span class="sd">        When setting rank it must consist of a function name, open</span>
<span class="sd">        parentheses, zero or more SQLite value literals that will be</span>
<span class="sd">        arguments to the function, and a close parenthesis,  For example</span>
<span class="sd">        ``my_func(3, x&#39;aabb&#39;, &#39;hello&#39;)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;bm25()&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Table.config_secure_delete">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_secure_delete">[docs]</a>
    <span class="k">def</span> <span class="nf">config_secure_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `secure-delete &lt;https://www.sqlite.org/fts5.html#the_secure_delete_configuration_option&gt;`__&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;secure-delete&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>  <span class="c1"># type: ignore</span></div>


<div class="viewcode-block" id="Table.config_usermerge">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config_usermerge">[docs]</a>
    <span class="k">def</span> <span class="nf">config_usermerge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and returns `usermerge &lt;https://www.sqlite.org/fts5.html#the_usermerge_configuration_option&gt;`__&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_internal</span><span class="p">(</span><span class="s2">&quot;usermerge&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># type: ignore</span></div>


    <span class="k">def</span> <span class="nf">_config_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">:</span>
        <span class="s2">&quot;Internal config implementation&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">, rank) VALUES(&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span><span class="p">,)</span>
            <span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default</span>

<div class="viewcode-block" id="Table.config">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.config">[docs]</a>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;x-apsw-&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optionally sets, and gets a `config value &lt;https://www.sqlite.org/fts5.html#configuration_options_config_table_&gt;`__</span>

<span class="sd">        If the value is not None, then it is changed.  It is not</span>
<span class="sd">        recommended to change SQLite&#39;s own values.</span>

<span class="sd">        The `prefix` is to ensure your own config names don&#39;t clash</span>
<span class="sd">        with those used by SQLite.  For example you could remember the</span>
<span class="sd">        Unicode version used by your tokenizer, and rebuild if the</span>
<span class="sd">        version is updated.</span>

<span class="sd">        The advantage of using this is that the names/values will</span>
<span class="sd">        survive the FTS5 table being renamed, backed up, restored etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;INSERT OR REPLACE into </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_config&#39;</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">(k,v) values(?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SELECT v from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_config&#39;</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2"> where k=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span></div>


    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5Tokenizer</span><span class="p">:</span>
        <span class="s2">&quot;Tokenizer instance as used by this table&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">fts5_tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">tokenize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">tokenize</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

<div class="viewcode-block" id="Table.tokenize">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.tokenize">[docs]</a>
    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">reason</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_DOCUMENT</span><span class="p">,</span>
        <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_offsets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_colocated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="s2">&quot;Tokenize the supplied utf8&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">utf8</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="n">include_offsets</span><span class="o">=</span><span class="n">include_offsets</span><span class="p">,</span> <span class="n">include_colocated</span><span class="o">=</span><span class="n">include_colocated</span>
        <span class="p">)</span></div>


    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">supports_query_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s2">&quot;`True` if you can use :class:`apsw.fts5query.QueryTokens` with this table&quot;</span>
        <span class="c1"># we run a tokenization with crafted tokens to detect if</span>
        <span class="c1"># QueryTokensTokenizer is present.  hence white space,</span>
        <span class="c1"># accents, punctuation, mixed case etc</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;  .= -&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;HÃ‰ Ã©&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tokens</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span>
            <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">QueryTokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
            <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_offsets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_colocated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cache_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Ensure cached information is up to date&quot;</span>
        <span class="k">while</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">cookie</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_cookie</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tokens</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">with</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">():</span>
                <span class="c1"># check if another thread did the work</span>
                <span class="n">cookie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_cookie</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">cookie</span> <span class="o">==</span> <span class="n">cookie</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tokens</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># we require tokens</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">tokens</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fts5vocab_name</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>
                    <span class="n">all_tokens</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select term, doc from </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_tokens</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;row_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;token_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tokens_per_column&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span>

                <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;select _apsw_get_statistical_info(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="w"> </span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="w"> </span><span class="si">}</span><span class="s2"> limit 1&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span>
                <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">update</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">_cache_class</span><span class="p">(</span><span class="n">cookie</span><span class="o">=</span><span class="n">cookie</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">all_tokens</span><span class="p">,</span> <span class="o">**</span><span class="n">vals</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="k">def</span> <span class="nf">_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All the tokens as a dict with token as key, and the value being how many rows they are in</span>

<span class="sd">        This can take some time on a large corpus - eg 2 seconds on a</span>
<span class="sd">        gigabyte dataset with half a million documents and 650,000</span>
<span class="sd">        tokens.  It is cached until the next content change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_check</span><span class="p">(</span><span class="n">tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">_row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;Number of rows in the table&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_check</span><span class="p">()</span><span class="o">.</span><span class="n">row_count</span>

    <span class="k">def</span> <span class="nf">_token_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s2">&quot;Total number of tokens across all indexed columns in all rows&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_check</span><span class="p">()</span><span class="o">.</span><span class="n">token_count</span>

    <span class="k">def</span> <span class="nf">_tokens_per_column</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="s2">&quot;Count of tokens in each column, across all rows.  Unindexed columns have a value of zero&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_check</span><span class="p">()</span><span class="o">.</span><span class="n">tokens_per_column</span>

    <span class="c1"># turn the above into properties</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_tokens</span><span class="p">)</span>
    <span class="n">row_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_row_count</span><span class="p">)</span>
    <span class="n">token_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_token_count</span><span class="p">)</span>
    <span class="n">tokens_per_column</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_tokens_per_column</span><span class="p">)</span>

<div class="viewcode-block" id="Table.is_token">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.is_token">[docs]</a>
    <span class="k">def</span> <span class="nf">is_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns ``True`` if it is a known token&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span></div>


<div class="viewcode-block" id="Table.query_suggest">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.query_suggest">[docs]</a>
    <span class="k">def</span> <span class="nf">query_suggest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">tft_docs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Suggests alternate query</span>

<span class="sd">        This is useful if a query returns no or few matches.  It is</span>
<span class="sd">        purely a statistical operation based on the tokens in the</span>
<span class="sd">        query and index. There is no guarantee that there will be more</span>
<span class="sd">        (or any) matches.  The query structure (AND, OR, column filters etc)</span>
<span class="sd">        is maintained.</span>

<span class="sd">        Transformations include:</span>

<span class="sd">        * Ensuring column names in column filters are of the closest</span>
<span class="sd">          indexed column name</span>
<span class="sd">        * Combining such as ``some thing`` to ``something``</span>
<span class="sd">        * Splitting such as ``noone`` to ``no one``</span>
<span class="sd">        * Replacing unknown/rare words with more popular ones</span>

<span class="sd">        The query is parsed, tokenized, replacement tokens</span>
<span class="sd">        established, and original text via :meth:`text_for_token` used</span>
<span class="sd">        to reconstitute the query.</span>

<span class="sd">        :param query: A valid query string</span>
<span class="sd">        :param threshold: Fraction of rows between ``0.0`` and</span>
<span class="sd">          ``1.00`` to be rare - eg ``0.01`` means a token occurring in</span>
<span class="sd">          less than 1% of rows is considered for replacement.  Larger</span>
<span class="sd">          fractions increase the likelihood of replacements, while</span>
<span class="sd">          smaller reduces it.  A value of ``0`` will only replace</span>
<span class="sd">          tokens that are not in the index at all - essentially</span>
<span class="sd">          spelling correction only</span>
<span class="sd">        :param tft_docs: Passed to :meth:`text_for_token` as the</span>
<span class="sd">          ``doc_limit`` parameter.  Larger values produce more</span>
<span class="sd">          representative text, but also increase processing time.</span>
<span class="sd">        :param locale: Locale used to tokenize the query.</span>
<span class="sd">        :returns: ``None`` if no suitable changes were found, or a replacement</span>
<span class="sd">          query string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the parsed structure is modified in place</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">parse_query_string</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># save these so we don&#39;t constantly check cache or have them</span>
        <span class="c1"># change underneath us</span>
        <span class="n">all_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_count</span>

        <span class="c1"># set if any modifications made</span>
        <span class="n">updated_query</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># token count less than this need to be changed</span>
        <span class="n">threshold_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">threshold</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_count</span><span class="p">)</span>

        <span class="c1"># which QUERY nodes have already been processed because</span>
        <span class="c1"># we process PHRASE children of AND.  The id of objects have</span>
        <span class="c1"># to be added because we mutate modes</span>
        <span class="n">done</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">parsed</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">COLUMNFILTER</span><span class="p">):</span>
                <span class="n">new_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">table_columns_upper</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indexed_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unindexed</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">table_column</span><span class="p">)</span> <span class="k">for</span> <span class="n">table_column</span> <span class="ow">in</span> <span class="n">indexed_columns</span><span class="p">):</span>
                        <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># we need to do the get close matches in a case insensitive way</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_columns_upper</span><span class="p">:</span>
                        <span class="n">table_columns_upper</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select upper(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,))</span><span class="o">.</span><span class="n">get</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">indexed_columns</span>
                        <span class="p">]</span>
                    <span class="c1"># re-use closest_tokens even though there aren&#39;t tokens</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closest_tokens</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select upper(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span><span class="p">,))</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
                        <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">min_docs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">all_tokens</span><span class="o">=</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table_columns_upper</span><span class="p">),</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># get the original casing back</span>
                    <span class="n">new_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indexed_columns</span><span class="p">[</span><span class="n">table_columns_upper</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">replacement</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">new_columns</span> <span class="o">!=</span> <span class="n">node</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">updated_query</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_columns</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">PHRASE</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">AND</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="k">def</span> <span class="nf">is_simple_phrase</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="c1"># we only process these and ignore the more</span>
                <span class="c1"># complicated ones</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">PHRASE</span><span class="p">)</span>
                    <span class="c1"># no query modifiers</span>
                    <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">plus</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">prefix</span>
                    <span class="c1"># this means we can space join the adjacent phrases</span>
                    <span class="ow">and</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">phrase</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="o">.</span><span class="n">phrase</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">AND</span><span class="p">):</span>
                <span class="c1"># we want to work on adjacent PHRASE as though they</span>
                <span class="c1"># were one phrase so adjacent tokens can be</span>
                <span class="c1"># concatenated.</span>

                <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">queries</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">is_simple_phrase</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">queries</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_simple_phrase</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># i now points to next that can&#39;t be adjacent</span>
                        <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">PHRASE</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">phrase</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="p">))),</span>
                                <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we don&#39;t touch these</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">plus</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>

            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

            <span class="c1"># we have to work backwards so the query_range offsets</span>
            <span class="c1"># remain valid</span>
            <span class="k">for</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">query_range</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
                <span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="n">tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5_TOKENIZE_QUERY</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>

                <span class="c1"># track what happens to each token. False=unchanged,</span>
                <span class="c1"># True=deleted, str=new token.  This lets us know if</span>
                <span class="c1"># the original text can be recovered from the query or</span>
                <span class="c1"># if text_for_token has to be used.</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized</span><span class="p">)</span>

                <span class="c1"># track our progress</span>
                <span class="n">token_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                <span class="k">while</span> <span class="n">token_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized</span><span class="p">):</span>
                    <span class="n">token_num</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Deleted/replaced?</span>
                    <span class="k">if</span> <span class="n">modified</span><span class="p">[</span><span class="n">token_num</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># include colocated</span>
                    <span class="n">tokens</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenized</span><span class="p">[</span><span class="n">token_num</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>

                    <span class="n">votes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span>
                        <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;coalesce&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;replace&quot;</span><span class="p">],</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">rows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">)</span>

                    <span class="c1"># can we coalesce with next token?</span>
                    <span class="k">if</span> <span class="n">rows</span> <span class="o">&lt;=</span> <span class="n">threshold_rows</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">token_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized</span><span class="p">):</span>
                        <span class="n">next_tokens</span> <span class="o">=</span> <span class="n">tokenized</span><span class="p">[</span><span class="n">token_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>
                        <span class="c1"># only try if there is one next token (no colocated)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">combined</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">next_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># is combined more popular than separate tokens?</span>
                            <span class="k">if</span> <span class="n">all_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span>
                                <span class="n">all_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">all_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">next_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="p">):</span>
                                <span class="n">votes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">all_tokens</span><span class="p">[</span><span class="n">combined</span><span class="p">],</span> <span class="s2">&quot;coalesce&quot;</span><span class="p">,</span> <span class="n">combined</span><span class="p">))</span>

                    <span class="c1"># split apart?</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rows</span> <span class="o">&lt;=</span> <span class="n">threshold_rows</span><span class="p">:</span>
                        <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># there could be multiple candidates</span>
                        <span class="c1"># eg abc could become ab c, or a bc</span>
                        <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="c1"># used a lot</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span>
                        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">all_tokens</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">test</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]</span> <span class="ow">in</span> <span class="n">all_tokens</span><span class="p">:</span>
                                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prefix</span><span class="p">,</span> <span class="n">token</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]))</span>

                        <span class="k">if</span> <span class="n">candidates</span><span class="p">:</span>
                            <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                                <span class="n">split_rows</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_tokens</span><span class="p">[</span><span class="n">prefix</span><span class="p">],</span> <span class="n">all_tokens</span><span class="p">[</span><span class="n">suffix</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">split_rows</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">best</span> <span class="o">=</span> <span class="n">split_rows</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span>
                            <span class="k">if</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold_rows</span><span class="p">:</span>
                                <span class="n">votes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="n">best</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

                    <span class="c1"># replace with more popular token?</span>
                    <span class="k">if</span> <span class="n">rows</span> <span class="o">&lt;=</span> <span class="n">threshold_rows</span><span class="p">:</span>
                        <span class="n">replacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closest_tokens</span><span class="p">(</span>
                            <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="c1"># we accept anything if current is not a token</span>
                            <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.6</span> <span class="k">if</span> <span class="n">rows</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="c1"># it must be more popular</span>
                            <span class="n">min_docs</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">threshold_rows</span><span class="p">,</span> <span class="n">rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">all_tokens</span><span class="o">=</span><span class="n">all_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">replacement</span><span class="p">:</span>
                            <span class="c1"># bias how different the tokens are with</span>
                            <span class="c1"># how many rows they are in</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">replacement</span><span class="p">):</span>
                                <span class="n">replacement</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">score</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">all_tokens</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">/</span> <span class="n">row_count</span><span class="p">),</span> <span class="n">token</span><span class="p">)</span>

                            <span class="n">replacement</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">replacement</span> <span class="o">=</span> <span class="n">replacement</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">votes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">all_tokens</span><span class="p">[</span><span class="n">replacement</span><span class="p">],</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="n">replacement</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">votes</span><span class="p">:</span>
                        <span class="c1"># if the popularity is identical then this is the</span>
                        <span class="c1"># preferred order (biggest number wins)</span>
                        <span class="n">priority</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="c1"># coalesce and replace can be the same</span>
                            <span class="c1"># replacement but we want coalesce because</span>
                            <span class="c1"># it consumes the next token</span>
                            <span class="s2">&quot;coalesce&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                            <span class="s2">&quot;split&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="c1"># replace is last resort</span>
                            <span class="s2">&quot;replace&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">}</span>

                        <span class="n">_</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">votes</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">priority</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">modified</span><span class="p">[</span><span class="n">token_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
                        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;coalesce&quot;</span><span class="p">:</span>
                            <span class="n">modified</span><span class="p">[</span><span class="n">token_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

                <span class="c1"># updates?</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">modified</span><span class="p">):</span>
                    <span class="n">updated_query</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">new_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="c1"># track inter-token separation</span>
                    <span class="n">last_end</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># token[0,1] are the offsets into utf8</span>
                    <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tokenized</span><span class="p">,</span> <span class="n">modified</span><span class="p">):</span>
                        <span class="c1"># unchanged</span>
                        <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">new_text</span> <span class="o">+=</span> <span class="n">utf8</span><span class="p">[</span><span class="n">last_end</span> <span class="p">:</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span>
                                <span class="n">utf8</span><span class="p">[</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                            <span class="p">)</span>
                            <span class="n">last_end</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="c1"># deleted</span>
                        <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">last_end</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="c1"># replaced with a different token</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">new_text</span> <span class="o">+=</span> <span class="n">utf8</span><span class="p">[</span><span class="n">last_end</span> <span class="p">:</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">+</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">text_for_token</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">tft_docs</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">last_end</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">continue</span>

                        <span class="c1"># multiple tokens - take previous as separator else space</span>
                        <span class="n">sep</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">[</span><span class="n">last_end</span> <span class="p">:</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">last_end</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
                        <span class="n">new_text</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_for_token</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tft_docs</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">)</span>
                        <span class="n">last_end</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">phrase</span><span class="o">.</span><span class="n">phrase</span> <span class="o">=</span> <span class="n">new_text</span>
                    <span class="k">if</span> <span class="n">query_range</span><span class="p">:</span>
                        <span class="c1"># we need to regenerate a new AND with the</span>
                        <span class="c1"># PHRASEs within</span>
                        <span class="n">new_node</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">parse_query_string</span><span class="p">(</span><span class="n">new_text</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">new_node</span><span class="p">):</span>
                            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
                        <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">new_node</span><span class="p">))</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="n">query_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">query_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_node</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">updated_query</span><span class="p">:</span>
            <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">_flatten</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5query</span><span class="o">.</span><span class="n">to_query_string</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span> <span class="k">if</span> <span class="n">updated_query</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Table.token_frequency">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.token_frequency">[docs]</a>
    <span class="k">def</span> <span class="nf">token_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Most frequent tokens, useful for building a stop words list</span>

<span class="sd">        This counts the total occurrences of the token, so appearing</span>
<span class="sd">        1,000 times in 1 document counts the same as once each in</span>
<span class="sd">        1,000 documents.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            * :meth:`token_doc_frequency`</span>
<span class="sd">            * :ref:`Example &lt;example_fts_tokens&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fts5vocab_name</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select term, cnt from </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2"> order by cnt desc limit ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="p">,))</span><span class="o">.</span><span class="n">get</span></div>


<div class="viewcode-block" id="Table.token_doc_frequency">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.token_doc_frequency">[docs]</a>
    <span class="k">def</span> <span class="nf">token_doc_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Most frequent occurring tokens, useful for building a stop words list</span>

<span class="sd">        This counts the total number of documents containing the</span>
<span class="sd">        token, so appearing 1,000 times in 1 document counts as 1,</span>
<span class="sd">        while once each in 1,000 documents counts as 1,000.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            * :meth:`token_frequency`</span>
<span class="sd">            * :ref:`Example &lt;example_fts_tokens&gt;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fts5vocab_name</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select term, doc from </span><span class="si">{</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="si">}</span><span class="s2"> order by doc desc limit ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">count</span><span class="p">,))</span><span class="o">.</span><span class="n">get</span></div>


<div class="viewcode-block" id="Table.text_for_token">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.text_for_token">[docs]</a>
    <span class="k">def</span> <span class="nf">text_for_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doc_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the original text used to produce ``token``</span>

<span class="sd">        Different text produces the same token because case can be</span>
<span class="sd">        ignored, accents and punctuation removed, synonyms and other</span>
<span class="sd">        processing.</span>

<span class="sd">        This method finds the text that produced a token, by</span>
<span class="sd">        re-tokenizing the documents containing the token.  Highest</span>
<span class="sd">        rowids are examined first so this biases towards the newest</span>
<span class="sd">        content.</span>

<span class="sd">        :param token: The token to find</span>
<span class="sd">        :param doc_limit: Maximum number of documents to examine.  The</span>
<span class="sd">            higher the limit the longer it takes, but the more</span>
<span class="sd">            representative the text is.</span>
<span class="sd">        :returns: The most popular text used to produce the token in</span>
<span class="sd">            the examined documents</span>

<span class="sd">        See :ref:`the example &lt;example_fts_tokens&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_for_token_counter</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>

        <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># The doc, col come out in random orders.  This resulted in</span>
        <span class="c1"># tokenizing the same documents over and over again.  Ordering</span>
        <span class="c1"># by doc then col solves that problem.  SQLite has to use a</span>
        <span class="c1"># temp btree to do the ordering, but testing with the enron</span>
        <span class="c1"># corpus had it taking 2 milliseconds.</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;select doc, col, offset</span>
<span class="s2">                from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">fts5vocab_name</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">)</span><span class="w"> </span><span class="si">}</span>
<span class="s2">                where term=?</span>
<span class="s2">                order by doc desc, col</span>
<span class="s2">                limit ?&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">doc_limit</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rowid</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="n">last</span><span class="p">:</span>
                <span class="c1"># new doc to process</span>
                <span class="n">doc</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_by_id</span><span class="p">(</span><span class="n">rowid</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="n">locale</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span>
                    <span class="c1"># col from above is a column name, but</span>
                    <span class="c1"># fts5_get_locale wants a column number</span>
                    <span class="n">locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;select fts5_get_locale(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">, ?) from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s2"> where rowid=?&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">rowid</span><span class="p">),</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">get</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">,</span> <span class="n">include_colocated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">col</span>
            <span class="n">text_for_token_counter</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">tokens</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text_for_token_counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># most_common returns zero entries either because the</span>
            <span class="c1"># token doesn&#39;t exist or doc_limit is less than 1</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token</span><span class="si">=}</span><span class="s2"> not found&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Table.row_by_id">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.row_by_id">[docs]</a>
    <span class="k">def</span> <span class="nf">row_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the contents of the row `id`</span>

<span class="sd">        You can request one column,, or several columns.  If one</span>
<span class="sd">        column is requested then just that value is returned, and a</span>
<span class="sd">        tuple of values for more than column.</span>

<span class="sd">        :exc:`KeyError` is raised if the row does not exist.</span>

<span class="sd">        See :ref:`the example &lt;example_fts_update&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">row</span><span class="p">,)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="w"> </span><span class="n">quote_name</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="w"> </span><span class="si">}</span><span class="s2"> where rowid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">,)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">row</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_name</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">quoted_table_name</span><span class="w"> </span><span class="si">}</span><span class="s2"> where rowid=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">,)):</span>
                <span class="k">return</span> <span class="n">row</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;row </span><span class="si">{</span><span class="nb">id</span><span class="si">=}</span><span class="s2"> not found&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Table.closest_tokens">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.closest_tokens">[docs]</a>
    <span class="k">def</span> <span class="nf">closest_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">min_docs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">all_tokens</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns closest known tokens to ``token`` with score for each</span>

<span class="sd">        This uses :func:`difflib.get_close_matches` algorithm to find</span>
<span class="sd">        close matches.  Note that it is a statistical operation, and</span>
<span class="sd">        has no understanding of the tokens and their meaning.</span>

<span class="sd">        :param token: Token to use</span>
<span class="sd">        :param n: Maximum number of tokens to return</span>
<span class="sd">        :param cutoff: Passed to :func:`difflib.get_close_matches`.</span>
<span class="sd">          Larger values require closer matches and decrease</span>
<span class="sd">          computation time.</span>
<span class="sd">        :param min_docs: Only test against other tokens that appear in</span>
<span class="sd">          at least this many rows.  Experience is that about a</span>
<span class="sd">          third of tokens appear only in one row.  Larger values</span>
<span class="sd">          significantly decrease computation time, but reduce the</span>
<span class="sd">          candidates.</span>
<span class="sd">        :param all_tokens:  A sequence of tuples of candidate token</span>
<span class="sd">          and number of rows it occurs in.  If not provided then</span>
<span class="sd">          :attr:`tokens` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">all_tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="n">result</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># get_close_matches is inlined here to deal with our data</span>
        <span class="c1"># shape.  We also keep track of the current best matches</span>
        <span class="c1"># dynamically increasing the cutoff value to decrease the</span>
        <span class="c1"># total amount of work.</span>

        <span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">()</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">set_seq2</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_docs</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">token</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">set_seq1</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sm</span><span class="o">.</span><span class="n">real_quick_ratio</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">cutoff</span> <span class="ow">and</span> <span class="n">sm</span><span class="o">.</span><span class="n">quick_ratio</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">cutoff</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">:=</span> <span class="n">sm</span><span class="o">.</span><span class="n">ratio</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ratio</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Table.fts5vocab_name">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.fts5vocab_name">[docs]</a>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">fts5vocab_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instance&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a `fts5vocab table &lt;https://www.sqlite.org/fts5.html#the_fts5vocab_virtual_table_module&gt;`__</span>
<span class="sd">        in temp and returns fully quoted name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fts5vocab_</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="w"> </span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="w"> </span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;temp.&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;create virtual table if not exists </span><span class="si">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="si">}</span><span class="s2"> using fts5vocab(</span>
<span class="s2">                    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qschema</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_qname</span><span class="si">}</span><span class="s2">, &quot;</span><span class="si">{</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;)&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span></div>


<div class="viewcode-block" id="Table.create">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.Table.create">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
        <span class="n">unindexed</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenize</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">support_query_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">rank</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content_rowid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">contentless_delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">contentless_unindexed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">columnsize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">detail</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">tokendata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">locale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">generate_triggers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">drop_if_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates the table, returning a :class:`Table` on success</span>

<span class="sd">        You can use :meth:`apsw.Connection.table_exists` to check if a</span>
<span class="sd">        table already exists.</span>

<span class="sd">        :param db: connection to create the table on</span>
<span class="sd">        :param name: name of table</span>
<span class="sd">        :param columns: A sequence of column names.  If you are using</span>
<span class="sd">           an external content table (recommended) you can supply</span>
<span class="sd">           ``None`` and the column names will be from the table named by</span>
<span class="sd">           the ``content`` parameter</span>
<span class="sd">        :param schema: Which attached database the table is being</span>
<span class="sd">            created in</span>
<span class="sd">        :param unindexed: Columns that will be `unindexed</span>
<span class="sd">            &lt;https://www.sqlite.org/fts5.html#the_unindexed_column_option&gt;`__</span>
<span class="sd">        :param tokenize: The `tokenize option</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#tokenizers&gt;`__.  Supply as a</span>
<span class="sd">            sequence of strings which will be correctly quoted</span>
<span class="sd">            together.</span>
<span class="sd">        :param support_query_tokens: Configure the `tokenize` option</span>
<span class="sd">            to allow :class:`queries using tokens</span>
<span class="sd">            &lt;apsw.fts5query.QueryTokens&gt;`.</span>
<span class="sd">        :param rank: The `rank option</span>
<span class="sd">            &lt;https://www.sqlite.org/fts5.html#the_rank_configuration_option&gt;`__</span>
<span class="sd">            if not using the default.  See :meth:`config_rank` for required</span>
<span class="sd">            syntax.</span>
<span class="sd">        :param prefix: The `prefix option</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#prefix_indexes&gt;`__.  Supply</span>
<span class="sd">            an int, or a sequence of int.</span>
<span class="sd">        :param content: Name of the external content table.  The</span>
<span class="sd">            external content table must be in the same database as the</span>
<span class="sd">            FTS5 table.</span>
<span class="sd">        :param content_rowid: Name of the `content rowid column</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#external_content_tables&gt;`__</span>
<span class="sd">            if not using the default when using an external content</span>
<span class="sd">            table</span>
<span class="sd">        :param contentless_delete: Set the `contentless delete option</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#contentless_delete_tables&gt;`__</span>
<span class="sd">            for contentless tables.</span>
<span class="sd">        :param contentless_unindexed: Set the `contentless unindexed</span>
<span class="sd">            option</span>
<span class="sd">            &lt;https://www.sqlite.org/fts5.html#the_contentless_unindexed_option&gt;`__</span>
<span class="sd">            for contentless tables</span>
<span class="sd">        :param columnsize: Indicate if the `column size tracking</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#the_columnsize_option&gt;`__</span>
<span class="sd">            should be disabled to save space</span>
<span class="sd">        :param detail: Indicate if `detail</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#the_detail_option&gt;`__ should</span>
<span class="sd">            be reduced to save space</span>
<span class="sd">        :param tokendata: Indicate if `tokens have separate data after</span>
<span class="sd">            a null char</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#the_tokendata_option&gt;`__</span>
<span class="sd">        :param locale: Indicate if a `locale</span>
<span class="sd">            &lt;https://www.sqlite.org/fts5.html#the_locale_option&gt;`__ is</span>
<span class="sd">            available to tokenizers and stored in the table</span>
<span class="sd">        :param generate_triggers: If using an external content table</span>
<span class="sd">            and this is ``True``, then `triggers are created</span>
<span class="sd">            &lt;https://sqlite.org/fts5.html#external_content_tables&gt;`__</span>
<span class="sd">            to keep this table updated with changes to the external</span>
<span class="sd">            content table.  These require a table not a view.</span>
<span class="sd">        :param drop_if_exists: The FTS5 table will be dropped if it</span>
<span class="sd">            already exists, and then created.</span>

<span class="sd">        If you create with an external content table, then</span>
<span class="sd">        :meth:`command_rebuild` and :meth:`command_optimize` will be</span>
<span class="sd">        run to populate the contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">qschema</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">qname</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to supply columns, or specify an external content table name&quot;</span><span class="p">)</span>
            <span class="c1"># check for a table/view</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="mi">0</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select name from </span><span class="si">{</span><span class="n">qschema</span><span class="si">}</span><span class="s2">.sqlite_schema where type=&#39;table&#39; or type=&#39;view&#39;&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;external table </span><span class="si">{</span><span class="n">schema</span><span class="si">=}</span><span class="s2"> . </span><span class="si">{</span><span class="n">content</span><span class="si">=}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
            <span class="n">columns</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select name from </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="si">}</span><span class="s2">.pragma_table_info(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">content</span><span class="p">,))</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">stricmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">content_rowid</span> <span class="ow">or</span> <span class="s2">&quot;rowid&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columns</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unindexed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unindexed</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unindexed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unindexed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;column &quot;</span><span class="si">{</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="si">}</span><span class="s1">&quot; is in unindexed, but not in </span><span class="si">{</span><span class="n">columns</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unindexed</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">support_query_tokens</span> <span class="ow">and</span> <span class="n">tokenize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tokenize</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;unicode61&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">tokenize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tokenize</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tokenize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">support_query_tokens</span> <span class="ow">and</span> <span class="n">tokenize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;querytokens&quot;</span><span class="p">:</span>
                <span class="n">tokenize</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;querytokens&quot;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">tokenize</span>
            <span class="c1"># using outside double quote and inside single quote out</span>
            <span class="c1"># of all the combinations available</span>
            <span class="n">qtokenize</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_name</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">tokenize</span><span class="p">),</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qtokenize</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">),</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="n">qcontent_rowid</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">content_rowid</span><span class="p">)</span> <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="n">content_rowid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">qcontentless_delete</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">contentless_delete</span><span class="p">))</span> <span class="k">if</span> <span class="n">content</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">qcontentless_unindexed</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">contentless_unindexed</span><span class="p">))</span> <span class="k">if</span> <span class="n">content</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">tokendata</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tokendata</span><span class="p">))</span>
        <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">locale</span><span class="p">))</span>

        <span class="n">qcontent</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">sql</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">drop_if_exists</span><span class="p">:</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;drop table if exists </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">)</span>
        <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;create virtual table </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="si">}</span><span class="s2"> using fts5(&quot;</span><span class="p">)</span>
        <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">quote_name</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39; UNINDEXED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">unindexed</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tokenize&quot;</span><span class="p">,</span> <span class="n">qtokenize</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">qcontent</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;content_rowid&quot;</span><span class="p">,</span> <span class="n">qcontent_rowid</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;contentless_delete&quot;</span><span class="p">,</span> <span class="n">qcontentless_delete</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;contentless_unindexed&quot;</span><span class="p">,</span> <span class="n">qcontentless_unindexed</span><span class="p">),</span>
            <span class="c1"># for these we omit them for default value</span>
            <span class="p">(</span><span class="s2">&quot;columnsize&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">columnsize</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="n">detail</span> <span class="k">if</span> <span class="n">detail</span> <span class="o">!=</span> <span class="s2">&quot;full&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tokendata&quot;</span><span class="p">,</span> <span class="n">tokendata</span> <span class="k">if</span> <span class="n">tokendata</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;locale&quot;</span><span class="p">,</span> <span class="n">locale</span> <span class="k">if</span> <span class="n">locale</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="w"> </span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="n">register_tokenizers</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">map_tokenizers</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">config_rank</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rank</span><span class="si">=}</span><span class="s2"> is not accepted by FTS5&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">generate_triggers</span><span class="p">:</span>
                    <span class="n">qrowid</span> <span class="o">=</span> <span class="n">quote_name</span><span class="p">(</span><span class="n">content_rowid</span> <span class="k">if</span> <span class="n">content_rowid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;_ROWID_&quot;</span><span class="p">)</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_name</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
                    <span class="n">old_cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old.</span><span class="si">{</span><span class="n">quote_name</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
                    <span class="n">new_cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new.</span><span class="si">{</span><span class="n">quote_name</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
                    <span class="n">trigger_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                        <span class="n">quote_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fts5sync_</span><span class="si">{</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">(</span>
                            <span class="s2">&quot;insert&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;delete&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;update&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">drop trigger if exists </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">trigger_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">;</span>
<span class="s2">drop trigger if exists </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">trigger_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">;</span>
<span class="s2">drop trigger if exists </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">trigger_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">;</span>
<span class="s2">create trigger </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">trigger_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2"> after insert on </span><span class="si">{</span><span class="w"> </span><span class="n">qcontent</span><span class="w"> </span><span class="si">}</span>
<span class="s2">begin</span>
<span class="s2">    insert into </span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(rowid, </span><span class="si">{</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="si">}</span><span class="s2">) values (new.</span><span class="si">{</span><span class="w"> </span><span class="n">qrowid</span><span class="w"> </span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="w"> </span><span class="n">new_cols</span><span class="w"> </span><span class="si">}</span><span class="s2">);</span>
<span class="s2">end;</span>
<span class="s2">create trigger </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">trigger_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2"> after delete on </span><span class="si">{</span><span class="w"> </span><span class="n">qcontent</span><span class="w"> </span><span class="si">}</span>
<span class="s2">begin</span>
<span class="s2">    insert into </span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">, rowid, </span><span class="si">{</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="si">}</span><span class="s2">) values(&#39;delete&#39;, old.</span><span class="si">{</span><span class="w"> </span><span class="n">qrowid</span><span class="w"> </span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="w"> </span><span class="n">old_cols</span><span class="w"> </span><span class="si">}</span><span class="s2">);</span>
<span class="s2">end;</span>
<span class="s2">create trigger </span><span class="si">{</span><span class="w"> </span><span class="n">qschema</span><span class="w"> </span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="w"> </span><span class="n">trigger_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2"> after update on </span><span class="si">{</span><span class="w"> </span><span class="n">qcontent</span><span class="w"> </span><span class="si">}</span>
<span class="s2">begin</span>
<span class="s2">    insert into </span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">, rowid, </span><span class="si">{</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="si">}</span><span class="s2">) values(&#39;delete&#39;, old.</span><span class="si">{</span><span class="w"> </span><span class="n">qrowid</span><span class="w"> </span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="w"> </span><span class="n">old_cols</span><span class="w"> </span><span class="si">}</span><span class="s2">);</span>
<span class="s2">    insert into </span><span class="si">{</span><span class="w"> </span><span class="n">qname</span><span class="w"> </span><span class="si">}</span><span class="s2">(rowid, </span><span class="si">{</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="si">}</span><span class="s2">) values (new.</span><span class="si">{</span><span class="w"> </span><span class="n">qrowid</span><span class="w"> </span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="w"> </span><span class="n">new_cols</span><span class="w"> </span><span class="si">}</span><span class="s2">);</span>
<span class="s2">end;</span>
<span class="s2">                               &quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">inst</span><span class="o">.</span><span class="n">command_rebuild</span><span class="p">()</span>
                <span class="n">inst</span><span class="o">.</span><span class="n">command_optimize</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">inst</span></div>
</div>



<span class="k">def</span> <span class="nf">_apsw_get_statistical_info</span><span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5ExtensionApi</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s2">&quot;Behind the scenes function used to return stats about the table&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;row_count&quot;</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">row_count</span><span class="p">,</span>
            <span class="s2">&quot;token_count&quot;</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">column_total_size</span><span class="p">(),</span>
            <span class="s2">&quot;tokens_per_column&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">column_total_size</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">column_count</span><span class="p">)],</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="n">_search_context</span><span class="p">:</span> <span class="n">ContextVar</span><span class="p">[</span><span class="n">QueryInfo</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span><span class="s2">&quot;search_context&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_do_query_info</span><span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5ExtensionApi</span><span class="p">):</span>
    <span class="n">_search_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="n">QueryInfo</span><span class="p">(</span>
            <span class="n">phrases</span><span class="o">=</span><span class="n">api</span><span class="o">.</span><span class="n">phrases</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_apsw_get_match_info</span><span class="p">(</span><span class="n">api</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5ExtensionApi</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_search_context</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_do_query_info</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;rowid&quot;</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">rowid</span><span class="p">,</span>
            <span class="s2">&quot;column_size&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">column_size</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">column_count</span><span class="p">)),</span>
            <span class="s2">&quot;phrase_columns&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">phrase_columns</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">phrase_count</span><span class="p">)),</span>
        <span class="p">}</span>
    <span class="p">)</span>


<div class="viewcode-block" id="FTS5TableStructure">
<a class="viewcode-back" href="../../textsearch.html#apsw.fts5.FTS5TableStructure">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FTS5TableStructure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Table structure from SQL declaration available as :attr:`Table.structure`</span>

<span class="sd">    See :ref:`the example &lt;example_fts_structure&gt;`&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="s2">&quot;Table nane&quot;</span>
    <span class="n">columns</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="s2">&quot;All column names&quot;</span>
    <span class="n">unindexed</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="s2">&quot;Which columns are `unindexed &lt;https://www.sqlite.org/fts5.html#the_unindexed_column_option&gt;`__&quot;</span>
    <span class="n">tokenize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="s2">&quot;`Tokenize &lt;https://www.sqlite.org/fts5.html#tokenizers&gt;`__ split into arguments&quot;</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="s2">&quot;`Prefix &lt;https://www.sqlite.org/fts5.html#prefix_indexes&gt;`__ values&quot;</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="s2">&quot;`External content/content less &lt;https://www.sqlite.org/fts5.html#external_content_and_contentless_tables&gt;`__ or ``None`` for regular&quot;</span>
    <span class="n">content_rowid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="s2">&quot;`Rowid &lt;https://www.sqlite.org/fts5.html#external_content_tables&gt;`__ if external content table else ``None``&quot;</span>
    <span class="n">contentless_delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="s2">&quot;`Contentless delete option &lt;https://www.sqlite.org/fts5.html#contentless_delete_tables&gt;`__ if contentless table else ``None``&quot;</span>
    <span class="n">contentless_unindexed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="s2">&quot;`Contentless unindexed option &lt;https://www.sqlite.org/fts5.html#the_contentless_unindexed_option&gt;`__ if contentless table else ``None``&quot;</span>
    <span class="n">columnsize</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="s2">&quot;`Columnsize option &lt;https://www.sqlite.org/fts5.html#the_columnsize_option&gt;`__&quot;</span>
    <span class="n">tokendata</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="s2">&quot;`Tokendata option &lt;https://www.sqlite.org/fts5.html#the_tokendata_option&gt;`__&quot;</span>
    <span class="n">locale</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="s2">&quot;`Locale option &lt;https://www.sqlite.org/fts5.html#the_locale_option&gt;`__&quot;</span>
    <span class="n">detail</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">]</span>
    <span class="s2">&quot;`Detail option &lt;https://www.sqlite.org/fts5.html#the_detail_option&gt;`__&quot;</span></div>



<span class="k">def</span> <span class="nf">_fts5_vtable_tokens</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a SQL statement from sqlite_main create table using quoting rules&quot;&quot;&quot;</span>
    <span class="c1"># See tokenize.c in SQLIte source for reference of how various</span>
    <span class="c1"># codepoints are treated</span>

    <span class="k">def</span> <span class="nf">skip_spacing</span><span class="p">():</span>
        <span class="s2">&quot;Return true if we skipped any spaces or comments&quot;</span>
        <span class="k">nonlocal</span> <span class="n">pos</span>
        <span class="n">original_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">while</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="se">\x09\x0a\x0c\x0d\x20</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># comments</span>
        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;--&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">while</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/*&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">sql</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;*/&quot;</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">original_pos</span>

    <span class="k">def</span> <span class="nf">absorb_quoted</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">pos</span>
        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">`&#39;[&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># doubled quote escapes it, except square brackets</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;[&quot;</span> <span class="k">else</span> <span class="s2">&quot;]&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">end</span> <span class="o">+</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">!=</span> <span class="s2">&quot;]&quot;</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">break</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">end</span> <span class="o">+</span> <span class="n">end</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">absorb_word</span><span class="p">():</span>
        <span class="c1"># identifier-ish.  fts5 allows integers as column names!</span>
        <span class="k">nonlocal</span> <span class="n">pos</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span>

        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
            <span class="c1"># all non-ascii chars are part of words</span>
            <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;0123456789_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span> <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">pos</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">skip_spacing</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">absorb_quoted</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="c1"># punctuation</span>
        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;=,.;()&quot;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">absorb_word</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to handle &#39;</span><span class="si">{</span><span class="n">sql</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; in &#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s2">&#39; at </span><span class="si">{</span><span class="n">pos</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_fts5_vtable_parse</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FTS5TableStructure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turn sql into structure&quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">_fts5_vtable_tokens</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="c1"># SQLite uppercases these</span>
    <span class="k">if</span> <span class="n">tokens</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;CREATE&quot;</span><span class="p">,</span> <span class="s2">&quot;VIRTUAL&quot;</span><span class="p">,</span> <span class="s2">&quot;TABLE&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a virtual table in </span><span class="si">{</span><span class="n">sql</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;unindexed&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="s2">&quot;tokenize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;unicode61&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;content_rowid&quot;</span><span class="p">:</span> <span class="s2">&quot;_ROWID_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;columnsize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="s2">&quot;contentless_delete&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;contentless_unindexed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;tokendata&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;locale&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;USING&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected USING in </span><span class="si">{</span><span class="n">sql</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;FTS5&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not using FTS5 in </span><span class="si">{</span><span class="n">sql</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span>
    <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">while</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">}:</span>
        <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;UNINDEXED&quot;</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;unindexed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">}:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span>
            <span class="k">continue</span>
        <span class="k">assert</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;tokenize&quot;</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_fts5_vtable_tokens</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;prefix&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;content_rowid&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">}:</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;contentless_delete&quot;</span><span class="p">,</span> <span class="s2">&quot;contentless_unindexed&quot;</span><span class="p">,</span> <span class="s2">&quot;columnsize&quot;</span><span class="p">,</span> <span class="s2">&quot;tokendata&quot;</span><span class="p">,</span> <span class="s2">&quot;locale&quot;</span><span class="p">}:</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown option &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">sql</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;contentless_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;contentless_unindexed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]:</span>
        <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;content_rowid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vals</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">FTS5TableStructure</span><span class="p">(</span><span class="o">**</span><span class="n">vals</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">quote_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quote</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quotes name to ensure it is parsed as a name</span>

<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">quote</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quote</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="n">quote</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">import</span> <span class="nn">html</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">unicodedata</span>

    <span class="kn">import</span> <span class="nn">apsw.bestpractice</span>

    <span class="n">apsw</span><span class="o">.</span><span class="n">bestpractice</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">bestpractice</span><span class="o">.</span><span class="n">recommended</span><span class="p">)</span>

    <span class="c1"># This code evolved a lot, and was not intelligently designed.  Sorry.</span>

    <span class="k">def</span> <span class="nf">show_tokenization</span><span class="p">(</span>
        <span class="n">options</span><span class="p">,</span> <span class="n">tok</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">FTS5Tokenizer</span><span class="p">,</span> <span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">locale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs the tokenizer and produces a html fragment showing the results for manual inspection&quot;&quot;&quot;</span>

        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="nd">@dataclass</span>
        <span class="k">class</span> <span class="nc">Row</span><span class="p">:</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">end</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="n">token_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">colo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">seq</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Row</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">toknum</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tok</span><span class="p">(</span><span class="n">utf8</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">locale</span><span class="p">)):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">row</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">show_tokenization_remark</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u21d3</span><span class="s2"> start </span><span class="si">{</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="si">}</span><span class="s2"> is after end </span><span class="si">{</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">offset</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">show_start_overlap</span><span class="p">:</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">show_tokenization_remark</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\u21d3</span><span class="s2">  start </span><span class="si">{</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="si">}</span><span class="s2"> is before end of previous item </span><span class="si">{</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">offset</span><span class="p">:</span>
                <span class="c1"># white space</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Row</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">utf8</span><span class="o">=</span><span class="n">utf8</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">start</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
                <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Row</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">utf8</span><span class="o">=</span><span class="n">utf8</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">token_num</span><span class="o">=</span><span class="n">toknum</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">colo</span><span class="o">=</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">utf8</span><span class="p">):</span>
            <span class="c1"># trailing white space</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Row</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">utf8</span><span class="p">),</span> <span class="n">utf8</span><span class="o">=</span><span class="n">utf8</span><span class="p">[</span><span class="n">offset</span><span class="p">:]))</span>

        <span class="c1"># Generate html</span>

        <span class="k">def</span> <span class="nf">ud</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;U+</span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">:</span><span class="s2">04X</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="n">gc</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">unicode</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">explain</span> <span class="o">=</span> <span class="n">unicode_categories</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">gc</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">explain</span><span class="p">[</span><span class="n">gc</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">unicodedata</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">,</span>
                <span class="n">unicodedata</span><span class="o">.</span><span class="n">combining</span><span class="p">,</span>
                <span class="n">unicodedata</span><span class="o">.</span><span class="n">mirrored</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="w"> </span><span class="n">meth</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="k">def</span> <span class="nf">hex_utf8_bytes</span><span class="p">(</span><span class="n">utf8</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">codepoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">utf8</span><span class="p">):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mb">0b1111_0000</span> <span class="o">==</span> <span class="mb">0b1111_0000</span><span class="p">:</span>
                    <span class="n">codepoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mb">0b1110_0000</span> <span class="o">==</span> <span class="mb">0b1110_0000</span><span class="p">:</span>
                    <span class="n">codepoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mb">0b1100_0000</span> <span class="o">==</span> <span class="mb">0b1100_0000</span><span class="p">:</span>
                    <span class="n">codepoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">codepoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">codepoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">codepoints</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;span class=codepbytes&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;&amp;thinsp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%02x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\u2004</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">byte_codepoints</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="s2">&quot;}&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;wbr&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&lt;span class=codepoint title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">ud</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="w"> </span><span class="kc">True</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="nb">open</span><span class="si">}{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">unicodedata</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s1">&#39;U+</span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">:</span><span class="s1">04x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">close</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;&lt;/span&gt;&quot;</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span>
            <span class="p">)</span>

        <span class="n">tokensret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">row</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># space</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;&lt;tr class=&#39;not-token&#39;&gt;&quot;</span>
                <span class="c1"># token num</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;&lt;/td&gt;&quot;</span>
                <span class="c1"># start</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">row</span><span class="o">.</span><span class="n">start</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
                <span class="c1"># end</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">row</span><span class="o">.</span><span class="n">end</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
                <span class="c1"># bytes</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">hex_utf8_bytes</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
                <span class="c1"># bytes val</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
                <span class="c1"># token</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;&lt;/td&gt;&quot;</span>
                <span class="c1"># bytes codepoints - already escaped</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">byte_codepoints</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
                <span class="c1"># token codepoints</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;&lt;/td&gt;&quot;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">continue</span>

            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;tr class=&#39;token </span><span class="si">{</span><span class="s1">&#39;colo&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">row</span><span class="o">.</span><span class="n">colo</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&#39;&gt;&quot;</span>
            <span class="c1"># token num</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">row</span><span class="o">.</span><span class="n">token_num</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># start</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">row</span><span class="o">.</span><span class="n">start</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># end</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">row</span><span class="o">.</span><span class="n">end</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># bytes</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">hex_utf8_bytes</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># bytes val</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># token</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># bytes codepoints - already escaped</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">byte_codepoints</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="c1"># token codepoints - already escaped</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;td&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">byte_codepoints</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&quot;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">tokensret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">tokensret</span>

    <span class="c1"># column tips</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Token number or blank for non-token area&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Start byte offset into the utf8 buffer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;End byte offset into the utf8 buffer.  This points to the next byte after the token.  End - Start should equal the token length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hex of the bytes with those making up</span><span class="se">\n</span><span class="s2">each codepoint alternately underlined&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Decoded text from the bytes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Token that was returned&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Each codepoint from the bytes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Each codepoint from the token&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">show_tokenization_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;table class=&#39;tokenization-results&#39;&gt;&lt;thead&gt;&lt;tr&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;#&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;Start&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;End&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;Hex&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;Bytes&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;Token&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;Bytes codepoints&lt;/th&gt;</span>
<span class="s2">            &lt;th title=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;Token codepoints&lt;/th</span>
<span class="s2">            &gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;&quot;&quot;</span>
    <span class="n">show_tokenization_footer</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;details class=infobox&gt;&lt;summary&gt;Tips&lt;/summary&gt;</span>
<span class="s2">    &lt;ul&gt;&lt;li&gt;Hover over column headers to get descriptions&lt;li&gt;Hover over codepoints to get category and other information</span>
<span class="s2">    &lt;li&gt;You can resize columns from the bottom right of each header cell</span>
<span class="s2">    &lt;li&gt;You are shown what &lt;a href=&quot;https://www.unicode.org/reports/tr15/#Introduction&quot;&gt;nornal forms&lt;/a&gt; each block</span>
<span class="s2">        conforms to</span>
<span class="s2">    &lt;li&gt;In the original text test file, lines beginning with ## are ignored and lines beginning with # become</span>
<span class="s2">        each test block</span>
<span class="s2">    &lt;li&gt;Make sure you test the different tokenize reasons!</span>
<span class="s2">    &lt;/details&gt;&quot;&quot;&quot;</span>
    <span class="n">show_tokenization_css</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;style&gt;</span>

<span class="s2">    html {</span>
<span class="s2">        /* scroll past top header */</span>
<span class="s2">        scroll-padding-top: 100px;</span>
<span class="s2">    }</span>

<span class="s2">    .remark.result td {</span>
<span class="s2">        overflow-wrap: anywhere;</span>
<span class="s2">    }</span>

<span class="s2">    thead {</span>
<span class="s2">        position: sticky;</span>
<span class="s2">        top: 0;</span>
<span class="s2">        background: darkgoldenrod;</span>
<span class="s2">    }</span>

<span class="s2">    td, th {</span>
<span class="s2">        border: 1px solid black;</span>
<span class="s2">        padding: 3px;</span>
<span class="s2">        min-width: 5px;</span>
<span class="s2">    }</span>

<span class="s2">    td {</span>
<span class="s2">        vertical-align: top;</span>
<span class="s2">    }</span>

<span class="s2">    th {</span>
<span class="s2">        resize: horizontal;</span>
<span class="s2">        overflow: auto;</span>
<span class="s2">    }</span>

<span class="s2">    table {</span>
<span class="s2">        border-collapse: collapse</span>
<span class="s2">    }</span>

<span class="s2">    tr.result {</span>
<span class="s2">        background-color: lightblue;</span>
<span class="s2">        font-weight: bold;</span>
<span class="s2">    }</span>

<span class="s2">    tr.toc {</span>
<span class="s2">        background-color: powderblue;</span>
<span class="s2">        font-weight: bold;</span>
<span class="s2">    }</span>

<span class="s2">    tr.result .message {</span>
<span class="s2">        display: block;</span>
<span class="s2">        background-color: white;</span>
<span class="s2">        font-weight: normal;</span>
<span class="s2">    }</span>

<span class="s2">    tr.remark.error {</span>
<span class="s2">        background-color: red;</span>
<span class="s2">        font-weight: bold;</span>
<span class="s2">    }</span>

<span class="s2">    /* token number */</span>
<span class="s2">    .token td:nth-child(1) {</span>
<span class="s2">        text-align: right;</span>
<span class="s2">        font-weight: bold;</span>
<span class="s2">    }</span>

<span class="s2">    /* byte offsets */</span>
<span class="s2">    td:nth-child(2), td:nth-child(3) {</span>
<span class="s2">        text-align: right;</span>
<span class="s2">    }</span>

<span class="s2">    /* bytes */</span>
<span class="s2">    td:nth-child(4) {</span>
<span class="s2">        font-family: monospace;</span>
<span class="s2">        font-size: 95%;</span>
<span class="s2">    }</span>

<span class="s2">    /* non token space */</span>
<span class="s2">    .not-token {</span>
<span class="s2">        background-color: lightgray;</span>
<span class="s2">    }</span>

<span class="s2">    /* token */</span>
<span class="s2">    .token {</span>
<span class="s2">        background-color: lightyellow;</span>
<span class="s2">    }</span>

<span class="s2">    /* colocated token */</span>
<span class="s2">    .token.colo {</span>
<span class="s2">        background-color: #efefd0;</span>
<span class="s2">    }</span>

<span class="s2">    td .codepbytes:nth-child(odd) {</span>
<span class="s2">        text-decoration: underline;</span>
<span class="s2">    }</span>

<span class="s2">    .infobox {</span>
<span class="s2">        position: fixed;</span>
<span class="s2">        bottom: 0;</span>
<span class="s2">        right: 0;</span>
<span class="s2">        float: right;</span>
<span class="s2">        background-color: khaki;</span>
<span class="s2">        border: 1px solid black;</span>
<span class="s2">        padding: 3px;</span>
<span class="s2">        max-width: 50%;</span>
<span class="s2">    }</span>

<span class="s2">    .infobox summary {</span>
<span class="s2">        font-weight: bold;</span>
<span class="s2">        background-color: aquamarine;</span>
<span class="s2">        font-size: 110%;</span>
<span class="s2">    }</span>

<span class="s2">    .compare-original {</span>
<span class="s2">        display: block;</span>
<span class="s2">        float: left;</span>
<span class="s2">        background-color: lightgray;</span>
<span class="s2">    }</span>

<span class="s2">    .compare-tokens {</span>
<span class="s2">        display: block;</span>
<span class="s2">        float: left;</span>
<span class="s2">        background-color: lightyellow;</span>
<span class="s2">        text-wrap: balance;</span>
<span class="s2">    }</span>

<span class="s2">    .compare-tokens, .compare-original {</span>
<span class="s2">        padding: 5px;</span>
<span class="s2">    }</span>

<span class="s2">    .compare-tokens .ct:nth-child(odd) {</span>
<span class="s2">        text-decoration: underline;</span>
<span class="s2">    }</span>
<span class="s2">    &lt;/style&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">show_tokenization_remark</span><span class="p">(</span>
        <span class="n">remark</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;notice&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">link</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">compare</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;id=&#39;</span><span class="si">{</span><span class="w"> </span><span class="nb">id</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;a href=&#39;#</span><span class="si">{</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&gt;&quot;</span> <span class="k">if</span> <span class="n">link</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">le</span> <span class="o">=</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span> <span class="k">if</span> <span class="n">link</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compare</span><span class="p">:</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># fstring can&#39;t have backslash</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">compare</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">newline</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;span class=&#39;ct&#39;&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">compare</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">compare</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;&lt;span class=&#39;compare-original&#39; title=&#39;Original UTF8 bytes&#39;&gt;</span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2">&lt;/span&gt;&lt;span class=&#39;compare-tokens&#39; title=&#39;Tokens, alternate ones underlined&#39;&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compare</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;tr class=&#39;remark </span><span class="si">{</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="w"> </span><span class="nb">id</span><span class="w"> </span><span class="si">}</span><span class="s2">&gt;&lt;td colspan=8&gt;</span><span class="si">{</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">remark</span><span class="p">)</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">compare</span><span class="w"> </span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">con</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;python3 -m apsw.fts5&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Runs FTS5 tokenizer against test text producing a HTML report for manual inspection.</span>

<span class="s2">        The FTS5 builtin tokenizers are ascii, trigram, unicode61, and porter. apsw.fts5 tokenizers are</span>
<span class="s2">        registered as unicodewords, simplify, json, html, synonyms, regex, stopwords,</span>
<span class="s2">        transform, and ngram&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--text-file&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TEXT-FILE-NAME&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Filename containing test strings.  Default is builtin. &quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The test file should be UTF-8 encoded text.</span>

<span class="sd">        If it starts with a # then it is considered to be multiple text sections</span>
<span class="sd">        where a # line contains a description of the section.  Any lines beginning</span>
<span class="sd">        ## are ignored.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;wb&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Where to send the binary UTF8 encoded output html [stdout]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--normalize&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="s2">&quot;NFC NFKC NFD NFKD&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Normalize the bytes into this form.  Default is no normalization&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--reason&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">tokenize_reasons</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tokenize reason [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;DOCUMENT&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--locale&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional fts5_locale to use&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--register&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Registers tokenizers. Format is name=mod.submod.callable &quot;</span>
        <span class="s2">&quot;where name is what is registered with FTS5 and callable is the factory function.  The module containing &quot;</span>
        <span class="s2">&quot;callable will be imported.  Specify this option multiple times to register multiple tokenizers.&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;name=mod.part.callable&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># registrations built in</span>
    <span class="n">register_tokenizers</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">map_tokenizers</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--synonyms&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A json file where each key is a token, and the value is either a string, or a list of strings.  A tokenizer named synonyms will be registered doing lookups on that json&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILENAME&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--regex-flags&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A pipe separated list of flags - eg &#39;ASCII | DOTALL&#39; [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;NOFLAG&quot;</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--regex&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A regular expression.  A tokenizer named regex will be registered with the pattern and flags. Beware of shell quoting and backslashes.&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PATTERN&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--show-start-overlap&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shows big red message where tokens overlap.  Default is true unless &#39;gram&#39; is in args in which case it is false &quot;</span>
        <span class="s2">&quot;since ngrams/trigrams deliberately overlap tokens&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tokenizers and arguments to run. &quot;</span>
        <span class="s2">&quot;For example to run the trigram tokenizer on unicode61 keeping diacritics use: trigram unicode61 remove_diacritics 0&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Refusing to spew HTML to your terminal.  Redirect/pipe output or use the --output option&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_start_overlap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">show_start_overlap</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;gram&quot;</span> <span class="ow">in</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">synonyms</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">synonyms</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">con</span><span class="o">.</span><span class="n">register_fts5_tokenizer</span><span class="p">(</span><span class="s2">&quot;synonyms&quot;</span><span class="p">,</span> <span class="n">SynonymTokenizer</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">regex</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">regex_flags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="si">}</span><span class="s2"> doesn&#39;t seem to be a valid re flag&quot;</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">value</span>
        <span class="n">con</span><span class="o">.</span><span class="n">register_fts5_tokenizer</span><span class="p">(</span><span class="s2">&quot;regex&quot;</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">RegexTokenizer</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">regex</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">))</span>

    <span class="c1"># registrations from args</span>
    <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">register</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">convert_string_to_python</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
            <span class="n">con</span><span class="o">.</span><span class="n">register_fts5_tokenizer</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;add_note&quot;</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add_note</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing --register </span><span class="si">{</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="c1"># go</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">fts5_tokenizer</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">options</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># we build it all up in memory</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">tokenizer_test_strings</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">text_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">utf8</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">normalize</span><span class="p">,</span> <span class="n">utf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">show_tokenization</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">tokenize_reasons</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">reason</span><span class="p">],</span> <span class="n">options</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">comment</span><span class="p">,</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span> <span class="n">tokens</span><span class="p">))</span>

    <span class="n">w</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">w</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;/head&gt;&lt;body&gt;&#39;</span><span class="p">)</span>
    <span class="n">w</span><span class="p">(</span><span class="n">show_tokenization_css</span><span class="p">)</span>
    <span class="n">w</span><span class="p">(</span><span class="n">show_tokenization_header</span><span class="p">)</span>
    <span class="n">w</span><span class="p">(</span><span class="n">show_tokenization_remark</span><span class="p">(</span><span class="s2">&quot;Args: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">))</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">comment</span><span class="p">,</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NFC&quot;</span><span class="p">,</span> <span class="s2">&quot;NFKC&quot;</span><span class="p">,</span> <span class="s2">&quot;NFD&quot;</span><span class="p">,</span> <span class="s2">&quot;NFKD&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">is_normalized</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">utf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="n">forms</span> <span class="o">=</span> <span class="s2">&quot;: forms &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">forms</span> <span class="o">=</span> <span class="s2">&quot;: not normalized&quot;</span>
        <span class="n">w</span><span class="p">(</span>
            <span class="n">show_tokenization_remark</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">comment</span><span class="w"> </span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">forms</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;toc&quot;</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="n">counter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">show_tokenization_remark</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">comment</span><span class="w"> </span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">forms</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">counter</span><span class="p">,</span>
                <span class="n">compare</span><span class="o">=</span><span class="p">(</span><span class="n">utf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">),</span> <span class="n">tokens</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="s2">&quot;&lt;tr&gt;&lt;td colspan=8&gt;&lt;/i&gt;No bytes&lt;/i&gt;&lt;/td&gt;&lt;/tr&gt;&quot;</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="n">w</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">w</span><span class="p">(</span><span class="n">show_tokenization_footer</span><span class="p">)</span>
    <span class="n">w</span><span class="p">(</span><span class="s2">&quot;&lt;/body&gt;&lt;/html&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2004-2024, Roger Binns &lt;rogerb@rogerbinns.com&gt;.
      <span class="lastupdated">Last updated on Nov 25, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2NR9GDCQLT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2NR9GDCQLT', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>