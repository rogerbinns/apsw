

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apsw.shell &mdash; APSW 3.46.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=72bcf2f2" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=66b59bf7" />
      <link rel="stylesheet" type="text/css" href="../../_static/apsw.css?v=3c7e2631" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=0c22936b"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            APSW
              <img src="../../_static/apswlogo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.46.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation and customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apsw.html">APSW Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connection.html">Connections to a database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cursor.html">Cursors (executing SQL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../blob.html">Blob Input/Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backup.html">Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vtable.html">Virtual Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vfs.html">Virtual File System (VFS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bestpractice.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ext.html">Various interesting and useful bits of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exceptions.html">Exceptions and Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../execution.html">Execution and tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dbapi.html">DBAPI notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysqlite.html">sqlite3 module differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">APSW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../apsw.html">apsw</a></li>
      <li class="breadcrumb-item active">apsw.shell</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for apsw.shell</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="c1"># mypy: ignore-errors</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">code</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TextIO</span>

<span class="kn">import</span> <span class="nn">apsw</span>
<span class="kn">import</span> <span class="nn">apsw.ext</span>


<div class="viewcode-block" id="Shell">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell">[docs]</a>
<span class="k">class</span> <span class="nc">Shell</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implements a SQLite shell</span>

<span class="sd">    :param stdin: Where to read input from (default sys.stdin)</span>
<span class="sd">    :param stdout: Where to send output (default sys.stdout)</span>
<span class="sd">    :param stderr: Where to send errors (default sys.stderr)</span>
<span class="sd">    :param encoding: Default encoding for files opened/created by the</span>
<span class="sd">      Shell.  If you want stdin/out/err to use a particular encoding</span>
<span class="sd">      then you need to provide them `already configured</span>
<span class="sd">      &lt;https://docs.python.org/3/library/codecs.html#codecs.open&gt;`__ that way.</span>
<span class="sd">    :param args: This should be program arguments only (ie if</span>
<span class="sd">      passing in sys.argv do not include sys.argv[0] which is the</span>
<span class="sd">      program name.  You can also pass in None and then call</span>
<span class="sd">      :meth:`process_args` if you want to catch any errors</span>
<span class="sd">      in handling the arguments yourself.</span>
<span class="sd">    :param db: A existing :class:`~apsw.Connection` you wish to use</span>

<span class="sd">    Errors and diagnostics are only ever sent to error output</span>
<span class="sd">    (self.stderr) and never to the regular output (self.stdout).</span>

<span class="sd">    Shell commands begin with a dot (eg .help).  They are implemented</span>
<span class="sd">    as a method named after the command (eg command_help).  The method</span>
<span class="sd">    is passed one parameter which is the list of arguments to the</span>
<span class="sd">    command.</span>

<span class="sd">    Output modes are implemented by functions named after the mode (eg</span>
<span class="sd">    output_column for columns).</span>

<span class="sd">    When you request help the help information is automatically</span>
<span class="sd">    generated from the docstrings for the command and output</span>
<span class="sd">    functions.</span>

<span class="sd">    You should not use a Shell object concurrently from multiple</span>
<span class="sd">    threads.  It is one huge set of state information which would</span>
<span class="sd">    become inconsistent if used simultaneously.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Shell.Error">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.Error">[docs]</a>
    <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Class raised on errors.  The expectation is that the error</span>
<span class="sd">        will be displayed by the shell as text so there are no</span>
<span class="sd">        specific subclasses as the distinctions between different</span>
<span class="sd">        types of errors doesn&#39;t matter.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">stdin</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">stdout</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">stderr</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
                 <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">db</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create instance, set defaults and do argument processing.&quot;&quot;&quot;</span>
        <span class="c1"># The parameter doc has to be in main class doc as sphinx</span>
        <span class="c1"># ignores any described here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_file</span> <span class="o">=</span> <span class="s2">&quot;~/.sqlite_history&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="c1"># keep a reference around allowing switching connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_references</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;sqlite&gt; &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moreprompt</span> <span class="o">=</span> <span class="s2">&quot;    ..&gt; &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bail</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullvalue</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_table</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># do we truncate output in list mode?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># a stack of previous outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_stack</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># other stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_encoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">stdin</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

        <span class="c1"># default to box output</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using_a_terminal</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;output_box&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_box</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;quote&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;string_sanitize&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="s2">&quot;NULL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="mi">4096</span><span class="p">,</span>
                <span class="s2">&quot;text_width&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
                <span class="s2">&quot;use_unicode&quot;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>

        <span class="c1"># we don&#39;t become interactive until the command line args are</span>
        <span class="c1"># successfully parsed and acted upon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># current colouring object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_colour</span><span class="p">()</span>  <span class="c1"># set to default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_using_readline</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_line_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_output_modes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Processing command line arguments&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">()</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using_a_terminal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_using_a_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;isatty&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;isatty&quot;</span><span class="p">,</span>
                                                                                       <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ensure_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;The database isn&#39;t opened until first use.  This function ensures it is now open.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span> <span class="o">=</span> <span class="s2">&quot;:memory:&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span><span class="p">,</span>
                                       <span class="n">flags</span><span class="o">=</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_URI</span> <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_READWRITE</span>
                                       <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_CREATE</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="k">def</span> <span class="nf">_set_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newv</span><span class="p">):</span>
        <span class="s2">&quot;Sets the open database (or None) and filename&quot;</span>
        <span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">dbfilename</span><span class="p">)</span> <span class="o">=</span> <span class="n">newv</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span> <span class="o">=</span> <span class="n">dbfilename</span>

    <span class="n">db</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_ensure_db</span><span class="p">,</span> <span class="n">_set_db</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;The current :class:`~apsw.Connection`&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Shell.process_args">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.process_args">[docs]</a>
    <span class="k">def</span> <span class="nf">process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process command line options specified in args.  It is safe to</span>
<span class="sd">        call this multiple times.  We try to be compatible with SQLite shell</span>
<span class="sd">        argument parsing.</span>

<span class="sd">        :param args: A list of string options.  Do not include the</span>
<span class="sd">           program as args[0]</span>

<span class="sd">        :returns: A tuple of (databasefilename, initfiles,</span>
<span class="sd">           sqlncommands).  This is provided for informational purposes</span>
<span class="sd">           only - they have already been acted upon.  An example use</span>
<span class="sd">           is that the SQLite shell does not enter the main interactive</span>
<span class="sd">           loop if any sql/commands were provided.</span>

<span class="sd">        The first non-option is the database file name.  Each</span>
<span class="sd">        remaining non-option is treated as a complete input (ie it</span>
<span class="sd">        isn&#39;t joined with others looking for a trailing semi-colon).</span>

<span class="sd">        The SQLite shell uses single dash in front of options.  We</span>
<span class="sd">        allow both single and double dashes.  When an unrecognized</span>
<span class="sd">        argument is encountered then</span>
<span class="sd">        :meth:`process_unknown_args` is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># we don&#39;t use argparse as we need to be compatible with what</span>
        <span class="c1"># SQLite&#39;s C code does</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="c1"># are options still valid?</span>
        <span class="n">options</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># have we seen the database name?</span>
        <span class="n">havedbname</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># List of init files to read</span>
        <span class="n">inits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># List of sql/dot commands</span>
        <span class="n">sqls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">options</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">havedbname</span><span class="p">:</span>
                    <span class="c1"># grab new database</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">havedbname</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sqls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="c1"># remove initial single or double dash</span>
            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;You need to specify a filename after -init&quot;</span><span class="p">)</span>
                <span class="n">inits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;noheader&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;bail&quot;</span><span class="p">,</span> <span class="s2">&quot;interactive&quot;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;separator&quot;</span><span class="p">,</span> <span class="s2">&quot;nullvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;You need to specify a value after -&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;command_&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])([</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">sqlite_lib_version</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># A pretty gnarly thing to do</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">())</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;no-colour&quot;</span><span class="p">,</span> <span class="s2">&quot;no-color&quot;</span><span class="p">,</span> <span class="s2">&quot;nocolour&quot;</span><span class="p">,</span> <span class="s2">&quot;nocolor&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">colour_scheme</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out_colour</span><span class="p">()</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="c1"># only remaining known args are output modes</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;output_&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command_mode</span><span class="p">(</span><span class="n">args</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">continue</span>

            <span class="n">newargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_unknown_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Unrecognized argument &#39;&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">newargs</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">inits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command_read</span><span class="p">([</span><span class="n">f</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sqls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_complete_line</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span><span class="p">,</span> <span class="n">inits</span><span class="p">,</span> <span class="n">sqls</span></div>


<div class="viewcode-block" id="Shell.process_unknown_args">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.process_unknown_args">[docs]</a>
    <span class="k">def</span> <span class="nf">process_unknown_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is called when :meth:`process_args` encounters an</span>
<span class="sd">        argument it doesn&#39;t understand.  Override this method if you</span>
<span class="sd">        want to be able to understand additional command line arguments.</span>

<span class="sd">        :param args: A list of the remaining arguments.  The initial one will</span>
<span class="sd">           have had the leading dashes removed (eg if it was --foo on the command</span>
<span class="sd">           line then args[0] will be &quot;foo&quot;</span>
<span class="sd">        :returns: None if you don&#39;t recognize the argument either.  Otherwise</span>
<span class="sd">           return the list of remaining arguments after you have processed</span>
<span class="sd">           yours.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Shell.usage">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.usage">[docs]</a>
    <span class="k">def</span> <span class="nf">usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the usage message.&quot;</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Usage: python3 -m apsw [OPTIONS] FILENAME [SQL|CMD] [SQL|CMD]...</span>
<span class="s2">FILENAME is the name of a SQLite database. A new database is</span>
<span class="s2">created if the file does not exist. If omitted or an empty</span>
<span class="s2">string then an in-memory database is created.</span>
<span class="s2">OPTIONS include:</span>

<span class="s2">   -init filename       read/process named file</span>
<span class="s2">   -echo                print commands before execution</span>
<span class="s2">   -[no]header          turn headers on or off</span>
<span class="s2">   -bail                stop after hitting the first error</span>
<span class="s2">   -interactive         force interactive I/O (command editing and colour)</span>
<span class="s2">   -batch               force batch I/O (no banners or editing)</span>
<span class="s2">   -column              set output mode to &#39;column&#39;</span>
<span class="s2">   -csv                 set output mode to &#39;csv&#39;</span>
<span class="s2">   -html                set output mode to &#39;html&#39;</span>
<span class="s2">   -line                set output mode to &#39;line&#39;</span>
<span class="s2">   -list                set output mode to &#39;list&#39;</span>
<span class="s2">   -python              set output mode to &#39;python&#39;</span>
<span class="s2">   -jsonl               set output mode to &#39;jsonl&#39;</span>
<span class="s2">   -separator &#39;x&#39;       set output field separator (|)</span>
<span class="s2">   -nullvalue &#39;text&#39;    set text string for NULL values</span>
<span class="s2">   -version             show SQLite version</span>
<span class="s2">   -encoding &#39;name&#39;     the encoding to use for files</span>
<span class="s2">                        opened via .import, .read &amp; .output</span>
<span class="s2">   -nocolour            disables interactive colour output</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span></div>


    <span class="c1">###</span>
    <span class="c1">### Value formatting routines.  They take a value and return a</span>
    <span class="c1">### text formatting of them.  Mostly used by the various output&#39;s</span>
    <span class="c1">### but also by random other pieces of code.</span>
    <span class="c1">###</span>

    <span class="c1"># bytes that are ok in C strings - no need for quoting</span>
    <span class="n">_printable</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789~!@#$%^&amp;*()`_-+=</span><span class="si">{}</span><span class="s2">[]:;,.&lt;&gt;/?|&quot;</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_fmt_c_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Format as a C string including surrounding double quotes&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">op</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">r&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_printable</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullvalue</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
            <span class="n">fromc</span> <span class="o">=</span> <span class="nb">chr</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_printable</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fromc</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">%02X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="p">))</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># number of some kind</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_html_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="s2">&quot;Format as HTML (mainly escaping &amp;/&lt;/&gt;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span>\
           <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;amp;&quot;</span><span class="p">)</span><span class="o">.</span> \
           <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">)</span><span class="o">.</span> \
           <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">)</span><span class="o">.</span> \
           <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;apos;&quot;</span><span class="p">)</span><span class="o">.</span> \
           <span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&amp;quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_json_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="s2">&quot;Format a value.&quot;</span>
        <span class="c1"># JSON doesn&#39;t have a binary type so we base64 encode it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">encodebytes</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="s2">&quot;Format as python literal&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&quot;&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_printable</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">%02X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_sql_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="s2">&quot;Return the identifier quoted in SQL syntax if needed (eg table and column names)&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>  <span class="c1"># yes sqlite does allow zero length identifiers</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
        <span class="n">nonalnum</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[A-Za-z_0-9]+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonalnum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_reserved</span><span class="p">:</span>
                <span class="c1"># Ok providing it doesn&#39;t start with a digit</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;0123456789&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v</span>
        <span class="c1"># double quote it unless there are any double quotes in it</span>
        <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">nonalnum</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_text_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="s2">&quot;Regular text formatting&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullvalue</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="c1"># sqlite gives back raw bytes!</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;Binary data&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">)</span>

    <span class="c1">###</span>
    <span class="c1">### The various output routines.  They are always called with the</span>
    <span class="c1">### header irrespective of the setting allowing for some per query</span>
    <span class="c1">### setup. (see output_column for example).  The doc strings are</span>
    <span class="c1">### used to generate help.</span>
    <span class="c1">###</span>

    <span class="k">def</span> <span class="nf">output_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Items left aligned in space padded columns.  They are</span>
<span class="sd">        truncated if they do not fit. If the width hasn&#39;t been</span>
<span class="sd">        specified for a column then 10 is used unless the column name</span>
<span class="sd">        (header) is longer in which case that width is used.  Use the</span>
<span class="sd">        .width command to change column sizes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># as an optimization we calculate self._actualwidths which is</span>
        <span class="c1"># reset for each query</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">gw</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="c1"># if width is not present or 0 then autosize</span>
                <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

            <span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="n">gw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_actualwidths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;-</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">s&quot;</span><span class="p">)[</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">widths</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_actualwidths</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;-</span><span class="si">%d</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">s&quot;</span><span class="p">)[</span><span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">widths</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="c1"># output the headers</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actualwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">))</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">header_</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="c1"># sqlite shell uses two spaces between columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_column</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">widths</span><span class="p">))])</span>
            <span class="k">return</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actualwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="c1"># sqlite shell uses two spaces between columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">output_columns</span> <span class="o">=</span> <span class="n">output_column</span>

    <span class="k">def</span> <span class="nf">output_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Items in csv format (comma separated).  Use tabs mode for tab</span>
<span class="sd">        separated.  You can use the .separator command to use a</span>
<span class="sd">        different one after switching mode.  A separator of comma uses</span>
<span class="sd">        double quotes for quoting while other separators do not do any</span>
<span class="sd">        quoting.  The Python csv library used for this only supports</span>
<span class="sd">        single character separators.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># we use self._csv for the work, setup when header is</span>
        <span class="c1"># supplied. _csv is a tuple of a StringIO and the csv.writer</span>
        <span class="c1"># instance.</span>

        <span class="n">fixdata</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dialect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;excel&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dialect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;excel-tab&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;quoting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delimiter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;doublequote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># csv module is bug ridden junk - I already say no</span>
                <span class="c1"># quoting so it still looks for the quotechar and then</span>
                <span class="c1"># gets upset that it can&#39;t be quoted.  Which bit of no</span>
                <span class="c1"># quoting was ambiguous?</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;quotechar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_csv</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_csv</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="n">fixdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">header_</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fixdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="c1"># csv lib always does DOS eol</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># should not be other eol irregularities</span>
        <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="s2">&quot;HTML table style&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_html_col</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">header_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_html_col</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;TR&gt;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&lt;TD&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;TH&gt;&quot;</span><span class="p">)[</span><span class="n">header</span><span class="p">])</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;&lt;/TD&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/TH&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">header</span><span class="p">])</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&lt;/TR&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">output_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lines as SQL insert statements.  The table name is &quot;table&quot;</span>
<span class="sd">        unless you specified a different one as the second parameter</span>
<span class="sd">        to the .mode command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_table</span> <span class="o">+</span> <span class="s2">&quot; VALUES(&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fmt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;);</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output a JSON array.  Blobs are output as base64 encoded strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_json_value</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_json_value</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">fmt</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                   <span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">is_first</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;{ &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;]&quot;</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">is_last</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output_jsonl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output as JSON objects, newline separated.  Blobs are output as base64 encoded strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_json_value</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_json_value</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">fmt</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;{ &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        One value per line in the form &#39;column = value&#39; with a blank</span>
<span class="sd">        line between rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%*s</span><span class="s2"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">fmt</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">output_lines</span> <span class="o">=</span> <span class="n">output_line</span>

    <span class="k">def</span> <span class="nf">output_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="s2">&quot;All items on one line with separator&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">header_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_text_col</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fmt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="s2">&quot;Tuples in Python source form for each row&quot;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_python</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">header_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_python</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fmt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output_tcl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="s2">&quot;Outputs TCL/C style strings using current separator&quot;</span>
        <span class="c1"># In theory you could paste the output into your source ...</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">header</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_c_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">header_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_c_string</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fmt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">_fqt_kwargs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">output_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_names</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="s2">&quot;Outputs using line drawing and auto sizing columns&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqt_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># figure out default args</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fqt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">default</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;bindings&quot;</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fqt_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;text_width&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;text_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;colour&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">]})</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="o">.</span><span class="n">_format_table</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="n">output_box</span><span class="o">.</span><span class="n">all_at_once</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">output_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Outputs using ascii line drawing and strongly sanitized text&quot;</span>
        <span class="c1"># this function isn&#39;t actually called - output_box is used</span>
        <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">output_qbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Outputs using line drawing and auto sizing columns quoting values&quot;</span>
        <span class="c1"># this function isn&#39;t actually called - output_box is used</span>
        <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_output_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
        <span class="c1"># internal routine to output a summary line or two</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">summary</span> <span class="o">+</span> <span class="n">summary</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">summary_</span><span class="p">)</span>

    <span class="c1">###</span>
    <span class="c1">### Various routines</span>
    <span class="c1">###</span>

<div class="viewcode-block" id="Shell.cmdloop">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.cmdloop">[docs]</a>
    <span class="k">def</span> <span class="nf">cmdloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transient</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs the main interactive command loop.</span>

<span class="sd">        :param intro: Initial text banner to display instead of the</span>
<span class="sd">           default.  Make sure you newline terminate it.</span>
<span class="sd">        :param transient: Additional message about being connected to</span>
<span class="sd">          a transient in memory database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">intro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">intro</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SQLite version </span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">sqlite_lib_version</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2"> (APSW </span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">apsw_version</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">)</span>
<span class="s2">Enter &quot;.help&quot; for instructions</span>
<span class="s2">&quot;&quot;&quot;</span>
            <span class="n">intro</span> <span class="o">=</span> <span class="n">intro</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">and</span> <span class="n">intro</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">intro</span> <span class="o">+</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">intro_</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span><span class="p">:</span>
                <span class="n">transient</span> <span class="o">=</span> <span class="n">transient</span> <span class="ow">or</span> <span class="s2">&quot;Connected to a transient in-memory database.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">transient</span> <span class="o">+</span> <span class="n">transient</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">transient_</span><span class="p">)</span>

        <span class="n">using_readline</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">readline</span>
                <span class="n">old_completer</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_completer</span><span class="p">()</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_completer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;tab: complete&quot;</span><span class="p">)</span>
                <span class="n">using_readline</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">readline</span><span class="o">.</span><span class="n">read_history_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_file</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">using_readline</span><span class="p">:</span>
                    <span class="c1"># we drop completion cache because it contains</span>
                    <span class="c1"># table and column names which could have changed</span>
                    <span class="c1"># with last executed SQL</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_completion_cache</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_using_readline</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_complete_line</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># EOF</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_complete_line</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_append_input_description</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">using_readline</span><span class="p">:</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_completer</span><span class="p">(</span><span class="n">old_completer</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_history_length</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">write_history_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_file</span><span class="p">))</span></div>


<div class="viewcode-block" id="Shell.handle_exception">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.handle_exception">[docs]</a>
    <span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles the current exception, printing a message to stderr as appropriate.</span>
<span class="sd">        It will reraise the exception if necessary (eg if bail is true)&quot;&quot;&quot;</span>
        <span class="n">eclass</span><span class="p">,</span> <span class="nb">eval</span><span class="p">,</span> <span class="n">etb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">eval</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="nb">eval</span><span class="o">.</span><span class="n">_handle_exception_saw_this</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">eval</span><span class="p">,</span> <span class="s2">&quot;_handle_exception_saw_this&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_colour</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">eval</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_interrupt</span><span class="p">()</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Interrupted&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">eval</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pref</span> <span class="o">=</span> <span class="s2">&quot;At &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pref</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;From &quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">pref</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">etb</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etb</span><span class="o">.</span><span class="n">tb_frame</span><span class="p">)</span>
                    <span class="n">etb</span> <span class="o">=</span> <span class="n">etb</span><span class="o">.</span><span class="n">tb_next</span>

                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Frame </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> at line </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">))</span>
                    <span class="nb">vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="nb">vars</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)[:</span><span class="mi">80</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;&lt;Unable to convert to string&gt;&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%10s</span><span class="s2"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eclass</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">eval</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">error_</span><span class="p">)</span>

        <span class="nb">eval</span><span class="o">.</span><span class="n">_handle_exception_saw_this</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bail</span><span class="p">:</span>
            <span class="k">raise</span></div>


    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="o">**</span><span class="p">({</span><span class="s2">&quot;slots&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;frozen&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}))</span>
    <span class="k">class</span> <span class="nc">_qd</span><span class="p">:</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">remaining</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">error_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">error_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="kc">None</span>
        <span class="n">explain</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_query_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_qd</span><span class="p">:</span>
        <span class="s2">&quot;Internal routine to iterate over statements&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="n">sql</span>
        <span class="n">explain</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">et</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">bindings</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">saved</span><span class="p">,</span> <span class="n">explain</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="n">statement</span>
            <span class="n">explain</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">is_explain</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">cur</span><span class="o">.</span><span class="n">exec_trace</span> <span class="o">=</span> <span class="n">et</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ExecTraceAbort</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">BindingsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">_qd</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;You must used named bindings (eg $name) and .parameter set&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">explain</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">_qd</span><span class="p">(</span><span class="n">sql</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved</span><span class="p">)],</span> <span class="n">sql</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">saved</span><span class="p">)</span> <span class="p">:],</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;error_offset&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">explain</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">_qd</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;No binding present for &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; - use .parameter set </span><span class="si">{</span><span class="w"> </span><span class="n">var</span><span class="w"> </span><span class="si">}</span><span class="s2"> VALUE to provide one&quot;</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="n">explain</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">_qd</span><span class="p">(</span><span class="n">sql</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">saved</span><span class="p">)],</span> <span class="n">sql</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">saved</span><span class="p">):],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">explain</span><span class="p">)</span>

<div class="viewcode-block" id="Shell.process_sql">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.process_sql">[docs]</a>
    <span class="k">def</span> <span class="nf">process_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bindings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes SQL text consisting of one or more statements</span>

<span class="sd">        :param sql: SQL to execute</span>

<span class="sd">        :param bindings: bindings for the *sql*</span>

<span class="sd">        :param internal: If True then this is an internal execution</span>
<span class="sd">          (eg the .tables or .database command).  When executing</span>
<span class="sd">          internal sql timings are not shown nor is the SQL echoed.</span>

<span class="sd">        :param summary: If not None then should be a tuple of two</span>
<span class="sd">          items.  If the ``sql`` returns any data then the first item</span>
<span class="sd">          is printed before the first row, and the second item is</span>
<span class="sd">          printed after the last row.  An example usage is the .find</span>
<span class="sd">          command which shows table names.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">changes_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">fixws</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">fmt_sql</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4096</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span> <span class="ow">and</span> <span class="n">bindings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span>

        <span class="k">while</span> <span class="n">sql</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">qd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_details</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">qd</span><span class="o">.</span><span class="n">remaining</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="n">fmt_sql</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qd</span><span class="o">.</span><span class="n">error_text</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">qd</span><span class="o">.</span><span class="n">error_text</span><span class="w"> </span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qd</span><span class="o">.</span><span class="n">error_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">qd</span><span class="o">.</span><span class="n">error_offset</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="n">qd</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
                    <span class="n">before</span><span class="p">,</span> <span class="n">after</span> <span class="o">=</span> <span class="n">fixws</span><span class="p">(</span><span class="n">query</span><span class="p">[:</span><span class="n">offset</span><span class="p">][</span><span class="o">-</span><span class="mi">35</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)),</span> \
                        <span class="n">fixws</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="n">offset</span><span class="p">:][:</span><span class="mi">35</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">before</span> <span class="o">+</span> <span class="n">after</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">before</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;^--- error here&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">qd</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">_handle_exception_saw_this</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">qd</span><span class="o">.</span><span class="n">exception</span>

            <span class="k">if</span> <span class="n">qd</span><span class="o">.</span><span class="n">explain</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># explain</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_column</span>
            <span class="k">elif</span> <span class="n">qd</span><span class="o">.</span><span class="n">explain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># explain query plan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_column</span>

            <span class="n">use_prow</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="n">use_prow</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="o">==</span> <span class="s2">&quot;Shell.Row&quot;</span>

            <span class="n">timing_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_usage</span><span class="p">()</span>

            <span class="n">column_names</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;all_at_once&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">exec_trace</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">exec_trace</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">row_trace</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">row_trace</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span>

            <span class="k">for</span> <span class="n">prow</span> <span class="ow">in</span> <span class="n">Shell</span><span class="o">.</span><span class="n">PositionRow</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)):</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">prow</span><span class="o">.</span><span class="n">row</span>
                <span class="k">if</span> <span class="n">column_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">column_names</span> <span class="o">=</span> <span class="n">prow</span><span class="o">.</span><span class="n">columns</span>
                    <span class="k">if</span> <span class="n">qd</span><span class="o">.</span><span class="n">explain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># column 2 is &quot;notused&quot;</span>
                        <span class="n">column_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_output_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qd</span><span class="o">.</span><span class="n">explain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">row</span> <span class="o">=</span> <span class="n">prow</span> <span class="k">if</span> <span class="n">use_prow</span> <span class="k">else</span> <span class="n">row</span>
                <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">column_names</span> <span class="ow">and</span> <span class="n">rows</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">column_names</span> <span class="ow">and</span> <span class="n">summary</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_timing</span><span class="p">(</span><span class="n">timing_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_usage</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">qd</span><span class="o">.</span><span class="n">explain</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pop_output</span><span class="p">()</span>

        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()</span> <span class="o">-</span> <span class="n">changes_start</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">internal</span> <span class="ow">and</span> <span class="n">changes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">changes</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;changes: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">changes</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;total changes: &quot;</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">total_changes</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.process_command">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.process_command">[docs]</a>
    <span class="k">def</span> <span class="nf">process_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes a dot command.</span>

<span class="sd">        It is split into parts using :func:`shlex.split`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span>
        <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;command_&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Unknown command </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">.  Enter </span><span class="se">\&quot;</span><span class="s2">.help</span><span class="se">\&quot;</span><span class="s2"> for help&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">))</span>
        <span class="c1"># special handling for .parameter set because we need the value to preserve quoting</span>
        <span class="c1"># &#39;33&#39; and 33 are different</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;parameter&quot;</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">command</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">command</span><span class="p">[</span><span class="n">pos</span><span class="p">:]]</span>
        <span class="c1"># special handling for shell / py because we want to preserve the text exactly</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;py&quot;</span><span class="p">}:</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rest</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span></div>


    <span class="c1">###</span>
    <span class="c1">### Commands start here</span>
    <span class="c1">###</span>

    <span class="k">def</span> <span class="nf">_boolean_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s2">&quot;Parse and verify boolean parameter&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; expected ON or OFF&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;on&quot;</span>

    <span class="c1"># Note that doc text is used for generating help output.</span>

    <span class="k">def</span> <span class="nf">command_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;backup ?DB? FILE: Backup DB (default &quot;main&quot;) to FILE</span>

<span class="sd">        Copies the contents of the current database to FILE</span>
<span class="sd">        overwriting whatever was in FILE.  If you have attached databases</span>
<span class="sd">        then you can specify their name instead of the default of &quot;main&quot;.</span>

<span class="sd">        The backup is done at the page level - SQLite copies the pages</span>
<span class="sd">        as is.  There is no round trip through SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Backup takes one or two parameters&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_bail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;bail ON|OFF: Stop after hitting an error (default OFF)</span>

<span class="sd">        If an error is encountered while processing commands or SQL</span>
<span class="sd">        then exit.  (Note this is different than SQLite shell which</span>
<span class="sd">        only exits for errors in SQL.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;bail&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_cd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;cd ?DIR?: Changes current directory</span>

<span class="sd">        If no directory supplied then change to home directory&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Too many directories&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; is not a directory&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;changes ON|OFF: Show changes from last SQL and total changes (default OFF)</span>

<span class="sd">        After executing SQL that makes changes, the number of affected</span>
<span class="sd">        rows is displayed as well as a running count of all changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;changes&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;close: Closes the current database</span>

<span class="sd">        Use .open to open a database, or .connection to switch to another</span>
<span class="sd">        connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Unexpected arguments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;connection ?NUMBER?: List connections, or switch active connection</span>

<span class="sd">        This covers all connections, not just those started in this</span>
<span class="sd">        shell.  Closed connections are not shown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_references</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">connections</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ConnectionClosedError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">co</span><span class="o">.</span><span class="n">bold</span> <span class="o">+</span> <span class="s2">&quot;(Current connection is closed)&quot;</span> <span class="o">+</span> <span class="n">co</span><span class="o">.</span><span class="n">bold_</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dbs</span><span class="p">):</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="n">c</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">co</span><span class="o">.</span><span class="n">bold</span><span class="si">}{</span><span class="w"> </span><span class="n">sel</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">co</span><span class="o">.</span><span class="n">bold_</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">co</span><span class="o">.</span><span class="n">vnumber</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">i</span><span class="si">:</span><span class="s2"> 2</span><span class="si">}{</span><span class="w"> </span><span class="n">co</span><span class="o">.</span><span class="n">vnumber_</span><span class="w"> </span><span class="si">}</span><span class="s2"> - (</span><span class="si">{</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">open_vfs</span><span class="w"> </span><span class="si">}</span><span class="s2">) </span><span class="se">\&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">co</span><span class="o">.</span><span class="n">vstring</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">filename</span><span class="w"> </span><span class="si">}{</span><span class="w"> </span><span class="n">co</span><span class="o">.</span><span class="n">vstring_</span><span class="w"> </span><span class="si">}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">dbs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">c</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Too many arguments&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_colour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;colour SCHEME: Selects a colour scheme</span>

<span class="sd">        If using a colour terminal in interactive mode then output is</span>
<span class="sd">        automatically coloured to make it more readable.  Use &#39;off&#39; to</span>
<span class="sd">        turn off colour, and no name or &#39;default&#39; for the default colour</span>
<span class="sd">        scheme.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Too many colour schemes&quot;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;default&quot;</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No such colour scheme: &quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colour_scheme</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_colour</span><span class="p">()</span>

    <span class="n">command_color</span> <span class="o">=</span> <span class="n">command_colour</span>

    <span class="k">def</span> <span class="nf">command_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;databases: Lists names and files of attached databases</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;databases command doesn&#39;t take any parameters&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">58</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span><span class="s2">&quot;pragma database_list&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop_output</span><span class="p">()</span>

    <span class="n">_dbconfig_ignore</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;SQLITE_DBCONFIG_MAINDBNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;SQLITE_DBCONFIG_LOOKASIDE&quot;</span><span class="p">,</span> <span class="s2">&quot;SQLITE_DBCONFIG_MAX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SQLITE_DBCONFIG_STMT_SCANSTATUS&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">command_dbconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dbconfig ?NAME VALUE?: Show all dbconfig, or set a specific one</span>

<span class="sd">        With no arguments lists all settings.  Supply a name and integer value</span>
<span class="sd">        to change.  For example:</span>

<span class="sd">            .dbconfig enable_fkey 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_db_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbconfig_ignore</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">pretty</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;SQLITE_DBCONFIG_&quot;</span><span class="p">):]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">pretty</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">apsw</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;:  &quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Expected zero or two parameters&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;SQLITE_DBCONFIG_&quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_db_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown config option </span><span class="si">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">apsw</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_dbinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dbinfo ?NAME?: Shows summary and file information about the database</span>

<span class="sd">        This includes the numbers of tables, indices etc, as well as fields from</span>
<span class="sd">        the files as returned by :func:`apsw.ext.dbinfo`.</span>

<span class="sd">        NAME defaults to &#39;main&#39;, and can be the attached name of a database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;too many parameters&quot;</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">cmd</span> <span class="k">else</span> <span class="s2">&quot;main&quot;</span>

        <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select count(*) from [</span><span class="si">{</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="si">}</span><span class="s2">].sqlite_schema where type=&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;number of tables&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;number of indexes&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;number of triggers&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">(</span><span class="s2">&quot;trigger&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;number of views&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">(</span><span class="s2">&quot;view&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;schema size&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select total(length(sql)) from [</span><span class="si">{</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="si">}</span><span class="s2">].sqlite_schema&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">dbinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">schema</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;journal mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;journal_mode&quot;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">filename_wal</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;journal_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;wal&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">filename_journal</span><span class="p">))</span>

        <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;:  &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dump ?TABLE? [TABLE...]: Dumps all or specified tables in SQL text format</span>

<span class="sd">        The table name is treated as like pattern so you can use % as</span>
<span class="sd">        a wildcard.  You can use dump to make a text based backup of</span>
<span class="sd">        the database.  It is also useful for comparing differences or</span>
<span class="sd">        making the data available to other databases.  Indices and</span>
<span class="sd">        triggers for the table(s) are also dumped.  Finally views</span>
<span class="sd">        matching the table pattern name are dumped.</span>

<span class="sd">        Note that if you are dumping virtual tables such as used by</span>
<span class="sd">        the FTS5 module then they may use other tables to store</span>
<span class="sd">        information.  For example if you create a FTS5 table named</span>
<span class="sd">        *recipes* then it also creates *recipes_content*,</span>
<span class="sd">        *recipes_segdir* etc.  Consequently to dump this example</span>
<span class="sd">        correctly use:</span>

<span class="sd">           .dump recipes recipes_%</span>

<span class="sd">        If the database is empty or no tables/views match then there</span>
<span class="sd">        is no output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simple tables are easy to dump.  More complicated is dealing</span>
        <span class="c1"># with virtual tables, foreign keys etc.</span>

        <span class="c1"># Lock the database while doing the dump so nothing changes</span>
        <span class="c1"># under our feet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span><span class="s2">&quot;BEGIN IMMEDIATE&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Used in comment() - see issue 142</span>
        <span class="n">outputstrtype</span> <span class="o">=</span> <span class="nb">str</span>

        <span class="c1"># Python 2.3 can end up with nonsense like &quot;en_us&quot; so we fall</span>
        <span class="c1"># back to ascii in that case</span>
        <span class="n">outputstrencoding</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">outputstrencoding</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">outputstrencoding</span> <span class="o">=</span> <span class="s2">&quot;ascii&quot;</span>

        <span class="k">def</span> <span class="nf">unicodify</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">outputstrtype</span><span class="p">):</span>
                <span class="c1"># See issue 142 - it may not be in an expected encoding</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">outputstrencoding</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># first pass -see if virtual tables or foreign keys are in</span>
            <span class="c1"># use.  If they are we emit pragmas to deal with them, but</span>
            <span class="c1"># prefer not to emit them</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;virtuals&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;foreigns&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

            <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sqlite_&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*create\s+virtual\s+.*&quot;</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
                    <span class="n">v</span><span class="p">[</span><span class="s2">&quot;virtuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># pragma table_info doesn&#39;t tell us if foreign keys</span>
                <span class="c1"># are involved so we guess if any the various strings are</span>
                <span class="c1"># in the sql somewhere</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*\b(foreign\s*key|references)\b.*&quot;</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
                    <span class="n">v</span><span class="p">[</span><span class="s2">&quot;foreigns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;%&quot;</span><span class="p">]</span>

            <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sql</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;SELECT name,sql FROM sqlite_schema &quot;</span>
                        <span class="s2">&quot;WHERE sql NOT NULL AND type IN (&#39;table&#39;,&#39;view&#39;) &quot;</span>
                        <span class="s2">&quot;AND tbl_name LIKE ?1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="p">)):</span>
                    <span class="k">if</span> <span class="n">check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                        <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># will we need to analyze anything later?</span>
            <span class="n">analyze_needed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;select name from sqlite_schema where sql not null and type=&#39;table&#39; and tbl_name like &#39;sqlite_stat%&#39;&quot;</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; WHERE tbl=?&quot;</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analyze_needed</span><span class="p">:</span>
                            <span class="n">analyze_needed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">analyze_needed</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">blank</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">unicodify</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="n">initial_indent</span><span class="o">=</span><span class="s2">&quot;-- &quot;</span><span class="p">,</span> <span class="n">subsequent_indent</span><span class="o">=</span><span class="s2">&quot;-- &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">pats</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;(All)&quot;</span><span class="p">)[</span><span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;%&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">])</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;SQLite dump (by APSW </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">apsw_version</span><span class="p">(),</span> <span class="p">))</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;SQLite version &quot;</span> <span class="o">+</span> <span class="n">apsw</span><span class="o">.</span><span class="n">sqlite_lib_version</span><span class="p">())</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Date: &quot;</span> <span class="o">+</span> <span class="n">unicodify</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">&quot;</span><span class="p">)))</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Tables like: &quot;</span> <span class="o">+</span> <span class="n">pats</span><span class="p">)</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Database: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">getpass</span>
                <span class="kn">import</span> <span class="nn">socket</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;User: </span><span class="si">%s</span><span class="s2"> @ </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unicodify</span><span class="p">(</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()),</span> <span class="n">unicodify</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())))</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">blank</span><span class="p">()</span>

            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;The values of various per-database settings&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;PRAGMA page_size=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;page_size&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;PRAGMA encoding=&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">vac</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;FULL&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;INCREMENTAL&quot;</span><span class="p">}</span>
            <span class="n">vacvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;auto_vacuum&quot;</span><span class="p">)</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;PRAGMA auto_vacuum=&quot;</span> <span class="o">+</span> <span class="n">vac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vacvalue</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vacvalue</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;PRAGMA max_page_count=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;max_page_count&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">blank</span><span class="p">()</span>

            <span class="c1"># different python versions have different requirements</span>
            <span class="c1"># about specifying cmp to sort routine so we use this</span>
            <span class="c1"># portable workaround with a decorated list instead</span>
            <span class="n">dectables</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>
            <span class="n">dectables</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dectables</span><span class="p">]</span>

            <span class="n">virtuals</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;virtuals&quot;</span><span class="p">]</span>
            <span class="n">foreigns</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;foreigns&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">virtuals</span><span class="p">:</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;This pragma is needed to restore virtual tables&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;PRAGMA writable_schema=ON;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">foreigns</span><span class="p">:</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;This pragma turns off checking of foreign keys &quot;</span>
                        <span class="s2">&quot;as tables would be inconsistent while restoring.  It was introduced &quot;</span>
                        <span class="s2">&quot;in SQLite 3.6.19.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;PRAGMA foreign_keys=OFF;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">virtuals</span> <span class="ow">or</span> <span class="n">foreigns</span><span class="p">:</span>
                <span class="n">blank</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;BEGIN TRANSACTION;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">blank</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">sqldef</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c1"># return formatted sql watching out for embedded</span>
                <span class="c1"># comments at the end forcing trailing ; onto next</span>
                <span class="c1"># line https://sqlite.org/src/info/c04a8b8a4f</span>
                <span class="k">if</span> <span class="s2">&quot;--&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">nl</span> <span class="o">+</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># do the table dumping loops</span>
            <span class="n">oldtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_table</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_insert</span>
                <span class="c1"># Dump the table</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT sql FROM sqlite_schema WHERE name=?1 AND type=&#39;table&#39;&quot;</span><span class="p">,</span>
                                               <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">)):</span>
                        <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Table  &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">)</span>
                        <span class="c1"># Special treatment for virtual tables - they</span>
                        <span class="c1"># get called back on drops and creates and</span>
                        <span class="c1"># could thwart us so we have to manipulate</span>
                        <span class="c1"># sqlite_schema directly</span>
                        <span class="k">if</span> <span class="n">sql</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;virtual&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;DELETE FROM sqlite_schema WHERE name=&quot;</span> <span class="o">+</span> <span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s2">&quot; AND type=&#39;table&#39;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                <span class="s2">&quot;INSERT INTO sqlite_schema(type,name,tbl_name,rootpage,sql) VALUES(&#39;table&#39;,</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,0,</span><span class="si">%s</span><span class="s2">);</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                                   <span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;DROP TABLE IF EXISTS &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sqldef</span><span class="p">(</span><span class="n">sql</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_output_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span><span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># Now any indices or triggers</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sql</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="s2">&quot;SELECT name,sql FROM sqlite_schema &quot;</span>
                                <span class="s2">&quot;WHERE sql NOT NULL AND type IN (&#39;index&#39;, &#39;trigger&#39;) &quot;</span>
                                <span class="s2">&quot;AND tbl_name=?1 AND name NOT LIKE &#39;sqlite_%&#39; &quot;</span>
                                <span class="s2">&quot;ORDER BY lower(name)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">)):</span>
                            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Triggers and indices on  &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">)</span>
                                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sqldef</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
                        <span class="n">blank</span><span class="p">()</span>
                <span class="c1"># Views done last.  They have to be done in the same order as they are in sqlite_schema</span>
                <span class="c1"># as they could refer to each other</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sql</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name,sql FROM sqlite_schema &quot;</span>
                                                 <span class="s2">&quot;WHERE sql NOT NULL AND type=&#39;view&#39; &quot;</span>
                                                 <span class="s2">&quot;AND name IN ( &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                                                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;) ORDER BY _ROWID_&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                        <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Views&quot;</span><span class="p">)</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;DROP VIEW IF EXISTS </span><span class="si">%s</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sqldef</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">blank</span><span class="p">()</span>

                <span class="c1"># sqlite sequence</span>
                <span class="c1"># does it exist</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from sqlite_schema where name=&#39;sqlite_sequence&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()):</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select seq from main.sqlite_sequence where name=?1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;For primary key autoincrements the next id &quot;</span>
                                        <span class="s2">&quot;to use is stored in sqlite_sequence&quot;</span><span class="p">)</span>
                                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                <span class="s1">&#39;DELETE FROM main.sqlite_sequence WHERE name=</span><span class="si">%s</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;INSERT INTO main.sqlite_sequence VALUES (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">);</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                        <span class="n">blank</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pop_output</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_table</span> <span class="o">=</span> <span class="n">oldtable</span>

            <span class="c1"># analyze</span>
            <span class="k">if</span> <span class="n">analyze_needed</span><span class="p">:</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;You had used the analyze command on these tables before.  Rerun for this new data.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">analyze_needed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;ANALYZE &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">blank</span><span class="p">()</span>

            <span class="c1"># header fields</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;user_version&quot;</span><span class="p">,</span> <span class="s2">&quot;application_id&quot;</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Database header&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;pragma </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                <span class="n">blank</span><span class="p">()</span>

            <span class="c1"># Save it all</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;COMMIT TRANSACTION;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># cleanup pragmas</span>
            <span class="k">if</span> <span class="n">foreigns</span><span class="p">:</span>
                <span class="n">blank</span><span class="p">()</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Restoring foreign key checking back on.  Note that SQLite 3.6.19 is off by default&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;PRAGMA foreign_keys=ON;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">virtuals</span><span class="p">:</span>
                <span class="n">blank</span><span class="p">()</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Restoring writable schema back to default&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;PRAGMA writable_schema=OFF;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># schema reread</span>
                <span class="n">blank</span><span class="p">()</span>
                <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;We need to force SQLite to reread the schema because otherwise it doesn&#39;t know that &quot;</span>
                        <span class="s2">&quot;the virtual tables we inserted directly into sqlite_schema exist.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;BEGIN;</span><span class="se">\n</span><span class="s2">CREATE TABLE no_such_table(x,y,z);</span><span class="se">\n</span><span class="s2">ROLLBACK;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;echo ON|OFF: If ON then each SQL statement or command is printed before execution (default OFF)</span>

<span class="sd">        The SQL statement or command is sent to error output so that</span>
<span class="sd">        it is not intermingled with regular output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

<div class="viewcode-block" id="Shell.set_encoding">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.set_encoding">[docs]</a>
    <span class="k">def</span> <span class="nf">set_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves *enc* as the default encoding, after verifying that</span>
<span class="sd">        it is valid.  You can also include :error to specify error</span>
<span class="sd">        handling - eg &#39;cp437:replace&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">enc</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">enc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No known encoding &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">codecs</span><span class="o">.</span><span class="n">lookup_error</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No known codec error handler &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">enc</span><span class="p">,</span> <span class="n">errors</span></div>


    <span class="k">def</span> <span class="nf">command_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;encoding ENCODING: Set the encoding used for new files opened via .output and imports</span>

<span class="sd">        SQLite and APSW/Python work internally using Unicode and characters.</span>
<span class="sd">        Files however are a sequence of bytes.  An encoding describes</span>
<span class="sd">        how to convert between bytes and characters.  The default</span>
<span class="sd">        encoding is utf8 and that is generally the best value to use</span>
<span class="sd">        when other programs give you a choice.</span>

<span class="sd">        You can also specify an error handler.  For example</span>
<span class="sd">        `cp437:replace` will use code page 437 and any Unicode</span>
<span class="sd">        codepoints not present in cp437 will be replaced (typically</span>
<span class="sd">        with something like a question mark).  Other error handlers</span>
<span class="sd">        include `ignore`, `strict` (default) and `xmlcharrefreplace`.</span>

<span class="sd">        This command affects files opened after setting the encoding</span>
<span class="sd">        as well as imports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Encoding takes one argument&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_encoding</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">command_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;exceptions ON|OFF: If ON then detailed tracebacks are shown on exceptions (default OFF)</span>

<span class="sd">        Normally when an exception occurs the error string only is</span>
<span class="sd">        displayed.  However it is sometimes useful to get a full</span>
<span class="sd">        traceback.  An example would be when you are developing</span>
<span class="sd">        virtual tables and using the shell to exercise them.  In</span>
<span class="sd">        addition to displaying each stack frame, the local variables</span>
<span class="sd">        within each frame are also displayed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;exceptions&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;exit ?CODE?: Exit this program with optional exit code&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Too many parameters for exit&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2"> isn&#39;t an exit code&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;find value ?TABLE?: Searches all columns of all tables for a value</span>

<span class="sd">        The find command helps you locate data across your database</span>
<span class="sd">        for example to find a string or any references to an id.</span>

<span class="sd">        You can specify a like pattern to limit the search to a subset</span>
<span class="sd">        of tables (eg specifying CUSTOMER% for all tables beginning</span>
<span class="sd">        with CUSTOMER).</span>

<span class="sd">        The value will be treated as a string and/or integer if</span>
<span class="sd">        possible.  If value contains &#39;%&#39; or &#39;_&#39; then it is also treated as</span>
<span class="sd">        a like pattern.</span>

<span class="sd">        This command can take a long time to execute needing to scan</span>
<span class="sd">        all of the relevant tables, rows, and columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;At least one argument required and at most two accepted&quot;</span><span class="p">)</span>
        <span class="n">tablefilter</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tablefilter</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">querytemplate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queryparams</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">qp</span><span class="p">():</span>  <span class="c1"># binding for current queryparams</span>
            <span class="k">return</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">queryparams</span><span class="p">))</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;%&#39;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">queryparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">querytemplate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> LIKE &quot;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">())</span>
        <span class="n">queryparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">querytemplate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = &quot;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">queryparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">querytemplate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = &quot;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">querytemplate</span> <span class="o">=</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">querytemplate</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_schema WHERE type=&#39;table&#39; AND name LIKE ?1&quot;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="n">tablefilter</span><span class="p">,</span> <span class="p">)):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from </span><span class="si">%s</span><span class="s2"> WHERE &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">colq</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma table_info(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">)):</span>
                <span class="n">colq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">querytemplate</span> <span class="o">%</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryparams</span><span class="p">)))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colq</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">queryparams</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Table &quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">command_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;header(s) ON|OFF: Display the column names in output (default OFF)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="n">command_headers</span> <span class="o">=</span> <span class="n">command_header</span>

    <span class="n">_help_info</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">command_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;help ?COMMAND?: Shows list of commands and their usage</span>

<span class="sd">        If COMMAND is specified then shows detail about that COMMAND.</span>
<span class="sd">        ``.help all`` will show detailed help about all commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">:</span>
            <span class="c1"># buildup help database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;command_&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c1"># help is 3 parts</span>
                <span class="c1"># - the syntax string (eg backup ?dbname? filename)</span>
                <span class="c1"># - the one liner description (eg saves database to filename)</span>
                <span class="c1"># - the multi-liner detailed description</span>
                <span class="c1"># We grab this from the doc string for the function in the form</span>
                <span class="c1">#   syntax: one liner\nmulti\nliner</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
                <span class="k">assert</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot; command must have documentation&quot;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;command_&quot;</span><span class="p">):]</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">while</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">firstline</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstline</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot; command must have usage: description doc&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># work around textwrap bug</span>
                    <span class="n">multi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">multi</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span>
                    <span class="n">firstline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_modes</span><span class="p">)</span>
                    <span class="n">multi</span> <span class="o">=</span> <span class="n">multi</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_modes_detail</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;colour&quot;</span><span class="p">:</span>
                    <span class="n">colours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">colours</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">firstline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; from &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colours</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># All whitespace</span>
                    <span class="n">multi</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># break into paragraphs</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># make whitespace only lines be empty</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">multi</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="k">if</span> <span class="n">multi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">l</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">multi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">l</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">multi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">firstline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">firstline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">multi</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">tw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">command</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">command</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">command</span><span class="p">]</span>
                <span class="c1"># usage string</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># space padding (including 2 for between columns)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="c1"># usage message wrapped if need be</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tw</span> <span class="o">-</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                <span class="c1"># newline</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">command</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">command</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
                <span class="k">if</span> <span class="n">command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No such command </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">))</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help_info</span><span class="p">[</span><span class="n">command</span><span class="p">]</span>
                <span class="c1"># usage string</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># space padding (2)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="c1"># usage message wrapped if need be</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tw</span> <span class="o">-</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="c1"># newlines</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># detailed message</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">para</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">tw</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># if not first one then print separator header</span>
                <span class="k">if</span> <span class="n">command</span> <span class="o">!=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">tw</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;import FILE TABLE: Imports separated data from FILE into TABLE</span>

<span class="sd">        Reads data from the file into the named table using the</span>
<span class="sd">        current separator and encoding.  For example if the separator</span>
<span class="sd">        is currently a comma then the file should be CSV (comma</span>
<span class="sd">        separated values).</span>

<span class="sd">        All values read in are supplied to SQLite as strings.  If you</span>
<span class="sd">        want SQLite to treat them as other types then declare your</span>
<span class="sd">        columns appropriately.  For example declaring a column &#39;REAL&#39;</span>
<span class="sd">        will result in the values being stored as floating point if</span>
<span class="sd">        they can be safely converted.</span>

<span class="sd">        Another alternative is to create a temporary table, insert the</span>
<span class="sd">        values into that and then use casting.:</span>

<span class="sd">          CREATE TEMPORARY TABLE import(a,b,c);</span>
<span class="sd">          .import filename import</span>
<span class="sd">          CREATE TABLE final AS SELECT cast(a as BLOB), cast(b as INTEGER),</span>
<span class="sd">               cast(c as CHAR) from import;</span>
<span class="sd">          DROP TABLE import;</span>

<span class="sd">        You can also get more sophisticated using the SQL CASE</span>
<span class="sd">        operator.  For example this will turn zero length strings into</span>
<span class="sd">        null:</span>

<span class="sd">          SELECT CASE col WHEN &#39;&#39; THEN null ELSE col END FROM ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;import takes two parameters&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">final</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># start transaction so database can&#39;t be changed</span>
            <span class="c1"># underneath us</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN IMMEDIATE&quot;</span><span class="p">)</span>
            <span class="n">final</span> <span class="o">=</span> <span class="s2">&quot;ROLLBACK&quot;</span>

            <span class="c1"># how many columns?</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma table_info(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">ncols</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No such table &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">))</span>

            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;insert into </span><span class="si">%s</span><span class="s2"> values(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">))</span>

            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dialect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;excel&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dialect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;excel-tab&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;quoting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delimiter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;doublequote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;quotechar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csvin_wrapper</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncols</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;row </span><span class="si">%d</span><span class="s2"> has </span><span class="si">%d</span><span class="s2"> columns but should have </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">ncols</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting row </span><span class="si">{</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_csvin_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="c1"># Returns a csv reader that works around python bugs and uses</span>
        <span class="c1"># dialect dict to configure reader</span>
        <span class="n">thefile</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">thefile</span><span class="p">,</span> <span class="o">**</span><span class="n">dialect</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">line</span>
        <span class="n">thefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">command_autoimport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;autoimport FILENAME ?TABLE?: Imports filename creating a table and automatically working out separators and data types (alternative to .import command)</span>

<span class="sd">        The import command requires that you precisely pre-setup the</span>
<span class="sd">        table and schema, and set the data separators (eg commas or</span>
<span class="sd">        tabs).  This command figures out the separator and csv dialect</span>
<span class="sd">        automatically.  There must be at least two columns and two rows.</span>

<span class="sd">        If the table is not specified then the basename of the file</span>
<span class="sd">        will be used.</span>

<span class="sd">        Additionally the type of the contents of each column is also</span>
<span class="sd">        deduced - for example if it is a number or date.  Empty values</span>
<span class="sd">        are turned into nulls.  Dates are normalized into YYYY-MM-DD</span>
<span class="sd">        format and DateTime are normalized into ISO8601 format to</span>
<span class="sd">        allow easy sorting and searching.  4 digit years must be used</span>
<span class="sd">        to detect dates.  US (swapped day and month) versus rest of</span>
<span class="sd">        the world is also detected providing there is at least one</span>
<span class="sd">        value that resolves the ambiguity.</span>

<span class="sd">        Care is taken to ensure that columns looking like numbers are</span>
<span class="sd">        only treated as numbers if they do not have unnecessary</span>
<span class="sd">        leading zeroes or plus signs.  This is to avoid treating phone</span>
<span class="sd">        numbers and similar number like strings as integers.</span>

<span class="sd">        This command can take quite some time on large files as they</span>
<span class="sd">        are effectively imported twice.  The first time is to</span>
<span class="sd">        determine the format and the types for each column while the</span>
<span class="sd">        second pass actually imports the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Expected one or two parameters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;File </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> does not exist&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">final</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN IMMEDIATE&quot;</span><span class="p">)</span>
            <span class="n">final</span> <span class="o">=</span> <span class="s2">&quot;ROLLBACK&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tablename</span><span class="p">:</span>
                <span class="n">tablename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma table_info(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> already exists&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">))</span>

            <span class="c1"># The types we support deducing</span>
            <span class="k">def</span> <span class="nf">DateUS</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>  <span class="c1"># US formatted date with wrong ordering of day and month</span>
                <span class="k">return</span> <span class="n">DateWorld</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">switchdm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">DateWorld</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">switchdm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># Sensibly formatted date as used anywhere else in the world</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">switchdm</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span>
                <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">DateTimeUS</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>  <span class="c1"># US date and time</span>
                <span class="k">return</span> <span class="n">DateTimeWorld</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">switchdm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">DateTimeWorld</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">switchdm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># Sensible date and time</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdatetime</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">switchdm</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span>
                <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">23</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&gt;</span> <span class="mi">59</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">65</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">T</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">Number</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>  <span class="c1"># we really don&#39;t want phone numbers etc to match</span>
                <span class="c1"># Python&#39;s float &amp; int constructors allow whitespace which we don&#39;t</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>  <span class="c1"># idd prefix</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[0-9]+$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span>  <span class="c1"># also a phone number</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;0.&quot;</span><span class="p">):</span>  <span class="c1"># deceptive not a number</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># Work out the file format</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;excel&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="s2">&quot;excel-tab&quot;</span><span class="p">}]</span>
            <span class="n">seps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">:</span>
                <span class="n">seps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">:</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;quoting&quot;</span><span class="p">:</span> <span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span><span class="p">,</span> <span class="s2">&quot;delimiter&quot;</span><span class="p">:</span> <span class="n">sep</span><span class="p">,</span> <span class="s2">&quot;doublequote&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;quotechar&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">})</span>
            <span class="n">possibles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">encodingissue</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># format is copy() on every use.  This appears bizarre and</span>
            <span class="c1"># unnecessary.  However Python 2.3 and 2.4 somehow manage</span>
            <span class="c1"># to empty it if not copied.</span>
            <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
                <span class="n">ncols</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csvin_wrapper</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">lines</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lines</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="c1"># data type guess setup</span>
                            <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                                <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">DateUS</span><span class="p">,</span> <span class="n">DateWorld</span><span class="p">,</span> <span class="n">DateTimeUS</span><span class="p">,</span> <span class="n">DateTimeWorld</span><span class="p">,</span> <span class="n">Number</span><span class="p">])</span>
                            <span class="n">allblanks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncols</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected </span><span class="si">%d</span><span class="s2"> columns - got </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
                        <span class="n">lines</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">continue</span>
                            <span class="n">allblanks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">continue</span>
                            <span class="c1"># remove datas that give ValueError</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">dd</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                    <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="k">if</span> <span class="n">ncols</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># if a particular column was allblank then clear datas for it</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">allblanks</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">possibles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">format</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">encodingissue</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">encodingissue</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
                        <span class="s2">&quot;The file is probably not in the current encoding </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> and didn&#39;t match a known file format&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;File doesn&#39;t appear to match a known type.&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">+=</span> <span class="s2">&quot;  Errors reported:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">])</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possibles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;File matches more than one type!&quot;</span><span class="p">)</span>
            <span class="nb">format</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">datas</span> <span class="o">=</span> <span class="n">possibles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dialect&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;(delimited by </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">format</span><span class="p">[</span><span class="s2">&quot;delimiter&quot;</span><span class="p">],</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;Detected Format </span><span class="si">%s</span><span class="s2">  Columns </span><span class="si">%d</span><span class="s2">  Rows </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
            <span class="c1"># Header row</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csvin_wrapper</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># Check schema</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Column #</span><span class="si">%d</span><span class="s2"> </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> has ambiguous data format - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]])))</span>
                <span class="k">if</span> <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">identity</span>
            <span class="c1"># Make the table</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;CREATE TABLE </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="c1"># prep work for each row</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO </span><span class="si">%s</span><span class="s2"> VALUES(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datas</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">l</span><span class="p">))</span>
                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;Auto-import into table </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> complete</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_getdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># Returns a tuple of 3 items y,m,d from string v</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([0-9]+)[^0-9]([0-9]+)[^0-9]([0-9]+)$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># swap order</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">9999</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_getdatetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># must be at least HH:MM</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([0-9]+)[^0-9]([0-9]+)[^0-9]([0-9]+)[^0-9]+([0-9]+)[^0-9]([0-9]+)([^0-9]([0-9]+))?$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9999</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">items</span>

    <span class="k">def</span> <span class="nf">command_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;indices TABLE: Lists all indices on table TABLE</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;indices takes one table name&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span>
                <span class="s2">&quot;SELECT name FROM sqlite_schema WHERE type=&#39;index&#39; AND tbl_name LIKE ?1 &quot;</span>
                <span class="s2">&quot;UNION ALL SELECT name FROM sqlite_temp_schema WHERE type=&#39;index&#39; AND tbl_name LIKE &quot;</span>
                <span class="s2">&quot;?1 ORDER by name&quot;</span><span class="p">,</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop_output</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;load FILE ?ENTRY?: Loads a SQLite extension library</span>

<span class="sd">        Note: Extension loading may not be enabled in the SQLite</span>
<span class="sd">        library version you are using.</span>

<span class="sd">        By default sqlite3_extension_init is called in the library but</span>
<span class="sd">        you can specify an alternate entry point.</span>

<span class="sd">        If you get an error about the extension not being found you</span>
<span class="sd">        may need to explicitly specify the directory.  For example if</span>
<span class="sd">        it is in the current directory then use:</span>

<span class="sd">          .load ./extension.so</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;load takes one or two parameters&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">enable_load_extension</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Extension loading is not supported&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span>

<div class="viewcode-block" id="Shell.log_handler">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.log_handler">[docs]</a>
    <span class="k">def</span> <span class="nf">log_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="s2">&quot;Called with SQLite log messages when logging is ON&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;( </span><span class="si">{</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">result_string</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2"> ) &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="n">code</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">command_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s2">&quot;log ON|OFF: Shows SQLite log messages (default off)&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">apsw</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_CONFIG_LOG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="k">if</span> <span class="n">setting</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">_output_modes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">command_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;mode MODE ?OPTIONS?: Sets output mode to one of&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Specify an output mode - use .help mode for detailed list&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="s2">&quot;tabs&quot;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;list&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;output_&quot;</span> <span class="o">+</span> <span class="n">w</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Expected a valid output mode: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_modes</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use .help mode for a detailed list&quot;</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;output_&quot;</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>

        <span class="c1"># argument parsing</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="s2">&quot;insert&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Output mode </span><span class="si">%s</span><span class="s2"> doesn&#39;t take parameters&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;table&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_sql_identifier</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">m</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="s2">&quot;qbox&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">}:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Output mode </span><span class="si">%s</span><span class="s2"> doesn&#39;t take parameters&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span>
            <span class="k">elif</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tabs&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">m</span>
            <span class="k">return</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;quote&quot;</span><span class="p">:</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;qbox&quot;</span><span class="p">},</span>
            <span class="s2">&quot;string_sanitize&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;box&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;qbox&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}[</span><span class="n">w</span><span class="p">],</span>
            <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="s2">&quot;NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;truncate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;box&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
                <span class="s2">&quot;qbox&quot;</span><span class="p">:</span> <span class="mi">4096</span>
            <span class="p">}[</span><span class="n">w</span><span class="p">],</span>
            <span class="s2">&quot;text_width&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="k">else</span> <span class="mi">80</span><span class="p">,</span>
            <span class="s2">&quot;use_unicode&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;box&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;qbox&quot;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}[</span><span class="n">w</span><span class="p">],</span>
            <span class="s2">&quot;word_wrap&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># argparse unfortunately tries to do too much and really is about program arguments,</span>
        <span class="c1"># but it isn&#39;t worthwhile re-implementing this</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">allow_abbrev</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;.mode </span><span class="si">{</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;exit_on_error&quot;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">exit_on_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--quote&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;quote&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show values in SQL syntax [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-quote&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;quote&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show values as strings&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--string-sanitize&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How much to clean up string characters (0 - none, 1 - medium, 2 - everything) [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--null&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How to show NULL [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--truncate&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many characters to truncate long output at [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--width&quot;</span><span class="p">,</span>
                       <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;text_width&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum width of the table [Screen width if terminal, else 80 chars]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--unicode&quot;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_unicode&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use unicode line drawing [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-unicode&quot;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_unicode&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use ascii line drawing like +=-+ &quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--word-wrap&quot;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;word_wrap&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Wrap text at word boundaries [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-word-wrap&quot;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
                       <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;word_wrap&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Wrap at column width ignoring words&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">box_options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># bare except because SystemExit can be raised</span>
            <span class="k">raise</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_box</span>

    <span class="c1"># needed so command completion and help can use it</span>
    <span class="k">def</span> <span class="nf">_calculate_output_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;output_&quot;</span><span class="p">):]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;output_&quot;</span><span class="p">)]</span>
        <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;tabs&quot;</span><span class="p">)</span>
        <span class="n">modes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_modes</span> <span class="o">=</span> <span class="n">modes</span>

        <span class="n">detail</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;tabs&#39;</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">}:</span>
                <span class="k">continue</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;output_&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span>
            <span class="k">assert</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;output mode &quot;</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="s2">&quot; needs doc&quot;</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">while</span> <span class="s2">&quot;  &quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">detail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_modes_detail</span> <span class="o">=</span> <span class="n">detail</span>

    <span class="k">def</span> <span class="nf">command_nullvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;nullvalue STRING: Print STRING in place of null values</span>

<span class="sd">        This affects textual output modes like column and list and</span>
<span class="sd">        sets how SQL null values are shown.  The default is a zero</span>
<span class="sd">        length string.  Insert mode and dumps are not affected by this</span>
<span class="sd">        setting.  You can use double quotes to supply a zero length</span>
<span class="sd">        string.  For example:</span>

<span class="sd">          .nullvalue &quot;&quot;         # the default</span>
<span class="sd">          .nullvalue &lt;NULL&gt;     # rather obvious</span>
<span class="sd">          .nullvalue &quot; \\t &quot;     # A tab surrounded by spaces</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;nullvalue takes exactly one parameter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixup_backslashes</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">command_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;open ?OPTIONS? ?FILE?: Opens a database connection</span>

<span class="sd">        Options are:</span>

<span class="sd">        --wipe     Closes any existing connections in this process referring to</span>
<span class="sd">                   the same file  and deletes the database file, journals etc</span>
<span class="sd">                   before opening</span>

<span class="sd">        --vfs VFS  Which vfs to use when opening</span>

<span class="sd">        If FILE is omitted then a memory database is opened</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wipe</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="k">while</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;--wipe&quot;</span><span class="p">:</span>
                    <span class="n">wipe</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;--vfs&quot;</span><span class="p">:</span>
                    <span class="n">vfs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Unknown open param: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dbname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Too many arguments: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">p</span>

        <span class="k">if</span> <span class="n">wipe</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dbname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;You must specify a filename with --wipe&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">connections</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">filename</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dbname</span><span class="p">):</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ConnectionClosedError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;-journal&quot;</span><span class="p">,</span> <span class="s2">&quot;-wal&quot;</span><span class="p">,</span> <span class="s2">&quot;-shm&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbname</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_references</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span> <span class="o">=</span> <span class="n">dbname</span> <span class="k">if</span> <span class="n">dbname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfilename</span><span class="p">,</span>
                                   <span class="n">vfs</span><span class="o">=</span><span class="n">vfs</span><span class="p">,</span>
                                   <span class="n">flags</span><span class="o">=</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_URI</span> <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_READWRITE</span>
                                   <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_CREATE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;output FILENAME: Send output to FILENAME (or stdout)</span>

<span class="sd">        If the FILENAME is &#39;stdout&#39; then output is sent to standard</span>
<span class="sd">        output from when the shell was started.  The file is opened</span>
<span class="sd">        using the current encoding (change with &#39;encoding&#39; command).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Flush everything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;flush&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>  <span class="c1"># see issue 117</span>
                <span class="k">pass</span>

        <span class="c1"># we will also close stdout but only do so once we have a</span>
        <span class="c1"># replacement so that stdout is always valid</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;You must specify a filename&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s2">&quot;stdout&quot;</span><span class="p">:</span>
                <span class="n">old</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span><span class="p">:</span>
                    <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span>
                <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># done here in case close raises exception</span>
                    <span class="n">old</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="n">newf</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">old</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span><span class="p">:</span>
                <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">newf</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">old</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out_colour</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;parameter CMD ...:  Maintain named bindings you can use in your queries.</span>

<span class="sd">        Specify a subcommand:</span>

<span class="sd">           list            -- shows current bindings</span>
<span class="sd">           clear           -- deletes all bindings</span>
<span class="sd">           unset NAME      -- deletes named binding</span>
<span class="sd">           set NAME VALUE  -- sets binding to VALUE</span>

<span class="sd">        The value must be a valid SQL literal or expression.  For example</span>
<span class="sd">        `3` will be an integer 3 while &#39;3&#39; will be a string.</span>

<span class="sd">        Example::</span>

<span class="sd">          .parameter set floor 10.99</span>
<span class="sd">          .parameter set text &#39;Acme&#39;&#39;s Glove&#39;</span>
<span class="sd">          SELECT * FROM sales WHERE price &gt; $floor AND description != $text;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;clear&quot;</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">}:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;No parameters set</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unset&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39; is not in parameters&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select (</span><span class="si">{</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Does not appear to be a valid SQLite value: </span><span class="si">{</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">return</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;.parameter command not understood.  Use .help parameter to get usage&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;print STRING: print the literal STRING</span>

<span class="sd">        If more than one argument is supplied then they are printed</span>
<span class="sd">        space separated.  You can use backslash escapes such as \\n</span>
<span class="sd">        and \\t.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fixup_backslashes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;prompt MAIN ?CONTINUE?: Changes the prompts for first line and continuation lines</span>

<span class="sd">        The default is to print &#39;sqlite&gt; &#39; for the main prompt where</span>
<span class="sd">        you can enter a dot command or a SQL statement.  If the SQL</span>
<span class="sd">        statement is not complete then you are</span>
<span class="sd">        prompted for more using the continuation prompt which defaults</span>
<span class="sd">        to &#39; ..&gt; &#39;.  Example:</span>

<span class="sd">          .prompt &quot;command&gt; &quot; &quot;more command&gt; &quot;</span>

<span class="sd">        You can use backslash escapes such as \\n and \\t.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;prompt takes one or two arguments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixup_backslashes</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moreprompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixup_backslashes</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">command_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;py ?PYTHON?: Starts a python REPL or runs the Python statement provided</span>

<span class="sd">        The namespace provided includes ``apsw`` for the module, ``shell`` for this</span>
<span class="sd">        shell and ``db`` for the current database.</span>

<span class="sd">        Using the .output command does not affect output from this command.  You</span>
<span class="sd">        can write to `shell.stdout` and `shell.stderr`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;shell&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;apsw&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="p">,</span> <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">InteractiveInterpreter</span><span class="p">(</span><span class="nb">locals</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># we have to make sys.excepthook and sys.__excepthook__ be</span>
                <span class="c1"># the same otherwise the traceback includes methods in the</span>
                <span class="c1"># code module.  Ubuntu&#39;s apport messes with excepthook</span>
                <span class="n">hook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__excepthook__</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">runsource</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">hook</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="s2">&quot;Incomplete Python statement</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this should be locals (plural) but the method is written</span>
            <span class="c1"># in singular and works due to being passed as a positional</span>
            <span class="c1"># argument</span>
            <span class="n">code</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="nb">vars</span><span class="p">,</span> <span class="n">exitmsg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">intro</span> <span class="o">+</span> <span class="s2">&quot;Returning to APSW shell&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">intro_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;read FILENAME: Processes SQL and commands in FILENAME (or Python if FILENAME ends with .py)</span>

<span class="sd">        Treats the specified file as input (a mixture or SQL and/or</span>
<span class="sd">        dot commands).  If the filename ends in .py then it is treated</span>
<span class="sd">        as Python code instead.</span>

<span class="sd">        For Python code the symbol &#39;db&#39; refers to the current database,</span>
<span class="sd">        &#39;shell&#39; refers to the instance of the shell and &#39;apsw&#39; is the</span>
<span class="sd">        apsw module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;read takes a single filename&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">g</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;apsw&#39;</span><span class="p">:</span> <span class="n">apsw</span><span class="p">,</span> <span class="s1">&#39;shell&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">})</span>
            <span class="c1"># compile step is needed to associate name with code</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;exec&#39;</span><span class="p">),</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">push_input</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">f</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_line_number</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_complete_line</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">process_complete_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_append_input_description</span><span class="p">()</span>
                    <span class="k">raise</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pop_input</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;restore ?DB? FILE: Restore database from FILE into DB (default &quot;main&quot;)</span>

<span class="sd">        Copies the contents of FILE to the current database (default &quot;main&quot;).</span>
<span class="sd">        The backup is done at the page level - SQLite copies the pages as</span>
<span class="sd">        is.  There is no round trip through SQL code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Restore takes one or two parameters&quot;</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;schema ?TABLE? [TABLE...]: Shows SQL for table</span>

<span class="sd">        If you give one or more tables then their schema is listed</span>
<span class="sd">        (including indices).  If you don&#39;t specify any then all</span>
<span class="sd">        schemas are listed. TABLE is a like pattern so you can use % for</span>
<span class="sd">        wildcards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT sql||&#39;;&#39; FROM &quot;</span>
                    <span class="s2">&quot;(SELECT sql sql, type type, tbl_name tbl_name, name name &quot;</span>
                    <span class="s2">&quot;FROM sqlite_schema UNION ALL &quot;</span>
                    <span class="s2">&quot;SELECT sql, type, tbl_name, name FROM sqlite_temp_schema) &quot;</span>
                    <span class="s2">&quot;WHERE tbl_name LIKE ?1 AND type!=&#39;meta&#39; AND sql NOTNULL AND name NOT LIKE &#39;sqlite_%&#39; &quot;</span>
                    <span class="s2">&quot;ORDER BY substr(type,2,1), name&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop_output</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;separator STRING: Change separator for output mode and .import</span>

<span class="sd">        You can use quotes and backslashes.  For example to set the</span>
<span class="sd">        separator to space tab space you can use:</span>

<span class="sd">          .separator &quot; \\t &quot;</span>

<span class="sd">        The setting is automatically changed when you switch to csv or</span>
<span class="sd">        tabs output mode.  You should also set it before doing an</span>
<span class="sd">        import (ie , for CSV and \\t for TSV).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;separator takes exactly one parameter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixup_backslashes</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">_shows</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;changes&quot;</span><span class="p">,</span> <span class="s2">&quot;nullvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;separator&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;exceptions&quot;</span><span class="p">,</span>
              <span class="s2">&quot;encoding&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;shell CMD ARGS...: Run CMD ARGS in a system shell</span>

<span class="sd">        Note that output goes to the process standard output, not</span>
<span class="sd">        whatever the shell .output command has configured.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Specify command and arguments to run&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exit code </span><span class="si">{</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;show: Show the current values for various settings.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;show takes at most one parameter&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
            <span class="n">what</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">what</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shows</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Unknown show: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shows</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">what</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">what</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># boolean settings</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;exceptions&quot;</span><span class="p">,</span> <span class="s2">&quot;changes&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nullvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;separator&quot;</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_c_string</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_modes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;output_&quot;</span> <span class="o">+</span> <span class="n">v</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Bug: didn&#39;t find output mode&quot;</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_stdout</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;stdout&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;unknown stdout&gt;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;encoding&quot;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">v</span> <span class="o">+=</span> <span class="s2">&quot; (Errors &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Bug: unknown show handling&quot;</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="c1"># find width of k column</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%*.*s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">command_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;tables ?PATTERN?: Lists names of tables matching LIKE pattern</span>

<span class="sd">        This also returns views.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">push_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">]</span>

            <span class="c1"># The SQLite shell code filters out sqlite_ prefixes if</span>
            <span class="c1"># you specified an argument else leaves them in.  It also</span>
            <span class="c1"># has a hand coded output mode that does space separation</span>
            <span class="c1"># plus wrapping at 80 columns.</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT name FROM sqlite_schema &quot;</span>
                    <span class="s2">&quot;WHERE type IN (&#39;table&#39;, &#39;view&#39;) AND name NOT LIKE &#39;sqlite_%&#39; &quot;</span>
                    <span class="s2">&quot;AND name like ?1 &quot;</span>
                    <span class="s2">&quot;UNION ALL &quot;</span>
                    <span class="s2">&quot;SELECT name FROM sqlite_temp_schema &quot;</span>
                    <span class="s2">&quot;WHERE type IN (&#39;table&#39;, &#39;view&#39;) AND name NOT LIKE &#39;sqlite_%&#39; &quot;</span>
                    <span class="s2">&quot;ORDER BY 1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop_output</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;timeout MS: Try opening locked tables for MS milliseconds</span>

<span class="sd">        If a database is locked by another process SQLite will keep</span>
<span class="sd">        retrying.  This sets how many thousandths of a second it will</span>
<span class="sd">        keep trying for.  If you supply zero or a negative number then</span>
<span class="sd">        all busy handlers are disabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;timeout takes a number&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a number&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">set_busy_timeout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;timer ON|OFF: Control printing of time and resource usage after each query</span>

<span class="sd">        The values displayed are in seconds when shown as floating</span>
<span class="sd">        point or an absolute count.  Only items that have changed</span>
<span class="sd">        since starting the query are shown.  On non-Windows platforms</span>
<span class="sd">        considerably more information can be shown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boolean_command</span><span class="p">(</span><span class="s2">&quot;timer&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_usage</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Timing not supported by this Python version/platform&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">command_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s2">&quot;version: Displays SQLite, APSW, and Python version information&quot;</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No parameters taken&quot;</span><span class="p">)</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SQLite&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">sqlite_lib_version</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">sqlite3_sourceid</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Python&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="w"> </span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="w"> </span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;APSW&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">apsw_version</span><span class="p">(),</span>
            <span class="s2">&quot;APSW file&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span>
            <span class="s2">&quot;Amalgamation&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">using_amalgamation</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">maxw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxw</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="w"> </span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_vfsname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s2">&quot;vfsname: VFS name for database, or attached names&quot;</span>
        <span class="n">dbnames</span> <span class="o">=</span> <span class="n">cmd</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dbnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">vfsname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_vfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vfs</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;:  &quot;</span><span class="p">)</span>
            <span class="n">vout</span> <span class="o">=</span> <span class="s2">&quot;0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_vfsinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s2">&quot;vfsinfo: Shows detailed information about the VFS for the database&quot;</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No parameters taken&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vfs</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">vfs_details</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">vfs</span><span class="p">[</span><span class="s2">&quot;zName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">open_vfs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_format_vfs</span><span class="p">(</span><span class="n">vfs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_vfslist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="s2">&quot;vfslist: Shows detailed information about all the VFS available&quot;</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No parameters taken&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vfs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">vfs_details</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_format_vfs</span><span class="p">(</span><span class="n">vfs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">command_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;width NUM NUM ...: Set the column widths for &quot;column&quot; mode</span>

<span class="sd">        In &quot;column&quot; output mode, each column is a fixed width with values truncated to</span>
<span class="sd">        fit.  Specify new widths using this command.  Use a negative number</span>
<span class="sd">        to right justify and zero for default column width.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;You need to specify some widths!&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid number&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="n">w</span>

    <span class="k">def</span> <span class="nf">_terminal_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Works out the terminal width which is used for word wrapping</span>
<span class="sd">        some output (eg .help)&quot;&quot;&quot;</span>

        <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># we don&#39;t use shutil version because it can&#39;t be passed a</span>
            <span class="c1"># file descriptor</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">minimum</span><span class="p">)</span>

<div class="viewcode-block" id="Shell.push_output">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.push_output">[docs]</a>
    <span class="k">def</span> <span class="nf">push_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the current output settings onto a stack.  See</span>
<span class="sd">        :meth:`pop_output` for more details as to why you would use</span>
<span class="sd">        this.&quot;&quot;&quot;</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s2">&quot;separator&quot;</span><span class="p">,</span> <span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;nullvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;widths&quot;</span><span class="p">,</span> <span class="s2">&quot;truncate&quot;</span><span class="p">:</span>
            <span class="n">o</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.pop_output">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.pop_output">[docs]</a>
    <span class="k">def</span> <span class="nf">pop_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restores most recently pushed output.  There are many</span>
<span class="sd">        output parameters such as nullvalue, mode</span>
<span class="sd">        (list/tcl/html/insert etc), column widths, header etc.  If you</span>
<span class="sd">        temporarily need to change some settings then</span>
<span class="sd">        :meth:`push_output`, change the settings and then pop the old</span>
<span class="sd">        ones back.</span>

<span class="sd">        A simple example is implementing a command like .dump.  Push</span>
<span class="sd">        the current output, change the mode to insert so we get SQL</span>
<span class="sd">        inserts printed and then pop to go back to what was there</span>
<span class="sd">        before.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first item should always be present</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_stack</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_append_input_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;When displaying an error in :meth:`handle_exception` we</span>
<span class="sd">        want to give context such as when the commands being executed</span>
<span class="sd">        came from a .read command (which in turn could execute another</span>
<span class="sd">        .read).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Line </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_line_number</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

<div class="viewcode-block" id="Shell.fixup_backslashes">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.fixup_backslashes">[docs]</a>
    <span class="k">def</span> <span class="nf">fixup_backslashes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implements the various backlash sequences in s such as</span>
<span class="sd">        turning backslash t into a tab.</span>

<span class="sd">        This function is needed because :mod:`shlex` does not do it for us.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="n">s</span>
        <span class="c1"># See the resolve_backslashes function in SQLite shell source</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Backslash with nothing following&quot;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># advance again</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Unknown backslash sequence </span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.write">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s2">&quot;Writes text to dest.  dest will typically be one of self.stdout or self.stderr.&quot;</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.write_error">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.write_error">[docs]</a>
    <span class="k">def</span> <span class="nf">write_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="s2">&quot;Writes text to self.stderr colouring it&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">error</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">error_</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.write_value">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.write_value">[docs]</a>
    <span class="k">def</span> <span class="nf">write_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">apsw</span><span class="o">.</span><span class="n">format_sql_value</span><span class="p">):</span>
        <span class="s2">&quot;Writes colourized value to self.stdout converting to text with fmt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">colour_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span></div>


    <span class="n">_raw_input</span> <span class="o">=</span> <span class="nb">input</span>

<div class="viewcode-block" id="Shell.get_line">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.get_line">[docs]</a>
    <span class="k">def</span> <span class="nf">get_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a single line of input (may be incomplete SQL) from self.stdin.</span>

<span class="sd">        If EOF is reached then return None.  Do not include trailing</span>
<span class="sd">        newline in return.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span><span class="o">.</span><span class="n">prompt_</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using_readline</span><span class="p">:</span>
                        <span class="c1"># these are needed so that readline knows they are non-printing characters</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x01</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\x02</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x01</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\x02</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_input</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># raw_input excludes newline</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># includes newline unless last line of file doesn&#39;t have one</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># includes newline unless last line of file doesn&#39;t have one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_line_number</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># always a \n on the end normally so this is EOF</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">line</span></div>


<div class="viewcode-block" id="Shell.get_complete_line">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.get_complete_line">[docs]</a>
    <span class="k">def</span> <span class="nf">get_complete_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a complete input.</span>

<span class="sd">        For dot commands it will be one line.  For SQL statements it</span>
<span class="sd">        will be as many as is necessary to have a</span>
<span class="sd">        :meth:`~apsw.complete` statement (ie semicolon terminated).</span>
<span class="sd">        Returns None on end of file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_completion_first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;.help &quot;</span> <span class="o">+</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># incomplete SQL?</span>
            <span class="k">while</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">apsw</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_completion_first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moreprompt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># unexpected eof</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Incomplete SQL (line </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_line_number</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">),</span> <span class="n">command</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">line</span>
            <span class="k">return</span> <span class="n">command</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_interrupt</span><span class="p">()</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="Shell.handle_interrupt">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.handle_interrupt">[docs]</a>
    <span class="k">def</span> <span class="nf">handle_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deal with keyboard interrupt (typically Control-C).  It</span>
<span class="sd">        will :meth:`~apsw.Connection.interrupt` the database and print&quot;^C&quot; if interactive.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bail</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;^C</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="Shell.process_complete_line">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.process_complete_line">[docs]</a>
    <span class="k">def</span> <span class="nf">process_complete_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given some text will call the appropriate method to process</span>
<span class="sd">        it (eg :meth:`process_sql` or :meth:`process_command`)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_interrupt</span><span class="p">()</span></div>


<div class="viewcode-block" id="Shell.push_input">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.push_input">[docs]</a>
    <span class="k">def</span> <span class="nf">push_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the current input parameters to a stack.  See :meth:`pop_input`.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="s2">&quot;stdin&quot;</span><span class="p">,</span> <span class="s2">&quot;input_line_number&quot;</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.pop_input">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.pop_input">[docs]</a>
    <span class="k">def</span> <span class="nf">pop_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore most recently pushed input parameters (interactive,</span>
<span class="sd">        self.stdin, linenumber etc).  Use this if implementing a</span>
<span class="sd">        command like read.  Push the current input, read the file and</span>
<span class="sd">        then pop the input to go back to before.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_stack</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="Shell.complete">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.complete">[docs]</a>
    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a possible completion for :mod:`readline`</span>

<span class="sd">        This function is called with state starting at zero to get the</span>
<span class="sd">        first completion, then one/two/three etc until you return None.  The best</span>
<span class="sd">        implementation is to generate the list when state==0, save it,</span>
<span class="sd">        and provide members on each increase.</span>

<span class="sd">        The default implementation extracts the current full input</span>
<span class="sd">        from readline and then calls :meth:`complete_command` or</span>
<span class="sd">        :meth:`complete_sql` as appropriate saving the results for</span>
<span class="sd">        subsequent calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">readline</span>
            <span class="c1"># the whole line</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_line_buffer</span><span class="p">()</span>
            <span class="c1"># beginning and end(+1) of the token in line</span>
            <span class="n">beg</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_begidx</span><span class="p">()</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_endidx</span><span class="p">()</span>
            <span class="c1"># Are we matching a command?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_first</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">completions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_command</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">completions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_sql</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Readline swallows any exceptions we raise.  We</span>
                <span class="c1"># shouldn&#39;t be raising any so this is to catch that</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completions</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">completions</span><span class="p">[</span><span class="n">state</span><span class="p">]</span></div>


    <span class="n">_sqlite_keywords</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">keywords</span>
    <span class="c1"># reserved words need to be quoted.  Only a subset of the keywords are reserved</span>
    <span class="c1"># but what the heck</span>
    <span class="n">_sqlite_reserved</span> <span class="o">=</span> <span class="n">_sqlite_keywords</span>
    <span class="c1"># add a space after each of them except functions which get parentheses</span>
    <span class="n">_sqlite_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;VALUES&quot;</span><span class="p">,</span> <span class="s2">&quot;CAST&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_sqlite_keywords</span><span class="p">]</span>

    <span class="n">_sqlite_special_names</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;_ROWID_ OID ROWID sqlite_schema</span>
<span class="s2">           SQLITE_SEQUENCE&quot;&quot;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">_pragmas_bool</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">_pragmas</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;analysis_limit=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;application_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;auto_vacuum=&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">,</span> <span class="s2">&quot;INCREMENTAL&quot;</span><span class="p">),</span>
        <span class="s2">&quot;automatic_index=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;busy_timeout=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;cache_size=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;case_sensitive_like=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;cache_spill=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;cell_size_check=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;checkpoint_fullfsync=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;collation_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;compile_options&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;data_version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;database_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;defer_foreign_keys=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;encoding=&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-16&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-16le&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF16-16be&#39;</span><span class="p">),</span>
        <span class="s2">&quot;foreign_key_check&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;foreign_key_list(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;foreign_keys&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;freelist_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;fullfsync=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;function_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;hard_heap_limit=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;ignore_check_constraints&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;incremental_vacuum(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;index_info(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;index_list(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;index_xinfo(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;integrity_check&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;journal_mode=&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;TRUNCATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PERSIST&quot;</span><span class="p">,</span> <span class="s2">&quot;MEMORY&quot;</span><span class="p">,</span> <span class="s2">&quot;OFF&quot;</span><span class="p">,</span> <span class="s2">&quot;WAL&quot;</span><span class="p">),</span>
        <span class="s2">&quot;journal_size_limit=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;legacy_alter_table=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;legacy_file_format=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;locking_mode=&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NORMAL&quot;</span><span class="p">,</span> <span class="s2">&quot;EXCLUSIVE&quot;</span><span class="p">),</span>
        <span class="s2">&quot;max_page_count=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;mmap_size=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;module_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;optimize(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;page_count;&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;page_size=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;pragma_list;&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;query_only=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;quick_check&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;read_uncommitted=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;recursive_triggers=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;reverse_unordered_selects=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;schema_version&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;secure_delete=&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;shrink_memory&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;soft_heap_limit=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;synchronous=&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;OFF&quot;</span><span class="p">,</span> <span class="s2">&quot;NORMAL&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">),</span>
        <span class="s2">&quot;table_info(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;table_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;table_xinfo(&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;temp_store=&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">,</span> <span class="s2">&quot;FILE&quot;</span><span class="p">,</span> <span class="s2">&quot;MEMORY&quot;</span><span class="p">),</span>
        <span class="s2">&quot;threads=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;trusted_schema&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
        <span class="s2">&quot;user_version=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;wal_autocheckpoint=&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;wal_checkpoint&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;writable_schema&quot;</span><span class="p">:</span> <span class="n">_pragmas_bool</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_prev_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="s2">&quot;Returns the tokens prior to pos end in the line&quot;</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;?\w+&quot;?&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="n">end</span><span class="p">])</span>

<div class="viewcode-block" id="Shell.complete_sql">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.complete_sql">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide some completions for SQL</span>

<span class="sd">        :param line: The current complete input line</span>
<span class="sd">        :param token: The word readline is looking for matches</span>
<span class="sd">        :param beg: Integer offset of token in line</span>
<span class="sd">        :param end: Integer end of token in line</span>
<span class="sd">        :return: A list of completions, or an empty list if none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">collations</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma collation_list&quot;</span><span class="p">)]</span>
            <span class="n">databases</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma database_list&quot;</span><span class="p">)]</span>
            <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma module_list&quot;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">databases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db</span> <span class="o">==</span> <span class="s2">&quot;temp&quot;</span><span class="p">:</span>
                    <span class="n">master</span> <span class="o">=</span> <span class="s2">&quot;sqlite_temp_schema&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">master</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">].sqlite_schema&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="n">master</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sqlite_&quot;</span><span class="p">):</span>
                            <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma [</span><span class="si">%s</span><span class="s2">].table_info([</span><span class="si">%s</span><span class="s2">])&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">db</span><span class="p">,</span>
                                    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                                    <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                                        <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLError</span><span class="p">:</span>
                            <span class="c1"># See https://github.com/rogerbinns/apsw/issues/86</span>
                            <span class="k">pass</span>
                <span class="n">functions</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma function_list&quot;</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">narg</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">functions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">narg</span><span class="p">,</span> <span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

                <span class="k">def</span> <span class="nf">fmtfunc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">nargs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nargs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;()&quot;</span>
                    <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span>

                <span class="n">func_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fmtfunc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">narg</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">narg</span> <span class="ow">in</span> <span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_completion_cache</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_keywords</span><span class="p">,</span> <span class="n">func_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_special_names</span><span class="p">,</span> <span class="n">collations</span><span class="p">,</span> <span class="n">databases</span><span class="p">,</span> <span class="n">other</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completion_cache</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_completion_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># be somewhat sensible about pragmas</span>
        <span class="k">if</span> <span class="s2">&quot;pragma &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prev_tokens</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">end</span><span class="p">)</span>

            <span class="c1"># pragma foo = bar</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pragma&quot;</span><span class="p">:</span>
                <span class="c1"># t[-2] should be a valid one</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">[]</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">)]</span>
            <span class="c1"># at equals?</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pragma&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">[]</span>
                        <span class="k">return</span> <span class="n">vals</span>
            <span class="c1"># pragma foo</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pragma&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">)]</span>
                <span class="n">res</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">res</span>

            <span class="c1"># pragma</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pragma&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pragmas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">res</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># This is currently not context sensitive (eg it doesn&#39;t look</span>
        <span class="c1"># to see if last token was &#39;FROM&#39; and hence next should only</span>
        <span class="c1"># be table names.  That is a SMOP like pragmas above</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ut</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">corpus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_cache</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">corpus</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ut</span><span class="p">):</span>
                    <span class="c1"># potential match - now match case</span>
                    <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>  <span class="c1"># exact</span>
                        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>  <span class="c1"># lower</span>
                        <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">word</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>  <span class="c1"># upper</span>
                        <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># match letter by letter otherwise readline mangles what was typed in</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">token</span> <span class="o">+</span> <span class="n">word</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">):]</span>
                        <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


    <span class="c1"># completion for the dot commands are messy because some take</span>
    <span class="c1"># variable numbers of parameters and the meanings of the</span>
    <span class="c1"># parameters differ depending on how many there are.  so</span>
    <span class="c1"># we make some effort for some of the commands</span>
    <span class="n">_command_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bail&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s2">&quot;changes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s2">&quot;echo&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s2">&quot;exceptions&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="s2">&quot;timer&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">_command_params</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_command_params</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span>

    <span class="n">_builtin_commands</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Shell.complete_command">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.complete_command">[docs]</a>
    <span class="k">def</span> <span class="nf">complete_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">beg</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide some completions for dot commands</span>

<span class="sd">        :param line: The current complete input line</span>
<span class="sd">        :param token: The word readline is looking for matches</span>
<span class="sd">        :param beg: Integer offset of token in line</span>
<span class="sd">        :param end: Integer end of token in line</span>
<span class="sd">        :return: A list of completions, or an empty list if none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builtin_commands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_builtin_commands</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;command_&quot;</span><span class="p">):]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;command_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;command_headers&quot;</span>
            <span class="p">]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prev_tokens</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builtin_commands</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">)]</span>

        <span class="n">completions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;colour&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">}:</span>
            <span class="n">completions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">}:</span>
            <span class="n">completions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_modes</span>
        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span>
            <span class="n">completions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_builtin_commands</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dbconfig&quot;</span><span class="p">:</span>
            <span class="n">completions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">v</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;SQLITE_DBCONFIG_&quot;</span><span class="p">):]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_db_config</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbconfig_ignore</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;parameter&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">token</span><span class="p">):</span>
                <span class="n">completions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clear&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;unset &quot;</span><span class="p">,</span> <span class="s2">&quot;set &quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unset&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">token</span><span class="p">):</span>
                <span class="n">completions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">completions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="s2">&quot;OFF&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_params</span><span class="p">:</span>
            <span class="n">completions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_params</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">completions</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">token</span><span class="p">]</span></div>


<div class="viewcode-block" id="Shell.get_resource_usage">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.get_resource_usage">[docs]</a>
    <span class="k">def</span> <span class="nf">get_resource_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of various numbers (ints or floats).  The</span>
<span class="sd">        .timer command shows the difference between before and after</span>
<span class="sd">        results of what this returns by calling :meth:`display_timing`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ctypes</span>
            <span class="kn">import</span> <span class="nn">platform</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetProcessTimes</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">platform</span><span class="o">.</span><span class="n">architecture</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;64bit&#39;</span> <span class="ow">and</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int64</span> <span class="ow">or</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>
            <span class="p">]</span>

            <span class="c1"># All 4 out params have to be present.  FILETIME is really</span>
            <span class="c1"># just a 64 bit quantity in 100 nanosecond granularity</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulonglong</span><span class="p">()</span>
            <span class="n">utime</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulonglong</span><span class="p">()</span>
            <span class="n">stime</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulonglong</span><span class="p">()</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetProcessTimes</span><span class="p">(</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">(),</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">dummy</span><span class="p">),</span>  <span class="c1"># creation time</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">dummy</span><span class="p">),</span>  <span class="c1"># exit time</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">stime</span><span class="p">),</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">utime</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rc</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;Wall clock&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                    <span class="s1">&#39;User time&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">utime</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000000</span><span class="p">,</span>
                    <span class="s1">&#39;System time&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">stime</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000000</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">resource</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Wall clock&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;utime&quot;</span><span class="p">,</span> <span class="s2">&quot;User time&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;stime&quot;</span><span class="p">,</span> <span class="s2">&quot;System time&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;maxrss&quot;</span><span class="p">,</span> <span class="s2">&quot;Max rss&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;idrss&quot;</span><span class="p">,</span> <span class="s2">&quot;Memory&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;isrss&quot;</span><span class="p">,</span> <span class="s2">&quot;Stack&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ixrss&quot;</span><span class="p">,</span> <span class="s2">&quot;Shared Memory&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;minflt&quot;</span><span class="p">,</span> <span class="s2">&quot;PF (no I/O)&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;majflt&quot;</span><span class="p">,</span> <span class="s2">&quot;PF (I/O)&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;inblock&quot;</span><span class="p">,</span> <span class="s2">&quot;Blocks in&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;oublock&quot;</span><span class="p">,</span> <span class="s2">&quot;Blocks out&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;nsignals&quot;</span><span class="p">,</span> <span class="s2">&quot;Signals&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;nvcsw&quot;</span><span class="p">,</span> <span class="s2">&quot;Voluntary context switches&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;nivcsw&quot;</span><span class="p">,</span> <span class="s2">&quot;Involunary context switches&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;msgrcv&quot;</span><span class="p">,</span> <span class="s2">&quot;Messages received&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;msgsnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Messages sent&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;nswap&quot;</span><span class="p">,</span> <span class="s2">&quot;Swaps&quot;</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;ru_&quot;</span> <span class="o">+</span> <span class="n">i</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Shell.display_timing">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.display_timing">[docs]</a>
    <span class="k">def</span> <span class="nf">display_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the difference between before and after to self.stderr.</span>
<span class="sd">        The data is dictionaries returned from</span>
<span class="sd">        :meth:`get_resource_usage`.&quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">before</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">after</span><span class="p">:</span>
                <span class="n">one</span> <span class="o">=</span> <span class="n">before</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">two</span> <span class="o">=</span> <span class="n">after</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">two</span> <span class="o">-</span> <span class="n">one</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;+ </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.4f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;+ </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span></div>


    <span class="c1">### Output helpers</span>
<div class="viewcode-block" id="Shell.Row">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.Row">[docs]</a>
    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="o">**</span><span class="p">({</span><span class="s2">&quot;slots&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;frozen&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}))</span>
    <span class="k">class</span> <span class="nc">Row</span><span class="p">:</span>
        <span class="s2">&quot;Returned by :class:`Shell.PositionRow`&quot;</span>
        <span class="n">is_first</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">is_last</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">row</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValues</span>
        <span class="n">columns</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span></div>


<div class="viewcode-block" id="Shell.PositionRow">
<a class="viewcode-back" href="../../shell.html#apsw.shell.Shell.PositionRow">[docs]</a>
    <span class="k">class</span> <span class="nc">PositionRow</span><span class="p">:</span>
        <span class="s2">&quot;Wraps an iterator so you know if a row is first, last, both, or neither&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">get_description</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ExecutionCompleteError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">StopIteration</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">is_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">is_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">is_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">Shell</span><span class="o">.</span><span class="n">Row</span><span class="p">(</span><span class="n">is_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div>


    <span class="c1">### Colour support</span>

    <span class="k">def</span> <span class="nf">_out_colour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Sets up color for output.  Input being interactive doesn&#39;t</span>
        <span class="c1"># matter.  This method needs to be called on all changes to</span>
        <span class="c1"># output.</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;isatty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">colour_scheme</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colours</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">]</span>

    <span class="c1"># This class returns an empty string for all undefined attributes</span>
    <span class="c1"># so that it doesn&#39;t matter if a colour scheme leaves something</span>
    <span class="c1"># out.</span>
    <span class="k">class</span> <span class="nc">_colourscheme</span><span class="p">:</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;_colourscheme(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">colour_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">formatted</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colour</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnull</span> <span class="o">+</span> <span class="n">formatted</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnull_</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vstring</span> <span class="o">+</span> <span class="n">formatted</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vstring_</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vblob</span> <span class="o">+</span> <span class="n">formatted</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vblob_</span>
            <span class="c1"># must be a number - we don&#39;t distinguish between float/int</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnumber</span> <span class="o">+</span> <span class="n">formatted</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnumber_</span>

    <span class="c1"># The colour definitions - the convention is the name to turn</span>
    <span class="c1"># something on and the name with an underscore suffix to turn it</span>
    <span class="c1"># off</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">_colourscheme</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">([(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;reset&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;underline&quot;</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">:</span> <span class="s2">&quot;bold_&quot;</span><span class="p">,</span>
        <span class="mi">24</span><span class="p">:</span> <span class="s2">&quot;underline_&quot;</span><span class="p">,</span>
        <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;inverse&quot;</span><span class="p">,</span>
        <span class="mi">27</span><span class="p">:</span> <span class="s2">&quot;inverse_&quot;</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">:</span> <span class="s2">&quot;fg_black&quot;</span><span class="p">,</span>
        <span class="mi">31</span><span class="p">:</span> <span class="s2">&quot;fg_red&quot;</span><span class="p">,</span>
        <span class="mi">32</span><span class="p">:</span> <span class="s2">&quot;fg_green&quot;</span><span class="p">,</span>
        <span class="mi">33</span><span class="p">:</span> <span class="s2">&quot;fg_yellow&quot;</span><span class="p">,</span>
        <span class="mi">34</span><span class="p">:</span> <span class="s2">&quot;fg_blue&quot;</span><span class="p">,</span>
        <span class="mi">35</span><span class="p">:</span> <span class="s2">&quot;fg_magenta&quot;</span><span class="p">,</span>
        <span class="mi">36</span><span class="p">:</span> <span class="s2">&quot;fg_cyan&quot;</span><span class="p">,</span>
        <span class="mi">37</span><span class="p">:</span> <span class="s2">&quot;fg_white&quot;</span><span class="p">,</span>
        <span class="mi">39</span><span class="p">:</span> <span class="s2">&quot;fg_&quot;</span><span class="p">,</span>
        <span class="mi">40</span><span class="p">:</span> <span class="s2">&quot;bg_black&quot;</span><span class="p">,</span>
        <span class="mi">41</span><span class="p">:</span> <span class="s2">&quot;bg_red&quot;</span><span class="p">,</span>
        <span class="mi">42</span><span class="p">:</span> <span class="s2">&quot;bg_green&quot;</span><span class="p">,</span>
        <span class="mi">43</span><span class="p">:</span> <span class="s2">&quot;bg_yellow&quot;</span><span class="p">,</span>
        <span class="mi">44</span><span class="p">:</span> <span class="s2">&quot;bg_blue&quot;</span><span class="p">,</span>
        <span class="mi">45</span><span class="p">:</span> <span class="s2">&quot;bg_magenta&quot;</span><span class="p">,</span>
        <span class="mi">46</span><span class="p">:</span> <span class="s2">&quot;bg_cyan&quot;</span><span class="p">,</span>
        <span class="mi">47</span><span class="p">:</span> <span class="s2">&quot;bg_white&quot;</span><span class="p">,</span>
        <span class="mi">49</span><span class="p">:</span> <span class="s2">&quot;bg_&quot;</span>
    <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>

    <span class="n">_colours</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;off&quot;</span><span class="p">:</span> <span class="n">_colourscheme</span><span class="p">(</span><span class="n">colour_value</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="p">)}</span>

    <span class="n">_colours</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_colourscheme</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bold</span><span class="p">,</span>
                                        <span class="n">prompt_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bold_</span><span class="p">,</span>
                                        <span class="n">error</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_red</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">bold</span><span class="p">,</span>
                                        <span class="n">error_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bold_</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">intro</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_blue</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">bold</span><span class="p">,</span>
                                        <span class="n">intro_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bold_</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">transient</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_green</span><span class="p">,</span>
                                        <span class="n">transient_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">summary</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_blue</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">bold</span><span class="p">,</span>
                                        <span class="n">summary_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">bold_</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">header</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">underline</span><span class="p">,</span>
                                        <span class="n">header_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">underline_</span><span class="p">,</span>
                                        <span class="n">vnull</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_red</span><span class="p">,</span>
                                        <span class="n">vnull_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">vstring</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_yellow</span><span class="p">,</span>
                                        <span class="n">vstring_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">vblob</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_blue</span><span class="p">,</span>
                                        <span class="n">vblob_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">,</span>
                                        <span class="n">vnumber</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_magenta</span><span class="p">,</span>
                                        <span class="n">vnumber_</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">fg_</span><span class="p">)</span>
    <span class="c1"># unpollute namespace</span>
    <span class="k">del</span> <span class="n">d</span>
    <span class="k">del</span> <span class="n">_colourscheme</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">n</span>
        <span class="k">del</span> <span class="n">x</span>
        <span class="k">del</span> <span class="n">v</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../shell.html#apsw.shell.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Docstring must start on second line so dedenting works correctly</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call this to run the :ref:`interactive shell &lt;shell&gt;`.  It</span>
<span class="sd">    automatically passes in sys.argv[1:] and exits Python when done.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Shell</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">process_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cmdloop</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;_handle_exception_saw_this&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Where did this exception come from?</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2004-2024, Roger Binns &lt;rogerb@rogerbinns.com&gt;.
      <span class="lastupdated">Last updated on Aug 13, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2NR9GDCQLT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2NR9GDCQLT', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>