

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apsw.unicode &mdash; APSW 3.47.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=72bcf2f2" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/apsw.css?v=3c7e2631" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8087e674"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            APSW
              <img src="../../_static/apswlogo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation and customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bestpractice.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apsw.html">APSW Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connection.html">Connections to a database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cursor.html">Cursors (executing SQL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../blob.html">Blob Input/Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backup.html">Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example-fts.html">Full Text Search Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../textsearch.html">Full text search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vtable.html">Virtual Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vfs.html">Virtual File System (VFS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ext.html">Various interesting and useful bits of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exceptions.html">Exceptions and Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../execution.html">Execution and tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dbapi.html">DBAPI notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pysqlite.html">sqlite3 module differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">APSW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../apsw.html">apsw</a></li>
      <li class="breadcrumb-item active">apsw.unicode</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for apsw.unicode</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:mod:`apsw.unicode` - Up to date Unicode aware methods and lookups</span>

<span class="sd">This module helps with :doc:`textsearch` and general Unicode,</span>
<span class="sd">addressing the following:</span>

<span class="sd">* The standard library :mod:`unicodedata` has limited information</span>
<span class="sd">  available (eg no information about emoji), and is only updated to</span>
<span class="sd">  new `Unicode versions</span>
<span class="sd">  &lt;https://www.unicode.org/versions/enumeratedversions.html&gt;`__ on a</span>
<span class="sd">  new Python version.</span>

<span class="sd">* Multiple consecutive codepoints can combine into a single user</span>
<span class="sd">  perceived character (grapheme cluster), such as combining accents,</span>
<span class="sd">  vowels and marks in some writing systems, variant selectors, joiners</span>
<span class="sd">  and linkers, etc.  That means you can&#39;t use indexes into</span>
<span class="sd">  :class:`str` safely without potentially breaking them.</span>

<span class="sd">* The standard library provides no help in splitting text into</span>
<span class="sd">  grapheme clusters, words, and sentences, or into breaking text into</span>
<span class="sd">  multiple lines.</span>

<span class="sd">* Text processing is performance sensitive - FTS5 easily handles</span>
<span class="sd">  hundreds of megabytes to gigabytes of text, and so should this</span>
<span class="sd">  module.  It also affects the latency of each query as that is</span>
<span class="sd">  tokenized, and results can highlight words and sentences.</span>

<span class="sd">This module is independent of the main apsw module, and loading it</span>
<span class="sd">does not load any database functionality.  The majority of the</span>
<span class="sd">functionality is implemented in C for size and performance reasons.</span>

<span class="sd">See :data:`unicode_version` for the implemented version.</span>

<span class="sd">Grapheme cluster, word, and sentence splitting</span>

<span class="sd">    `Unicode Technical Report #29</span>
<span class="sd">    &lt;https://www.unicode.org/reports/tr29/&gt;`__ rules for finding</span>
<span class="sd">    grapheme clusters, words, and sentences are implemented.  Tr29</span>
<span class="sd">    specifies break points which can be found via</span>
<span class="sd">    :func:`grapheme_next_break`, :func:`word_next_break`, and</span>
<span class="sd">    :func:`sentence_next_break`.</span>

<span class="sd">    Building on those are iterators providing optional offsets and the</span>
<span class="sd">    text.  This is used for tokenization (getting character and word</span>
<span class="sd">    boundaries correct), and for result highlighting (showing</span>
<span class="sd">    words/sentences before and after match).</span>

<span class="sd">Line break splitting</span>

<span class="sd">    `Unicode Technical Report #14</span>
<span class="sd">    &lt;https://www.unicode.org/reports/tr14/&gt;`__ rules for finding where</span>
<span class="sd">    text cam be broken and resumed on the next line.  Tr14 specifies</span>
<span class="sd">    break points which can be found via :func:`line_break_next_break`.</span>

<span class="sd">    Building on those are iterators providing optional offsets and the</span>
<span class="sd">    text.  This is used for :func:`text_wrap`.</span>

<span class="sd">Unicode lookups</span>

<span class="sd">   * Category information :func:`category`</span>
<span class="sd">   * Is an emoji or similar :func:`is_extended_pictographic`</span>
<span class="sd">   * Flag characters :func:`is_regional_indicator`</span>
<span class="sd">   * Codepoint names :func:`codepoint_name`</span>

<span class="sd">Case folding, accent removal</span>

<span class="sd">   * :func:`casefold` is used to do case insensitive comparisons.</span>
<span class="sd">   * :func:`strip` is used to remove accents, marks, punctuation,</span>
<span class="sd">     joiners etc</span>

<span class="sd">Helpers</span>

<span class="sd">These are aware of grapheme cluster boundaries which Python&#39;s builtin</span>
<span class="sd">string operations are not.  The text width functions take into account</span>
<span class="sd">how wide the text is when displayed on most terminals.</span>

<span class="sd">    * :func:`grapheme_length` to get the number of grapheme clusters</span>
<span class="sd">      in a string</span>
<span class="sd">    * :func:`grapheme_substr` to get substrings using grapheme cluster</span>
<span class="sd">      indexing</span>
<span class="sd">    * :func:`grapheme_startswith` and :func:`grapheme_endswith`</span>
<span class="sd">    * :func:`grapheme_find` to find a substring</span>
<span class="sd">    * :func:`split_lines` to split text into lines using all the</span>
<span class="sd">      Unicode hard line break codepoints</span>
<span class="sd">    * :func:`text_width` to count how wide the text is</span>
<span class="sd">    * :func:`expand_tabs` to expand tabs using text width</span>
<span class="sd">    * :func:`text_width_substr` to extract substrings based on text width</span>
<span class="sd">    * :func:`text_wrap` to wrap paragraphs using Unicode words, line</span>
<span class="sd">      breaking, and text width</span>
<span class="sd">    * :func:`guess_paragraphs` to establish paragraph boundaries for</span>
<span class="sd">      text that has line breaks in paragraphs like many plain text</span>
<span class="sd">      and similar markup formats.</span>

<span class="sd">Size</span>

<span class="sd">    Using the `ICU &lt;https://icu.unicode.org/&gt;`__ `extension</span>
<span class="sd">    &lt;https://pypi.org/project/PyICU/&gt;`__ is 5MB of code that then</span>
<span class="sd">    links to shared libraries containing another 5MB of code, and 30MB</span>
<span class="sd">    of data.  This module is 0.5MB, 5 to 50% faster, and has no</span>
<span class="sd">    dependencies.  (ICU includes numerous extra customisations,</span>
<span class="sd">    formatting, locale helpers etc.)</span>

<span class="sd">Performance</span>

<span class="sd">    There some pure Python alternatives, with less functionality.</span>
<span class="sd">    They take 5 to 15 times more CPU time to process the same text.</span>
<span class="sd">    Use ``python3 -m apsw.unicode benchmark --help``.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="c1">### BEGIN UNICODE UPDATE SECTION ###</span>
<span class="n">unicode_version</span> <span class="o">=</span> <span class="s2">&quot;16.0&quot;</span>
<span class="sd">&quot;&quot;&quot;The `Unicode version &lt;https://www.unicode.org/versions/enumeratedversions.html&gt;`__</span>
<span class="sd">that the rules and data tables implement&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">_Category</span><span class="p">:</span>
    <span class="n">Cc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">0</span>
    <span class="n">Cf</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">1</span>
    <span class="n">Cn</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Co</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">Cs</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">4</span>
    <span class="n">Extended_Pictographic</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">5</span>
    <span class="n">Ll</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">Lm</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">7</span>
    <span class="n">Lo</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span>
    <span class="n">Lt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">9</span>
    <span class="n">Lu</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span>
    <span class="n">Mc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">11</span>
    <span class="n">Me</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">12</span>
    <span class="n">Mn</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">13</span>
    <span class="n">Nd</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">14</span>
    <span class="n">Nl</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">15</span>
    <span class="n">No</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">16</span>
    <span class="n">Pc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">17</span>
    <span class="n">Pd</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">18</span>
    <span class="n">Pe</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">19</span>
    <span class="n">Pf</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span>
    <span class="n">Pi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">21</span>
    <span class="n">Po</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">22</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">23</span>
    <span class="n">Regional_Indicator</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">24</span>
    <span class="n">Sc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">25</span>
    <span class="n">Sk</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">26</span>
    <span class="n">Sm</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">27</span>
    <span class="n">So</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">28</span>
    <span class="n">WIDTH_INVALID</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">29</span>
    <span class="n">WIDTH_TWO</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span>
    <span class="n">WIDTH_ZERO</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span>
    <span class="n">Zl</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>
    <span class="n">Zp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">33</span>
    <span class="n">Zs</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">34</span>


<span class="c1">### END UNICODE UPDATE SECTION ###</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_unicode</span>

<span class="k">assert</span> <span class="n">unicode_version</span> <span class="o">==</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">unicode_version</span>
<span class="n">_unicode_category</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">category_category</span>


<div class="viewcode-block" id="category">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.category">[docs]</a>
<span class="k">def</span> <span class="nf">category</span><span class="p">(</span><span class="n">codepoint</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the `general category &lt;https://en.wikipedia.org/wiki/Unicode_character_property#General_Category&gt;`__ - eg ``Lu`` for Letter Uppercase</span>

<span class="sd">    See :data:`apsw.fts5.unicode_categories` for descriptions mapping&quot;&quot;&quot;</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">_unicode_category</span><span class="p">(</span><span class="n">codepoint</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lu</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Lu&quot;</span>  <span class="c1"># Letter Uppercase</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Ll</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Ll&quot;</span>  <span class="c1"># Letter Lowercase</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lt</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Lt&quot;</span>  <span class="c1"># Letter Titlecase</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lm</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Lm&quot;</span>  <span class="c1"># Letter Modifier</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lo</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Lo&quot;</span>  <span class="c1"># Letter Other</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Mn</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Mn&quot;</span>  <span class="c1"># Mark NonSpacing</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Mc</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Mc&quot;</span>  <span class="c1"># Mark SpacingCombining</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Me</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Me&quot;</span>  <span class="c1"># Mark Enclosing</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Nd</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Nd&quot;</span>  <span class="c1"># Number DecimalDigit</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Nl</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Nl&quot;</span>  <span class="c1"># Number Letter</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;No&quot;</span>  <span class="c1"># Number Other</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pc</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Pc&quot;</span>  <span class="c1"># Punctuation Connector</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pd</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Pd&quot;</span>  <span class="c1"># Punctuation Dash</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Ps</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Ps&quot;</span>  <span class="c1"># Punctuation Open</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pe</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Pe&quot;</span>  <span class="c1"># Punctuation Close</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pi</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Pi&quot;</span>  <span class="c1"># Punctuation InitialQuote</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pf</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Pf&quot;</span>  <span class="c1"># Punctuation FinalQuote</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Po</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Po&quot;</span>  <span class="c1"># Punctuation Other</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Sm</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Sm&quot;</span>  <span class="c1"># Symbol Math</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Sc</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Sc&quot;</span>  <span class="c1"># Symbol Currency</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Sk</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Sk&quot;</span>  <span class="c1"># Symbol Modifier</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">So</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;So&quot;</span>  <span class="c1"># Symbol Other</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Zs</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Zs&quot;</span>  <span class="c1"># Separator Space</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Zl</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Zl&quot;</span>  <span class="c1"># Separator Line</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Zp</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Zp&quot;</span>  <span class="c1"># Separator Paragraph</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cc</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Cc&quot;</span>  <span class="c1"># Other Control</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cf</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Cf&quot;</span>  <span class="c1"># Other Format</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cs</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Cs&quot;</span>  <span class="c1"># Other Surrogate</span>
    <span class="k">elif</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Co</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Co&quot;</span>  <span class="c1"># Other PrivateUse</span>
    <span class="k">assert</span> <span class="n">cat</span> <span class="o">&amp;</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cn</span>
    <span class="k">return</span> <span class="s2">&quot;Cn&quot;</span>  <span class="c1"># Other NotAssigned</span></div>



<div class="viewcode-block" id="is_extended_pictographic">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.is_extended_pictographic">[docs]</a>
<span class="k">def</span> <span class="nf">is_extended_pictographic</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s2">&quot;Returns True if any of the text has the extended pictographic property (Emoji and similar)&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">has_category</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Extended_Pictographic</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_regional_indicator">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.is_regional_indicator">[docs]</a>
<span class="k">def</span> <span class="nf">is_regional_indicator</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s2">&quot;Returns True if any of the text is one of the 26 `regional indicators &lt;https://en.wikipedia.org/wiki/Regional_indicator_symbol&gt;`__ used in pairs to represent country flags&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">has_category</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Regional_Indicator</span><span class="p">)</span></div>



<div class="viewcode-block" id="casefold">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.casefold">[docs]</a>
<span class="k">def</span> <span class="nf">casefold</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the text for equality comparison without case distinction</span>

<span class="sd">    Case folding maps text to a canonical form where case differences</span>
<span class="sd">    are removed allowing case insensitive comparison.  Unlike upper,</span>
<span class="sd">    lower, and title case, the result is not intended to be displayed</span>
<span class="sd">    to people.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">casefold</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>



<div class="viewcode-block" id="strip">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.strip">[docs]</a>
<span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the text for less exact comparison with accents, punctuation, marks etc removed</span>

<span class="sd">    It will strip diacritics leaving the underlying characters so ``Ã¡Ã§Ã§Ã©Ã±È›Å›`` becomes ``accents``,</span>
<span class="sd">    punctuation so ``e.g.`` becomes ``eg`` and ``don&#39;t`` becomes ``dont``,  marks so ``à¤¦à¥‡à¤µà¤¨à¤¾à¤—à¤°à¥€``</span>
<span class="sd">    becomes ``à¤¦à¤µà¤¨à¤—à¤°``, as well as all spacing, formatting, `variation selectors</span>
<span class="sd">    &lt;https://en.wikipedia.org/wiki/Variation_Selectors_%28Unicode_block%29&gt;`__ and similar codepoints.</span>

<span class="sd">    Codepoints are also converted to their compatibility representation.  For example</span>
<span class="sd">    the single codepoint Roman numeral ``â…¢`` becomes ``III`` (three separate regular upper case `I`),</span>
<span class="sd">    and ``ðŸ„·ðŸ„´ðŸ„»ðŸ„»ðŸ„¾`` becomes ``HELLO``.</span>

<span class="sd">    The resulting text should not be shown to people, and is intended for doing relaxed equality</span>
<span class="sd">    comparisons, at the expense of false positives when the accents, marks, punctuation etc were</span>
<span class="sd">    intended.</span>

<span class="sd">    You should do :func:`case folding &lt;casefold&gt;` after this.</span>

<span class="sd">    Emoji are preserved but variation selectors, `fitzpatrick &lt;https://en.wikipedia.org/wiki/Emoji#Skin_color&gt;`__</span>
<span class="sd">    and `joiners &lt;https://en.wikipedia.org/wiki/Zero-width_joiner&gt;`__ are stripped.</span>

<span class="sd">    `Regional indicators &lt;https://en.wikipedia.org/wiki/Regional_indicator_symbol&gt;`__ are preserved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>



<div class="viewcode-block" id="split_lines">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.split_lines">[docs]</a>
<span class="k">def</span> <span class="nf">split_lines</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Each line, using hard line break rules</span>

<span class="sd">    This is a iterator yielding a line at a time.  The end of line</span>
<span class="sd">    yielded will not include the hard line break characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">line_next_hard_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hard</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="n">hard</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">hard_breaks</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">end</span> <span class="o">+</span> <span class="n">hard</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># it was entirely hard break chars</span>
            <span class="k">yield</span> <span class="s2">&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="expand_tabs">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.expand_tabs">[docs]</a>
<span class="k">def</span> <span class="nf">expand_tabs</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">invalid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turns tabs into spaces aligning on tabsize boundaries, similar to :meth:`str.expandtabs`</span>

<span class="sd">    This is aware of grapheme clusters and text width.  Codepoints</span>
<span class="sd">    that have an invalid width are also replaced by ``invalid``.</span>
<span class="sd">    Control characters are an example of an invalid character.  Line</span>
<span class="sd">    breaks are replaced with newline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">split_lines</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="c1"># short cut</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">text_width</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># work on it cluster by cluster</span>
        <span class="n">clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grapheme_iter</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gr</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">gr</span> <span class="o">=</span> <span class="n">invalid</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">w</span>
                <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># str.expandtabs allows zero and negative numbers</span>
                <span class="n">incr</span> <span class="o">=</span> <span class="n">tabsize</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos</span> <span class="o">%</span> <span class="n">tabsize</span><span class="p">)</span> <span class="k">if</span> <span class="n">tabsize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">incr</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="n">incr</span>

        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="grapheme_length">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_length">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_length</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="s2">&quot;Returns number of grapheme clusters in the text.  Unicode aware version of len&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_length</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>



<div class="viewcode-block" id="grapheme_substr">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_substr">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_substr</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Like ``text[start:end]`` but in grapheme cluster units</span>

<span class="sd">    ``start`` and ``end`` can be negative to index from the end, or</span>
<span class="sd">    outside the bounds of the text but are never an invalid</span>
<span class="sd">    combination (you get empty string returned).</span>

<span class="sd">    To get one grapheme cluster, make stop one more than start.</span>
<span class="sd">    For example to get the 3rd last grapheme cluster::</span>

<span class="sd">        grapheme_substr(text, -3, -3 + 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_substr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span></div>



<div class="viewcode-block" id="grapheme_endswith">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_endswith">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_endswith</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">substring</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s2">&quot;Returns True if `text` ends with `substring` being aware of grapheme cluster boundaries&quot;</span>
    <span class="c1"># match str.endswith</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">substring</span><span class="p">):</span>
        <span class="c1"># it must end with the same codepoints, but also has to start at</span>
        <span class="c1"># a grapheme cluster boundary</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">boundary</span> <span class="o">&lt;</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">boundary</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">boundary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">boundary</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="grapheme_startswith">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_startswith">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_startswith</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">substring</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s2">&quot;Returns True if `text` starts with `substring` being aware of grapheme cluster boundaries&quot;</span>
    <span class="c1"># match str.startswith</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">substring</span><span class="p">):</span>
        <span class="c1"># it must start with the same codepoints, but also has to end at</span>
        <span class="c1"># a grapheme cluster boundary</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">boundary</span> <span class="o">&lt;</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">boundary</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">boundary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">boundary</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="grapheme_find">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_find">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_find</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">substring</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the offset in text where substring can be found, being aware of grapheme clusters.</span>
<span class="sd">    The start and end of the substring have to be at a grapheme cluster boundary.</span>

<span class="sd">    :param start: Where in text to start the search (default beginning)</span>
<span class="sd">    :param end: Where to stop the search exclusive (default remaining text)</span>
<span class="sd">    :returns: offset into text, or -1 if not found or substring is zero length</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># C version is 7.5X faster than Python version</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_find</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">substring</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span></div>



<div class="viewcode-block" id="text_width">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.text_width">[docs]</a>
<span class="k">def</span> <span class="nf">text_width</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns how many columns the text would be if displayed in a terminal</span>

<span class="sd">    You should :func:`split_lines` first and then operate on each line</span>
<span class="sd">    separately.</span>

<span class="sd">    If the `text` contains new lines, control characters, and similar</span>
<span class="sd">    unrepresentable codepoints then minus 1 is returned.</span>

<span class="sd">    Terminals aren&#39;t entirely consistent with each other, and Unicode</span>
<span class="sd">    has many kinds of codepoints, and combinations.  Consequently this</span>
<span class="sd">    is right the vast majority of the time, but not always.</span>

<span class="sd">    Note that web browsers do variable widths even in monospaced</span>
<span class="sd">    sections like ``&lt;pre&gt;`` so they won&#39;t always agree with the terminal</span>
<span class="sd">    either.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Some benchmarks in seconds running on 45MB of the UNDR</span>
    <span class="c1"># 8.34  wcwidth Python module</span>
    <span class="c1"># 8.14  The implementation of this in Python</span>
    <span class="c1"># 0.20  Calling libc wcswidth via ctypes</span>
    <span class="c1"># 0.14  The Python converted to C</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">text_width</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>



<div class="viewcode-block" id="text_width_substr">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.text_width_substr">[docs]</a>
<span class="k">def</span> <span class="nf">text_width_substr</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts substring width or less wide being aware of grapheme cluster boundaries.</span>
<span class="sd">    For example you could use this to get a substring that is 80 (or</span>
<span class="sd">    less) wide.</span>

<span class="sd">    :returns: A tuple of how wide the substring is, and the substring&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;width must be an int at least 1&quot;</span><span class="p">)</span>
    <span class="n">width_so_far</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">accepted</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">grapheme</span> <span class="ow">in</span> <span class="n">grapheme_iter_with_offsets</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="n">seg_width</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">(</span><span class="n">grapheme</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seg_width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;text contains invalid codepoints </span><span class="si">{</span><span class="n">grapheme</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width_so_far</span> <span class="o">+</span> <span class="n">seg_width</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
            <span class="n">width_so_far</span> <span class="o">+=</span> <span class="n">seg_width</span>
            <span class="n">accepted</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">width_so_far</span> <span class="o">==</span> <span class="n">width</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">width_so_far</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">accepted</span><span class="p">]</span></div>



<div class="viewcode-block" id="guess_paragraphs">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.guess_paragraphs">[docs]</a>
<span class="k">def</span> <span class="nf">guess_paragraphs</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given text that contains paragraphs containing newlines, guesses where the paragraphs end.</span>
<span class="sd">    The returned :class:`str` will have ``\n`` removed where it was</span>
<span class="sd">    determined to not mark a paragraph end.</span>

<span class="sd">    .. code-block:: output</span>

<span class="sd">        If you have text like this, where paragraphs have newlines in</span>
<span class="sd">        them, then each line gets wrapped separately by text_wrap.</span>
<span class="sd">        This function tries to guess where the paragraphs end.</span>

<span class="sd">        Blank lines like above are definite.</span>
<span class="sd">          Indented lines that continue preserving the indent</span>
<span class="sd">          are considered the same paragraph, and a change of indent</span>
<span class="sd">          (in or out) is a new paragraph.</span>
<span class="sd">            So this will be a new paragraph,</span>
<span class="sd">        And this will be a new paragraph.</span>

<span class="sd">         * Punctuation/numbers at the start of line</span>
<span class="sd">           followed by indented text are considered the same</span>
<span class="sd">           paragraph</span>
<span class="sd">        2. So this is a new paragraph, while</span>
<span class="sd">           this line is part of the line above</span>

<span class="sd">        3. Optional numbers followed by punctuation then space</span>
<span class="sd">        - are considered new paragraphs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># regex to match what looks like an (optionally numbered) list</span>
    <span class="c1"># item</span>
    <span class="n">list_item_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(?P&lt;indent&gt;\s*[0-9+=,\.*:-]+\s+).*&quot;</span>

    <span class="c1"># what we turn definite end of paragraph into</span>
    <span class="n">parasep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\u2029</span><span class="s2">&quot;</span>

    <span class="c1"># Force unicode end of line, form feed, next line to parasep</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u2028</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parasep</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u000d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parasep</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u0085</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parasep</span><span class="p">)</span>

    <span class="c1"># tabify</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_tabs</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">)</span>

    <span class="c1"># Fix Windows EOL</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Any stray CR become parasep</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parasep</span><span class="p">)</span>

    <span class="c1"># Two newlines is definite</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parasep</span> <span class="o">+</span> <span class="n">parasep</span><span class="p">)</span>

    <span class="n">paragraphs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">append_paragraph</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># appends the list of strings as a paragraph</span>
        <span class="c1"># but we have to strip any indent from second and</span>
        <span class="c1"># succeeding line</span>
        <span class="n">not_first</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">paragraphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">not_first</span><span class="p">))</span>

    <span class="c1"># each segment is one or more paragraphs</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">parasep</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">segment</span><span class="p">:</span>
            <span class="n">paragraphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">para</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">segment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">para</span><span class="p">:</span>
                <span class="c1"># this is definitely a new paragraph</span>
                <span class="n">para</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># optional spaces, followed by digits|punctuation followed by space</span>
            <span class="c1"># is considered a new paragraph as a list item.</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">list_item_re</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">para</span><span class="p">:</span>
                    <span class="n">append_paragraph</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
                <span class="n">para</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="c1"># Does indent match previous line</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)):</span>
                <span class="n">para</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Does indent match previous line as a list item indent?</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">list_item_re</span><span class="p">,</span> <span class="n">para</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;indent&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)):</span>
                    <span class="n">para</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1"># new paragraph</span>
            <span class="n">append_paragraph</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
            <span class="n">para</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">para</span><span class="p">:</span>
            <span class="n">append_paragraph</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>

    <span class="c1"># turn back into newline as the expected delimiter</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="text_wrap">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.text_wrap">[docs]</a>
<span class="k">def</span> <span class="nf">text_wrap</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">tabsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">hyphen</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">combine_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">invalid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Similar to :func:`textwrap.wrap` but Unicode grapheme cluster and line break aware</span>

<span class="sd">    .. note::</span>

<span class="sd">       Newlines in the text are treated as end of paragraph.  If your text has paragraphs</span>
<span class="sd">       with newlines in them, then call :func:`guess_paragraphs` first.</span>

<span class="sd">    :param text: string to process</span>
<span class="sd">    :param width: width of yielded lines, if rendered using a monospace font such as to a terminal</span>
<span class="sd">    :param tabsize: Tab stop spacing as tabs are expanded</span>
<span class="sd">    :param hyphen: Used to show a segment was broken because it was wider than ``width``</span>
<span class="sd">    :param combine_space: Leading space on each (indent) is always preserved.  Other spaces where</span>
<span class="sd">          multiple occur are combined into one space.</span>
<span class="sd">    :param invalid: If invalid codepoints are encountered such as control characters and surrogates</span>
<span class="sd">          then they are replaced with this.</span>

<span class="sd">    This yields one line of :class:`str` at a time, which will be</span>
<span class="sd">    exactly ``width`` when output to a terminal.  It will be right</span>
<span class="sd">    padded with spaces if necessary and not have a trailing newline.</span>

<span class="sd">    :func:`apsw.ext.format_query_table` uses this method to ensure</span>
<span class="sd">    each column is the desired width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hyphen_width</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">(</span><span class="n">hyphen</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_tabs</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">,</span> <span class="n">invalid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">split_lines</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">accumulated</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">space</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">line_break_iter</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)))</span> <span class="k">if</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">hyphen_width</span><span class="p">:</span>
                    <span class="c1"># make space for double width char if indent wider than width</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="n">indent</span><span class="p">[:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">hyphen_width</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
                <span class="n">accumulated</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent</span><span class="p">]</span>
                <span class="n">line_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line_width</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span>  <span class="c1"># there was spaces and text</span>
                        <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="n">line_width</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

            <span class="k">if</span> <span class="n">combine_space</span><span class="p">:</span>
                <span class="n">new_segment</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">new_space</span> <span class="o">=</span> <span class="n">new_segment</span> <span class="o">!=</span> <span class="n">segment</span>
                <span class="c1"># we want to prepend a space if the previous segment</span>
                <span class="c1"># ended in space</span>
                <span class="n">segment</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="n">space</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_segment</span>
                <span class="n">space</span> <span class="o">=</span> <span class="n">new_space</span>

            <span class="n">seg_width</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">seg_width</span> <span class="o">&gt;=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="n">line_width</span> <span class="o">+</span> <span class="n">seg_width</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accumulated</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only indent present</span>
                    <span class="k">if</span> <span class="n">combine_space</span> <span class="ow">and</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                        <span class="c1"># we added a space, but don&#39;t need it on new line</span>
                        <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="c1"># hyphenate too long</span>
                    <span class="n">hyphen_out</span> <span class="o">=</span> <span class="n">hyphen</span>
                    <span class="n">desired</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">hyphen_width</span> <span class="o">-</span> <span class="n">line_width</span>
                    <span class="k">if</span> <span class="n">desired</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">hyphen_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">desired</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">line_width</span>
                    <span class="n">seg_width</span><span class="p">,</span> <span class="n">substr</span> <span class="o">=</span> <span class="n">text_width_substr</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">desired</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">seg_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># the first grapheme cluster is wider than desired so</span>
                        <span class="c1"># we will display &#39;*&#39; instead for that first grapheme cluster</span>
                        <span class="n">segment</span> <span class="o">=</span> <span class="n">grapheme_substr</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">substr</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="n">desired</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">substr</span><span class="p">)</span> <span class="p">:]</span>
                        <span class="k">if</span> <span class="n">desired</span> <span class="o">-</span> <span class="n">seg_width</span><span class="p">:</span>  <span class="c1"># did we get less than asked for?</span>
                            <span class="n">substr</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">desired</span> <span class="o">-</span> <span class="n">seg_width</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">substr</span> <span class="o">+</span> <span class="n">hyphen_out</span>
                    <span class="n">accumulated</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent</span><span class="p">]</span>
                    <span class="n">line_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
                    <span class="n">seg_width</span> <span class="o">=</span> <span class="n">text_width</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accumulated</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">line_width</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">combine_space</span> <span class="ow">and</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                    <span class="c1"># we added a space, but don&#39;t need it on new line</span>
                    <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">seg_width</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">accumulated</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent</span><span class="p">]</span>
                <span class="n">line_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">segment</span><span class="p">:</span>
                <span class="n">accumulated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            <span class="n">line_width</span> <span class="o">+=</span> <span class="n">seg_width</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accumulated</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># only indent</span>
            <span class="k">yield</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accumulated</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">line_width</span><span class="p">)</span></div>



<div class="viewcode-block" id="codepoint_name">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.codepoint_name">[docs]</a>
<span class="k">def</span> <span class="nf">codepoint_name</span><span class="p">(</span><span class="n">codepoint</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name or ``None`` if it doesn&#39;t have one</span>

<span class="sd">    For example codepoint 65 is named ``LATIN CAPITAL LETTER A``</span>
<span class="sd">    while codepoint U+D1234 is not assigned and would return</span>
<span class="sd">    ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">codepoint_name</span><span class="p">(</span><span class="n">codepoint</span><span class="p">)</span></div>



<div class="viewcode-block" id="version_added">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.version_added">[docs]</a>
<span class="k">def</span> <span class="nf">version_added</span><span class="p">(</span><span class="n">codepoint</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">&quot;Returns the unicode version the codepoint was added&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">version_added</span><span class="p">(</span><span class="n">codepoint</span><span class="p">)</span></div>



<span class="n">version_dates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Extracted from https://www.unicode.org/history/publicationdates.html</span>
    <span class="s2">&quot;16.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;15.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="s2">&quot;15.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
    <span class="s2">&quot;14.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
    <span class="s2">&quot;13.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;12.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="s2">&quot;12.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;11.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;10.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="s2">&quot;9.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
    <span class="s2">&quot;8.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
    <span class="s2">&quot;7.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
    <span class="s2">&quot;6.3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="s2">&quot;6.2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
    <span class="s2">&quot;6.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
    <span class="s2">&quot;6.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
    <span class="s2">&quot;5.2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;5.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s2">&quot;5.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2006</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
    <span class="s2">&quot;4.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
    <span class="c1"># These releases have no day, so we use the first of the month</span>
    <span class="s2">&quot;4.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;3.2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2002</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;3.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;3.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;2.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1998</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;2.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1996</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;1.1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1993</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;1.0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1991</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Release date (year, month, day) for each unicode version</span>
<span class="sd">intended for use with :meth:`version_added`&quot;&quot;&quot;</span>


<div class="viewcode-block" id="grapheme_next_break">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_next_break">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns end of Grapheme cluster /  User Perceived Character</span>

<span class="sd">    For example regional indicators are in pairs, and a base codepoint</span>
<span class="sd">    can be combined with zero or more additional codepoints providing</span>
<span class="sd">    diacritics, marks, and variations.  Break points are defined in</span>
<span class="sd">    the `TR29 spec</span>
<span class="sd">    &lt;https://www.unicode.org/reports/tr29/#Grapheme_Cluster_Boundary_Rules&gt;`__.</span>

<span class="sd">    :param text: The text to examine</span>
<span class="sd">    :param offset: The first codepoint to examine</span>

<span class="sd">    :returns:  Index of first codepoint not part of the grapheme cluster</span>
<span class="sd">        starting at offset. You should extract ``text[offset:span]``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>



<div class="viewcode-block" id="grapheme_next">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_next">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_next</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="s2">&quot;Returns span of next grapheme cluster&quot;</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">grapheme_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span></div>



<div class="viewcode-block" id="grapheme_iter">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_iter">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_iter</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;Iterator providing text of each grapheme cluster&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_next_break</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">offset</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="grapheme_iter_with_offsets">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_iter_with_offsets">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_iter_with_offsets</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="s2">&quot;Iterator providing start, end, text of each grapheme cluster&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_next_break</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">offset</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="grapheme_iter_with_offsets_filtered">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.grapheme_iter_with_offsets_filtered">[docs]</a>
<span class="k">def</span> <span class="nf">grapheme_iter_with_offsets_filtered</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">categories</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">emoji</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">regional_indicator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="s2">&quot;Iterator providing start, end, text of each grapheme cluster, providing it includes codepoints from categories, emoji, or regional indicator&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">_cats_to_mask</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">emoji</span><span class="p">,</span> <span class="n">regional_indicator</span><span class="p">)</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">grapheme_next_break</span>
    <span class="n">catcheck</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">has_category</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">catcheck</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="word_next_break">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.word_next_break">[docs]</a>
<span class="k">def</span> <span class="nf">word_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns end of next word or non-word</span>

<span class="sd">    Finds the next break point according to the `TR29 spec</span>
<span class="sd">    &lt;https://www.unicode.org/reports/tr29/#Word_Boundary_Rules&gt;`__.</span>
<span class="sd">    Note that the segment returned may be a word, or a non-word</span>
<span class="sd">    (spaces, punctuation etc).  Use :func:`word_next` to get words.</span>

<span class="sd">    :param text: The text to examine</span>
<span class="sd">    :param offset: The first codepoint to examine</span>

<span class="sd">    :returns:  Next break point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">word_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>



<span class="n">_cats_to_mask_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Lu&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lu</span><span class="p">,</span>
    <span class="s2">&quot;Ll&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Ll</span><span class="p">,</span>
    <span class="s2">&quot;Lt&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lt</span><span class="p">,</span>
    <span class="s2">&quot;Lm&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lm</span><span class="p">,</span>
    <span class="s2">&quot;Lo&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Lo</span><span class="p">,</span>
    <span class="s2">&quot;Mn&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Mn</span><span class="p">,</span>
    <span class="s2">&quot;Mc&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Mc</span><span class="p">,</span>
    <span class="s2">&quot;Me&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Me</span><span class="p">,</span>
    <span class="s2">&quot;Nd&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Nd</span><span class="p">,</span>
    <span class="s2">&quot;Nl&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Nl</span><span class="p">,</span>
    <span class="s2">&quot;No&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">No</span><span class="p">,</span>
    <span class="s2">&quot;Pc&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pc</span><span class="p">,</span>
    <span class="s2">&quot;Pd&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pd</span><span class="p">,</span>
    <span class="s2">&quot;Ps&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Ps</span><span class="p">,</span>
    <span class="s2">&quot;Pe&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pe</span><span class="p">,</span>
    <span class="s2">&quot;Pi&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pi</span><span class="p">,</span>
    <span class="s2">&quot;Pf&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Pf</span><span class="p">,</span>
    <span class="s2">&quot;Po&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Po</span><span class="p">,</span>
    <span class="s2">&quot;Sm&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Sm</span><span class="p">,</span>
    <span class="s2">&quot;Sc&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Sc</span><span class="p">,</span>
    <span class="s2">&quot;Sk&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Sk</span><span class="p">,</span>
    <span class="s2">&quot;So&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">So</span><span class="p">,</span>
    <span class="s2">&quot;Zs&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Zs</span><span class="p">,</span>
    <span class="s2">&quot;Zl&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Zl</span><span class="p">,</span>
    <span class="s2">&quot;Zp&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Zp</span><span class="p">,</span>
    <span class="s2">&quot;Cc&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cc</span><span class="p">,</span>
    <span class="s2">&quot;Cf&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cf</span><span class="p">,</span>
    <span class="s2">&quot;Cs&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cs</span><span class="p">,</span>
    <span class="s2">&quot;Co&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Co</span><span class="p">,</span>
    <span class="s2">&quot;Cn&quot;</span><span class="p">:</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Cn</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_cats_to_mask</span><span class="p">(</span><span class="n">categories</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">emoji</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">regional_indicator</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">_cats_to_mask_mapping</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">emoji</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Extended_Pictographic</span>
    <span class="k">if</span> <span class="n">regional_indicator</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">_Category</span><span class="o">.</span><span class="n">Regional_Indicator</span>
    <span class="k">return</span> <span class="n">mask</span>


<span class="n">word_default_categories</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Lu&quot;</span><span class="p">,</span> <span class="s2">&quot;Ll&quot;</span><span class="p">,</span> <span class="s2">&quot;Lt&quot;</span><span class="p">,</span> <span class="s2">&quot;Lm&quot;</span><span class="p">,</span> <span class="s2">&quot;Lo&quot;</span><span class="p">,</span> <span class="s2">&quot;Nd&quot;</span><span class="p">,</span> <span class="s2">&quot;Nl&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">}</span>
<span class="s2">&quot;Default categories for selecting word segments - letters and numbers&quot;</span>


<div class="viewcode-block" id="word_next">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.word_next">[docs]</a>
<span class="k">def</span> <span class="nf">word_next</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">categories</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_default_categories</span><span class="p">,</span>
    <span class="n">emoji</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">regional_indicator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns span of next word</span>

<span class="sd">    A segment is considered a word if it contains at least one codepoint corresponding</span>
<span class="sd">    to any of the `categories`, plus:</span>

<span class="sd">    * emoji (Extended_Pictographic in Unicode specs)</span>
<span class="sd">    * regional indicator - two character sequence for flags like ðŸ‡§ðŸ‡·ðŸ‡¨ðŸ‡¦</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">_cats_to_mask</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">emoji</span><span class="p">,</span> <span class="n">regional_indicator</span><span class="p">)</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">word_next_break</span>
    <span class="n">catcheck</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">has_category</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">catcheck</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span>
    <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="word_iter">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.word_iter">[docs]</a>
<span class="k">def</span> <span class="nf">word_iter</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">categories</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_default_categories</span><span class="p">,</span>
    <span class="n">emoji</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">regional_indicator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;Iterator providing text of each word&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">_cats_to_mask</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">emoji</span><span class="p">,</span> <span class="n">regional_indicator</span><span class="p">)</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">word_next_break</span>
    <span class="n">catcheck</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">has_category</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">catcheck</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="word_iter_with_offsets">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.word_iter_with_offsets">[docs]</a>
<span class="k">def</span> <span class="nf">word_iter_with_offsets</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">categories</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">word_default_categories</span><span class="p">,</span>
    <span class="n">emoji</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">regional_indicator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;Iterator providing start, end, text of each word&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">_cats_to_mask</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">emoji</span><span class="p">,</span> <span class="n">regional_indicator</span><span class="p">)</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">word_next_break</span>
    <span class="n">catcheck</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">has_category</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">catcheck</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="sentence_next_break">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.sentence_next_break">[docs]</a>
<span class="k">def</span> <span class="nf">sentence_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns end of sentence location.</span>

<span class="sd">    Finds the next break point according to the `TR29 spec</span>
<span class="sd">    &lt;https://www.unicode.org/reports/tr29/#Sentence_Boundary_Rules&gt;`__.</span>
<span class="sd">    Note that the segment returned includes leading and trailing white space.</span>

<span class="sd">    :param text: The text to examine</span>
<span class="sd">    :param offset: The first codepoint to examine</span>

<span class="sd">    :returns:  Next break point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">sentence_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>



<div class="viewcode-block" id="sentence_next">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.sentence_next">[docs]</a>
<span class="k">def</span> <span class="nf">sentence_next</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns span of next sentence&quot;&quot;&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">sentence_next_break</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span>
    <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="sentence_iter">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.sentence_iter">[docs]</a>
<span class="k">def</span> <span class="nf">sentence_iter</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;Iterator providing text of each sentence&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">sentence_next_break</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="sentence_iter_with_offsets">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.sentence_iter_with_offsets">[docs]</a>
<span class="k">def</span> <span class="nf">sentence_iter_with_offsets</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="s2">&quot;Iterator providing start, end, text of each sentence&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">sentence_next_break</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="line_break_next_break">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.line_break_next_break">[docs]</a>
<span class="k">def</span> <span class="nf">line_break_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns next opportunity to break a line</span>

<span class="sd">    Finds the next break point according to the `TR14 spec</span>
<span class="sd">    &lt;https://www.unicode.org/reports/tr14/#LB1&gt;`__.</span>

<span class="sd">    :param text: The text to examine</span>
<span class="sd">    :param offset: The first codepoint to examine</span>

<span class="sd">    :returns:  Next break point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">line_next_break</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></div>



<div class="viewcode-block" id="line_break_next">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.line_break_next">[docs]</a>
<span class="k">def</span> <span class="nf">line_break_next</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns span of next line&quot;&quot;&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">line_next_break</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">end</span>
    <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="line_break_iter">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.line_break_iter">[docs]</a>
<span class="k">def</span> <span class="nf">line_break_iter</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="s2">&quot;Iterator providing text of each line&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">line_next_break</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<div class="viewcode-block" id="line_break_iter_with_offsets">
<a class="viewcode-back" href="../../textsearch.html#apsw.unicode.line_break_iter_with_offsets">[docs]</a>
<span class="k">def</span> <span class="nf">line_break_iter_with_offsets</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="s2">&quot;Iterator providing start, end, text of each line&quot;</span>
    <span class="n">lt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">meth</span> <span class="o">=</span> <span class="n">_unicode</span><span class="o">.</span><span class="n">line_next_break</span>

    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">lt</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">atexit</span>
    <span class="kn">import</span> <span class="nn">apsw.fts5</span>

    <span class="c1"># We output text non unicode compatible can&#39;t handle</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">reconfigure</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

    <span class="n">width</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-cc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compact-codepoints&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;compact_codepoints&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only show hex codepoint values, not full details&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;breaktest&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run Unicode test file&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;breaktest&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show each line as it is tested&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fail-fast&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Exit on first test failure&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--fail-codepoints-separator&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;What to separate the list of codepoints with on failure.  Useful for long test strings [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="s2">&quot;line_break&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;What to test&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;file&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;break test text file.  They can be downloaded from https://www.unicode.org/Public/UCD/latest/ucd/auxiliary/&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run against provided text&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;show&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="s2">&quot;line_break&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;What to show [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--text-file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--categories&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;L* N*&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For word, which segments are included.  You can use wildcards and ! for negation [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--emoji&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For word, if emoji segments are included [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--regional-indicator&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For word, if regional indicator segments are included [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Text to segment unless --text-file used&quot;</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;codepoint&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show information about codepoints&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If a hex constant then use that value, otherwise treat as text&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;codepoint&quot;</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;benchmark&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Measure how long segmentation takes to iterate each segment&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;benchmark&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--size&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many million characters (codepoints) of text to use [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Random seed to use [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--others&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A comma separated list of other packages to also benchmark.  Use &#39;all&#39; to get all available ones.  Supported are grapheme, uniseg, pyicu&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;text_file&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Text source to use.</span>

<span class="s2">        The provided text will be repeatedly duplicated and shuffled then</span>
<span class="s2">        appended until the sized amount of text is available.</span>

<span class="s2">        A suggested source of text is to download the Universal Declaration of</span>
<span class="s2">        Human Rights Corpus from https://www.nltk.org/nltk_data/ and</span>
<span class="s2">        concatenate all the files together.  It contains the same text</span>
<span class="s2">        in most written languages.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;textwrap&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Wrap text to fit the specified number of columns.  Each line output</span>
<span class="s2">will be padded with spaces to the width.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;textwrap&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--measurement&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;apsw.unicode&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wcswidth-c&quot;</span><span class="p">,</span> <span class="s2">&quot;wcswidth-py&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Instead of using the builtin function for measuring how wide text is</span>
<span class="s2">use the C library function wcswidth, or use the wcwidth Python package wcswidth function&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--invalid&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Replacement for invalid codepoints such as control characters and surrogates [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--width&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many columns to wrap to [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--tabsize&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tabstop size [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hyphen&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Text to use when a segment is longer that width [</span><span class="si">%(default)s</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-combine-space&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;combine_space&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable combining multiple spaces into one.  Note that leading indents are always preserved&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--start&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Text output at the beginning of each line.  It counts against the width&quot;</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--end&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Text output at the end of each line.  It counts against the width&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--use-stdlib&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Uses the system textwrap library instead.  hyphen is ignored and start/end are applied by this code.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--guess-paragraphs&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Guess if newlines in text are the same paragraphs.  See the doc for apsw.unicode.guess_paragraphs for details&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;text_file&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Text source to use encoded in UTF8. Newlines are considered to delimit each paragraph, so consider --guess-paragraphs.</span>
<span class="s2">        Use a name of a single dash to read from standard input.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;casefold&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Does casefolding on text&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;casefold&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input text [stdin]&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text [stdout]&quot;</span>
    <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;strip&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Strips accents, uses compatibility codepoints etc&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;strip&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input text [stdin]&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text [stdout]&quot;</span>
    <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;breaktestgen&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Extracts data strings to be added to test suite&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;breaktestgen&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Grapheme break test file&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Word break test file&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sentence break test file&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;line_break&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Line break test file&quot;</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;width-check&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Check how this terminal differs from width database.</span>
<span class="s2">        Any differences are reported to stdout in csv format so you should redirect output to a file.</span>
<span class="s2">        Cursor positioning ANSI sequences are used.  Do not type in the terminal while it is running.</span>
<span class="s2">        It takes about a minute to run with most terminals, 1 hour for kitty, and 21+ hours for gnome</span>
<span class="s2">        terminals.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s2">&quot;widthcheck&quot;</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">codepoint_details</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">compact_codepoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;U+</span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">:</span><span class="s2">04x</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">codepoint_name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="n">category</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">:&quot;</span> <span class="k">if</span> <span class="n">counter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">fts5</span><span class="o">.</span><span class="n">unicode_categories</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">uni_cat</span> <span class="o">=</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_unicode</span><span class="o">.</span><span class="n">category_name</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">U+&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%04X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="w"> </span><span class="n">uni_cat</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;show&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">text_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify at least --text-file or text arguments&quot;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">fts5</span><span class="o">.</span><span class="n">convert_unicode_categories</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">categories</span><span class="p">),</span>
            <span class="s2">&quot;emoji&quot;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">emoji</span><span class="p">,</span>
            <span class="s2">&quot;regional_indicator&quot;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">regional_indicator</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show</span> <span class="o">!=</span> <span class="s2">&quot;word&quot;</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">text_file</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="n">options</span><span class="o">.</span><span class="n">text_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="n">next_func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">options</span><span class="o">.</span><span class="n">show</span><span class="w"> </span><span class="si">}</span><span class="s2">_next&quot;</span><span class="p">]</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">next_func</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="si">}</span><span class="s2"> offset </span><span class="si">{</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="si">}</span><span class="s2"> span </span><span class="si">{</span><span class="w"> </span><span class="n">begin</span><span class="w"> </span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="si">}</span><span class="s2"> codepoints </span><span class="si">{</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">begin</span><span class="w"> </span><span class="si">}</span><span class="s2"> value: </span><span class="si">{</span><span class="w"> </span><span class="n">text</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">codepoint_details</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;textwrap&quot;</span><span class="p">:</span>
        <span class="c1"># stop debug interpreter whining about file not being closed</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">measurement</span> <span class="o">==</span> <span class="s2">&quot;wcswidth-c&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ctypes</span>
            <span class="kn">import</span> <span class="nn">ctypes.util</span>

            <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">))</span>  <span class="c1"># C library on Unix/Linux platforms</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">libc</span><span class="p">,</span> <span class="s2">&quot;wcswidth&quot;</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;C library does not have wcswidth function&quot;</span><span class="p">)</span>

            <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">]</span>
            <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

            <span class="k">def</span> <span class="nf">_text_width</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

            <span class="c1"># shenanigans so sphinx doesn&#39;t try to document these</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s2">&quot;text_width&quot;</span><span class="p">,</span> <span class="n">_text_width</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">measurement</span> <span class="o">==</span> <span class="s2">&quot;wcswidth-py&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">wcwidth</span>

            <span class="k">def</span> <span class="nf">_text_width</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">wcwidth</span><span class="o">.</span><span class="n">wcswidth</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">offset</span><span class="p">:])</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s2">&quot;text_width&quot;</span><span class="p">,</span> <span class="n">_text_width</span><span class="p">)</span>

        <span class="n">width</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">width</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">text_width</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="n">text_width</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">text_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">guess_paragraphs</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">guess_paragraphs</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">use_stdlib</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">textwrap</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span>
                <span class="n">width</span><span class="p">,</span>
                <span class="n">tabsize</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tabsize</span><span class="p">,</span>
                <span class="n">drop_whitespace</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">combine_space</span><span class="p">,</span>
                <span class="n">replace_whitespace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="n">padding</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">text_width</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">options</span><span class="o">.</span><span class="n">start</span><span class="si">}{</span><span class="n">line</span><span class="si">}{</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">padding</span><span class="si">}{</span><span class="n">options</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text_wrap</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span>
                <span class="n">width</span><span class="p">,</span>
                <span class="n">tabsize</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">tabsize</span><span class="p">,</span>
                <span class="n">hyphen</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">hyphen</span><span class="p">,</span>
                <span class="n">combine_space</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">combine_space</span><span class="p">,</span>
                <span class="n">invalid</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">invalid</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">options</span><span class="o">.</span><span class="n">start</span><span class="si">}{</span><span class="n">line</span><span class="si">}{</span><span class="n">options</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;breaktest&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">difflib</span>

        <span class="c1"># stop debug interpreter whining about file not being closed</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">())</span>

        <span class="n">next_break_func</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">options</span><span class="o">.</span><span class="n">test</span><span class="w"> </span><span class="si">}</span><span class="s2">_next_break&quot;</span><span class="p">]</span>

        <span class="c1"># ::TODO:: add option that inserts LB_CM/ZWJ chars after every</span>
        <span class="c1"># codepoint (except BK/CR/NL etc) to verify LB9 is always done</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="s2">&quot;Ã·&quot;</span>
        <span class="n">not_ok</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\u00d7</span><span class="s2">&quot;</span>
        <span class="n">passed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fails</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">orig_line</span> <span class="o">=</span> <span class="n">line</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">line_num</span><span class="w"> </span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="w"> </span><span class="n">orig_line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">expect</span> <span class="o">=</span> <span class="n">not_ok</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">test</span> <span class="o">==</span> <span class="s2">&quot;line_break&quot;</span> <span class="k">else</span> <span class="n">ok</span>
            <span class="k">assert</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">expect</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="w"> </span><span class="n">line_num</span><span class="w"> </span><span class="si">}</span><span class="s2"> doesn&#39;t start with </span><span class="si">{</span><span class="w"> </span><span class="n">expect</span><span class="w"> </span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="k">assert</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ok</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="w"> </span><span class="n">line_num</span><span class="w"> </span><span class="si">}</span><span class="s2"> doesn&#39;t end with </span><span class="si">{</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">breaks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">not_ok</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">breaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">add_failinfo</span><span class="p">():</span>
                <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orig_line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">codepoints</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                    <span class="n">codepoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codepoint_details</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>
                <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">fail_codepoints_separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">codepoints</span><span class="p">))</span>
                <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">seen</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fails</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="n">span</span> <span class="o">=</span> <span class="n">next_break_func</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">span</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">breaks</span><span class="p">:</span>
                    <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="w"> </span><span class="n">line_num</span><span class="w"> </span><span class="si">}</span><span class="s2"> got unexpected break at </span><span class="si">{</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="si">}</span><span class="s2"> - expected are </span><span class="si">{</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="si">}</span><span class="s2">.  Seen </span><span class="si">{</span><span class="w"> </span><span class="n">seen</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">add_failinfo</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">span</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">fail_fast</span> <span class="ow">and</span> <span class="n">fails</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fails</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lf</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">breaks</span><span class="p">):</span>
                <span class="n">fails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="w"> </span><span class="n">line_num</span><span class="w"> </span><span class="si">}</span><span class="s2"> got breaks at </span><span class="si">{</span><span class="w"> </span><span class="n">seen</span><span class="w"> </span><span class="si">}</span><span class="s2"> expected at </span><span class="si">{</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seen</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">breaks</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1"># use difflib to show difference</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">breaks</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;equal&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">a1</span> <span class="o">!=</span> <span class="n">a2</span><span class="p">:</span>
                            <span class="n">fails</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       seen </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">seen</span><span class="p">[</span><span class="n">a1</span><span class="p">:</span><span class="n">a2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="n">b1</span> <span class="o">!=</span> <span class="n">b2</span><span class="p">:</span>
                            <span class="n">fails</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    expected </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">breaks</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">b2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">add_failinfo</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">fail_fast</span> <span class="ow">and</span> <span class="n">fails</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">passed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">fails</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">fails</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="w"> </span><span class="si">}</span><span class="s2"> tests failed, </span><span class="si">{</span><span class="n">passed</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> passed:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">fails</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fail</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">passed</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> passed&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;codepoint&quot;</span><span class="p">:</span>
        <span class="n">codepoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">codepoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">codepoints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">uniname</span><span class="p">(</span><span class="n">cp</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">codepoint_name</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">deets</span><span class="p">(</span><span class="n">cp</span><span class="p">):</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">category</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">uniname</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="w"> </span><span class="n">apsw</span><span class="o">.</span><span class="n">fts5</span><span class="o">.</span><span class="n">unicode_categories</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codepoints</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="si">}</span><span class="s2"> U+</span><span class="si">{</span><span class="w"> </span><span class="n">cp</span><span class="si">:</span><span class="s2">04X</span><span class="si">}</span><span class="s2"> - &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="n">added</span> <span class="o">=</span> <span class="n">version_added</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
            <span class="n">year</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">version_dates</span><span class="p">[</span><span class="n">added</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">added</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name: </span><span class="si">{</span><span class="w"> </span><span class="n">deets</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s2">   Version: </span><span class="si">{</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">mangled</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mangle</span> <span class="ow">in</span> <span class="n">casefold</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)),</span> <span class="n">strip</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mangle</span><span class="p">:</span>
                    <span class="n">mangled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(nothing)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mangled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;U+</span><span class="si">{</span><span class="w"> </span><span class="nb">ord</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">:</span><span class="s2">04X</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">uniname</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mangle</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;casefold: </span><span class="si">{</span><span class="w"> </span><span class="n">mangled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">   stripped: </span><span class="si">{</span><span class="w"> </span><span class="n">mangled</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Width: </span><span class="si">{</span><span class="w"> </span><span class="n">text_width</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;TR29 grapheme: </span><span class="si">{</span><span class="w"> </span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_unicode</span><span class="o">.</span><span class="n">category_name</span><span class="p">(</span><span class="s1">&#39;grapheme&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">   &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;word: </span><span class="si">{</span><span class="w"> </span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_unicode</span><span class="o">.</span><span class="n">category_name</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">   &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;sentence: </span><span class="si">{</span><span class="w"> </span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_unicode</span><span class="o">.</span><span class="n">category_name</span><span class="p">(</span><span class="s1">&#39;sentence&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;TR14 line break: </span><span class="si">{</span><span class="w"> </span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_unicode</span><span class="o">.</span><span class="n">category_name</span><span class="p">(</span><span class="s1">&#39;line_break&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;benchmark&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">random</span>
        <span class="kn">import</span> <span class="nn">time</span>

        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">base_text</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">text_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">base_text</span>

        <span class="c1"># these are the non-ascii codepoints used in the various break tests</span>
        <span class="n">interesting</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s2">&quot;&quot;&quot;0085 00A0 00AD 01BB 0300 0308 034F 0378 05D0 0600 062D 0631</span>
<span class="s2">                0644 0645 0646 064A 064E 0650 0651 0661 0671 06DD 070F 0710 0712 0717</span>
<span class="s2">                0718 0719 071D 0721 072A 072B 072C 0900 0903 0904 0915 0924 092F 093C</span>
<span class="s2">                094D 0A03 0D4E 1100 1160 11A8 200D 2018 2019 201C 201D 2060 231A 2701</span>
<span class="s2">                3002 3031 5B57 5B83 AC00 AC01 1F1E6 1F1E7 1F1E8 1F1E9 1F3FF 1F476</span>
<span class="s2">                1F6D1&quot;&quot;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># make interesting be 0.1% of base text</span>
        <span class="n">base_text</span> <span class="o">+=</span> <span class="n">interesting</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interesting</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_text</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">))</span>

        <span class="n">tests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="s2">&quot;apsw.unicode&quot;</span><span class="p">,</span>
                <span class="n">unicode_version</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="n">grapheme_iter</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="n">word_iter</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="n">sentence_iter</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">line_break_iter</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">others</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">others</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">uniseg</span>

                    <span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;uniseg&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">grapheme</span>

                    <span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">icu</span>

                    <span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyicu&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">others</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">others</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">others</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">others</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">package</span> <span class="o">==</span> <span class="s2">&quot;grapheme&quot;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">grapheme</span>
                    <span class="kn">import</span> <span class="nn">grapheme.finder</span>

                    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="n">grapheme</span><span class="o">.</span><span class="n">UNICODE_VERSION</span><span class="p">,</span> <span class="p">((</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="n">grapheme</span><span class="o">.</span><span class="n">finder</span><span class="o">.</span><span class="n">GraphemeIterator</span><span class="p">),))</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">package</span> <span class="o">==</span> <span class="s2">&quot;uniseg&quot;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">uniseg</span>
                    <span class="kn">import</span> <span class="nn">uniseg.graphemecluster</span>
                    <span class="kn">import</span> <span class="nn">uniseg.wordbreak</span>
                    <span class="kn">import</span> <span class="nn">uniseg.sentencebreak</span>
                    <span class="kn">import</span> <span class="nn">uniseg.linebreak</span>

                    <span class="c1"># note that uniseg words doesn&#39;t determine which</span>
                    <span class="c1"># segments are words or not so you just get all</span>
                    <span class="c1"># segments</span>

                    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;uniseg&quot;</span><span class="p">,</span>
                            <span class="n">uniseg</span><span class="o">.</span><span class="n">unidata_version</span><span class="p">,</span>
                            <span class="p">(</span>
                                <span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="n">uniseg</span><span class="o">.</span><span class="n">graphemecluster</span><span class="o">.</span><span class="n">grapheme_clusters</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="n">uniseg</span><span class="o">.</span><span class="n">wordbreak</span><span class="o">.</span><span class="n">words</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="n">uniseg</span><span class="o">.</span><span class="n">sentencebreak</span><span class="o">.</span><span class="n">sentences</span><span class="p">),</span>
                                <span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">uniseg</span><span class="o">.</span><span class="n">linebreak</span><span class="o">.</span><span class="n">line_break_units</span><span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">package</span> <span class="o">==</span> <span class="s2">&quot;pyicu&quot;</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">icu</span>
                    <span class="kn">import</span> <span class="nn">functools</span>

                    <span class="c1"># api only returns breakpoints, so make it match</span>
                    <span class="c1"># the others.  It also does its own utf16 based</span>
                    <span class="c1"># strings so there is some conversion overhead</span>
                    <span class="k">def</span> <span class="nf">icu_iterate</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
                        <span class="n">icu_it</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">icu</span><span class="o">.</span><span class="n">BreakIterator</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;create</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">Instance&quot;</span><span class="p">)(</span><span class="n">icu</span><span class="o">.</span><span class="n">Locale</span><span class="o">.</span><span class="n">getEnglish</span><span class="p">())</span>
                        <span class="n">icu_str</span> <span class="o">=</span> <span class="n">icu</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                        <span class="n">icu_it</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">icu_str</span><span class="p">)</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">icu_it</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">icu_str</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">pos</span><span class="p">])</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">pos</span>

                    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;pyicu&quot;</span><span class="p">,</span>
                            <span class="n">icu</span><span class="o">.</span><span class="n">UNICODE_VERSION</span><span class="p">,</span>
                            <span class="p">(</span>
                                <span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">icu_iterate</span><span class="p">,</span> <span class="s2">&quot;Character&quot;</span><span class="p">)),</span>
                                <span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">icu_iterate</span><span class="p">,</span> <span class="s2">&quot;Word&quot;</span><span class="p">)),</span>
                                <span class="p">(</span><span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">icu_iterate</span><span class="p">,</span> <span class="s2">&quot;Sentence&quot;</span><span class="p">)),</span>
                                <span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">icu_iterate</span><span class="p">,</span> <span class="s2">&quot;Line&quot;</span><span class="p">)),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown third party package to benchmark &#39;</span><span class="si">{</span><span class="n">package</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expanding text to </span><span class="si">{</span><span class="w"> </span><span class="n">options</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="si">}</span><span class="s2"> million chars ...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">base_text</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_text</span><span class="p">)))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">1_000_000</span><span class="p">)]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Results in codepoints per second processed, returning each segment.  Higher is faster.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">parts</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Benchmarking </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> unicode version </span><span class="si">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kind</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">process_time_ns</span><span class="p">()</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">func</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc2</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="n">exc2</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">process_time_ns</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       EXCEPTION </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;codepoints per second: </span><span class="si">{</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">/</span><span class="n">seconds</span><span class="p">)</span><span class="si">:</span><span class="s2"> 12,d</span><span class="si">}</span><span class="s2">    segments: </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2"> 11,d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;casefold&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">casefold</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;strip&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strip</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;breaktestgen&quot;</span><span class="p">:</span>
        <span class="c1"># char used to mark ok and not in the files</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="s2">&quot;Ã·&quot;</span>
        <span class="n">not_ok</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\u00d7</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">get_strings</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                <span class="n">line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove initial marker</span>
                <span class="n">line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># and final</span>

                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">not_ok</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">+=</span> <span class="n">c</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
                        <span class="k">assert</span> <span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Ã·&quot;</span>
                <span class="k">yield</span> <span class="n">text</span>

        <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">category</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;Lu&quot;</span><span class="p">,</span> <span class="s2">&quot;Ll&quot;</span><span class="p">,</span> <span class="s2">&quot;Nd&quot;</span><span class="p">,</span> <span class="s2">&quot;Nl&quot;</span><span class="p">,</span> <span class="s2">&quot;Pd&quot;</span><span class="p">,</span> <span class="s2">&quot;Sm&quot;</span><span class="p">,</span> <span class="s2">&quot;Sc&quot;</span><span class="p">,</span> <span class="s2">&quot;So&quot;</span><span class="p">,</span> <span class="s2">&quot;Zs&quot;</span><span class="p">}:</span>
                    <span class="n">res</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">04X</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">U</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;grapheme&quot;</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="s2">&quot;line_break&quot;</span><span class="p">):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_strings</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
            <span class="c1"># we always take the shorted and longest</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="c1"># and 20 of the rest</span>
            <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">//</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">//</span> <span class="mi">20</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">offset</span><span class="p">]),</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;),&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s2">&quot;widthcheck&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">atexit</span>

        <span class="kn">import</span> <span class="nn">ctypes</span><span class="o">,</span> <span class="nn">ctypes.util</span>

        <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">))</span>
        <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">]</span>
        <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

        <span class="kn">import</span> <span class="nn">wcwidth</span>

        <span class="n">tty_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/tty&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">tty_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/tty&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">tty</span>
        <span class="kn">import</span> <span class="nn">termios</span>

        <span class="n">term_mode</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">tty_in</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">finish</span><span class="p">():</span>
            <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">tty_in</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="n">term_mode</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">)</span>

        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>

        <span class="n">tty</span><span class="o">.</span><span class="n">setraw</span><span class="p">(</span><span class="n">tty_in</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_pos</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[6n&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">tty_in</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[&quot;</span>  <span class="c1"># something else was typed</span>
            <span class="n">r</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">tty_in</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">set_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[</span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">;</span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">H&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">)</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">start_pos</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">0</span><span class="si">:</span><span class="s2">06X</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">)</span>
        <span class="n">out_pos</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxunicode</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># surrogates can&#39;t be output</span>
            <span class="k">if</span> <span class="mh">0xD800</span> <span class="o">&lt;=</span> <span class="n">cp</span> <span class="o">&lt;=</span> <span class="mh">0xDFFF</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">set_pos</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cp</span><span class="si">:</span><span class="s2">06X</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">)</span>
            <span class="n">set_pos</span><span class="p">(</span><span class="n">out_pos</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;b&quot;</span>
            <span class="k">if</span> <span class="n">cp</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">text_width</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">wcwidth</span><span class="o">.</span><span class="n">wcswidth</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">tty_out</span><span class="p">)</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">get_pos</span><span class="p">()</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">out_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">width</span> <span class="o">!=</span> <span class="n">text_width</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cp</span><span class="p">,</span> <span class="n">width</span><span class="p">])</span>

        <span class="n">finish</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">csv</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;codepoint&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;hex&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;text_width&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wcswidth_c&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wcswidth_py&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;version_added&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">cp</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">cp</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cp</span><span class="si">:</span><span class="s2">04X</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">text_width</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)),</span>
                        <span class="n">libc</span><span class="o">.</span><span class="n">wcswidth</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="mi">1000</span><span class="p">),</span>
                        <span class="n">wcwidth</span><span class="o">.</span><span class="n">wcswidth</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">codepoint_name</span><span class="p">(</span><span class="n">cp</span><span class="p">)),</span>
                        <span class="n">version_added</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
                        <span class="n">category</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2004-2024, Roger Binns &lt;rogerb@rogerbinns.com&gt;.
      <span class="lastupdated">Last updated on Nov 17, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2NR9GDCQLT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2NR9GDCQLT', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>