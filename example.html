

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example/Tour &mdash; APSW 3.49.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=bb2faaec" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/apsw.css?v=3c7e2631" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=15a4c64e"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="next" title="Installation and customization" href="install.html" />
    <link rel="prev" title="Tips" href="tips.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            APSW
              <img src="_static/apswlogo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="tips.html">Tips</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example/Tour</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#checking-apsw-and-sqlite-versions">Checking APSW and SQLite versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#best-practice">Best Practice</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#opening-the-database">Opening the database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#executing-sql">Executing SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-you-use-bindings-to-provide-values">Why you use bindings to provide values</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bindings-sequence">Bindings (sequence)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bindings-dict">Bindings (dict)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transactions">Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#executemany">executemany</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pragmas">Pragmas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracing-execution">Tracing execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracing-returned-rows">Tracing returned rows</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-scalar-functions">Defining scalar functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-aggregate-functions">Defining aggregate functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-window-functions">Defining window functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-collations-sorting">Defining collations (sorting)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-results-by-column-name">Accessing results by column name</a></li>
<li class="toctree-l2"><a class="reference internal" href="#type-conversion-into-out-of-database">Type conversion into/out of database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#runtime-python-objects">Runtime Python objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#query-limiting">Query limiting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#query-details">Query details</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blob-i-o">Blob I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="#backup-an-open-database">Backup an open database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#authorizer-control-what-sql-can-do">Authorizer (control what SQL can do)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#progress-handler">Progress handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#file-control">File Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#commit-hook">Commit hook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update-hook">Update hook</a></li>
<li class="toctree-l2"><a class="reference internal" href="#virtual-tables">Virtual tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#vfs-virtual-file-system">VFS - Virtual File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#limits">Limits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shell">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="#statistics">Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracing">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#system-and-sqlite-resource-usage-in-a-block">System and SQLite resource usage in a block</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sql-statement-tracing-in-a-block">SQL statement tracing in a block</a></li>
<li class="toctree-l2"><a class="reference internal" href="#formatting-query-results-table">Formatting query results table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cleanup">Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation and customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="bestpractice.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="apsw.html">APSW Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="connection.html">Connections to a database</a></li>
<li class="toctree-l1"><a class="reference internal" href="cursor.html">Cursors (executing SQL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="blob.html">Blob Input/Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-fts.html">Full Text Search Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="textsearch.html">Full text search</a></li>
<li class="toctree-l1"><a class="reference internal" href="vtable.html">Virtual Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfs.html">Virtual File System (VFS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="ext.html">Various interesting and useful bits of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="exceptions.html">Exceptions and Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="execution.html">Execution and tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="dbapi.html">DBAPI notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="pysqlite.html">sqlite3 module differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="copyright.html">Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Change History</a></li>
<li class="toctree-l1"><a class="reference internal" href="py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">APSW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Example/Tour</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="tips.html" class="btn btn-neutral float-left" title="Tips" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="install.html" class="btn btn-neutral float-right" title="Installation and customization" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-tour">
<h1>Example/Tour<a class="headerlink" href="#example-tour" title="Link to this heading"></a></h1>
<p>This code demonstrates usage of APSW.  It gives you a good overview of
all the things that can be done.  Also included is output so you can
see what gets printed when you run the code.</p>
<p>There are also specific examples in the classes, functions,
and attribute documentation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># This code uses Python&#39;s optional typing annotations.  You can</span>
<span class="c1"># ignore them and do not need to use them.  If you do use them</span>
<span class="c1"># then you must include this future annotations line first.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">apsw</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">apsw.ext</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># pretty formatting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
</pre></div>
</div>
<section id="checking-apsw-and-sqlite-versions">
<span id="example-version-check"></span><span id="index-0"></span><h2>Checking APSW and SQLite versions<a class="headerlink" href="#checking-apsw-and-sqlite-versions" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Where the extension module is on the filesystem</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      Using APSW file&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

<span class="c1"># From the extension</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         APSW version&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">apsw_version</span><span class="p">())</span>

<span class="c1"># From the sqlite header file at APSW compile time</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SQLite header version&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_VERSION_NUMBER</span><span class="p">)</span>

<span class="c1"># The SQLite code running</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   SQLite lib version&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">sqlite_lib_version</span><span class="p">())</span>

<span class="c1"># If True then SQLite is incorporated into the extension.</span>
<span class="c1"># If False then a shared library is being used, or static linking</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Using amalgamation&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">using_amalgamation</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">      Using APSW file /space/apsw/apsw/__init__.cpython-312-x86_64-linux-gnu.so</span>
<span class="go">         APSW version 3.49.1.0</span>
<span class="go">SQLite header version 3049001</span>
<span class="go">   SQLite lib version 3.49.1</span>
<span class="go">   Using amalgamation True</span>
</pre></div>
</div>
</section>
<section id="best-practice">
<span id="example-bestpractice"></span><span id="index-1"></span><h2>Best Practice<a class="headerlink" href="#best-practice" title="Link to this heading"></a></h2>
<p>Ensure SQLite usage prevents common mistakes, and gets best
performance via <a class="reference internal" href="bestpractice.html"><span class="doc">apsw.bestpractice</span></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">apsw.bestpractice</span>

<span class="n">apsw</span><span class="o">.</span><span class="n">bestpractice</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">bestpractice</span><span class="o">.</span><span class="n">recommended</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="logging">
<span id="example-logging"></span><span id="index-2"></span><h2>Logging<a class="headerlink" href="#logging" title="Link to this heading"></a></h2>
<p>It is a good idea to get SQLite’s logs as you will get more
information about errors. Best practice also includes this.
<a class="reference internal" href="ext.html#apsw.ext.log_sqlite" title="apsw.ext.log_sqlite"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.log_sqlite()</span></code></a> forwards SQLite’s log messages to the
<a class="reference external" href="https://docs.python.org/3/library/logging.html#module-logging" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">logging</span></code></a> module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">log_sqlite</span><span class="p">()</span>

<span class="c1"># You can also write to SQLite&#39;s log</span>
<span class="n">apsw</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_ERROR</span><span class="p">,</span> <span class="s2">&quot;A message from Python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="opening-the-database">
<span id="example-open-db"></span><span id="index-3"></span><h2>Opening the database<a class="headerlink" href="#opening-the-database" title="Link to this heading"></a></h2>
<p>You open the database by using <a class="reference internal" href="connection.html#apsw.Connection" title="apsw.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default will create the database if it doesn&#39;t exist</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;dbfile&quot;</span><span class="p">)</span>

<span class="c1"># Open existing read-only</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span>
    <span class="s2">&quot;dbfile&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_READONLY</span>
<span class="p">)</span>

<span class="c1"># Open existing read-write (exception if it doesn&#39;t exist)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span>
    <span class="s2">&quot;dbfile&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_READWRITE</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="executing-sql">
<span id="example-executing-sql"></span><span id="index-4"></span><h2>Executing SQL<a class="headerlink" href="#executing-sql" title="Link to this heading"></a></h2>
<p>Use <a class="reference internal" href="connection.html#apsw.Connection.execute" title="apsw.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> to execute SQL</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table point(x,y,z)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(1, 2, 3)&quot;</span><span class="p">)</span>
<span class="c1"># You can use multiple ; separated statements</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    insert into point values(4, 5, 6);</span>
<span class="sd">    create table log(timestamp, event);</span>
<span class="sd">    create table foo(a, b, c);</span>
<span class="sd">    create table important(secret, data);</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="c1"># read rows</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from point&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">(1, 2, 3)</span>
<span class="go">(4, 5, 6)</span>
</pre></div>
</div>
</section>
<section id="why-you-use-bindings-to-provide-values">
<span id="example-why-bindings"></span><span id="index-5"></span><h2>Why you use bindings to provide values<a class="headerlink" href="#why-you-use-bindings-to-provide-values" title="Link to this heading"></a></h2>
<p>It is tempting to compose strings with the values in them, but it is
easy to mangle the query especially if values contain punctuation
and unicode.  It is known as <a class="reference external" href="https://en.wikipedia.org/wiki/SQL_injection">SQL injection</a>. Bindings are the
correct way to supply values to queries.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># a simple value</span>
<span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;system started&quot;</span>
<span class="c1"># DO NOT DO THIS</span>
<span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insert into log values(0, &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;query:&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

<span class="c1"># BECAUSE ... a bad guy could provide a value like this</span>
<span class="n">event</span> <span class="o">=</span> <span class="s2">&quot;bad guy here&#39;) ; drop table important; -- comment&quot;</span>
<span class="c1"># which has effects like this</span>
<span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insert into log values(0, &#39;</span><span class="si">{</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bad guy:&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">query: insert into log values(0, &#39;system started&#39;)</span>
<span class="go">bad guy: insert into log values(0, &#39;bad guy here&#39;) ; drop table important; -- comment&#39;)</span>
</pre></div>
</div>
</section>
<section id="bindings-sequence">
<span id="example-bindings-sequence"></span><span id="index-6"></span><h2>Bindings (sequence)<a class="headerlink" href="#bindings-sequence" title="Link to this heading"></a></h2>
<p>Bindings can be provided as a sequence such as with
a tuple or list.  Use <strong>?</strong> to show where the values go.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;insert into log values(?, ?)&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;transmission started&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="c1"># You can also use numbers after the ? to select</span>
<span class="c1"># values from the sequence.  Note that numbering</span>
<span class="c1"># starts at 1</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select ?1, ?3, ?2&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">(&#39;alpha&#39;, &#39;gamma&#39;, &#39;beta&#39;)</span>
</pre></div>
</div>
</section>
<section id="bindings-dict">
<span id="example-bindings-dict"></span><span id="index-7"></span><h2>Bindings (dict)<a class="headerlink" href="#bindings-dict" title="Link to this heading"></a></h2>
<p>You can also supply bindings with a dictionary.  Use <strong>:NAME</strong>,
<strong>&#64;NAME</strong>, or <strong>$NAME</strong>, to provide the key name in the query.
Names are case sensitive.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;insert into point values(:x, @Y, $z)&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">}</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="transactions">
<span id="example-transaction"></span><span id="index-8"></span><h2>Transactions<a class="headerlink" href="#transactions" title="Link to this heading"></a></h2>
<p>By default each statement is its own transaction.  A transaction
finishes by flushing data to storage and waiting for the operating
system to confirm it is permanently there (ie will survive a power
failure) which takes a while.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3 separate transactions</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(2, 2, 2)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(3, 3, 3)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(4, 4, 4)&quot;</span><span class="p">)</span>

<span class="c1"># You can use BEGIN / COMMIT to manually make a transaction</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(2, 2, 2)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(3, 3, 3)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(4, 4, 4)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>

<span class="c1"># Or use `with` that does it automatically</span>
<span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(2, 2, 2)&quot;</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(3, 3, 3)&quot;</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(4, 4, 4)&quot;</span><span class="p">)</span>

<span class="c1"># Nested transactions are supported</span>
<span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(2, 2, 2)&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(3, 3, 3)&quot;</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into point values(4, 4, 4)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="executemany">
<span id="example-executemany"></span><span id="index-9"></span><h2>executemany<a class="headerlink" href="#executemany" title="Link to this heading"></a></h2>
<p>You can execute the same SQL against a sequence using
<a class="reference internal" href="connection.html#apsw.Connection.executemany" title="apsw.Connection.executemany"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.executemany()</span></code></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;insert into point values(?,?,?)&quot;</span>

<span class="c1"># we do it in a transaction</span>
<span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
    <span class="c1"># the query is run for each item in data</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pragmas">
<span id="example-pragma"></span><span id="index-10"></span><h2>Pragmas<a class="headerlink" href="#pragmas" title="Link to this heading"></a></h2>
<p>SQLite has a <a class="reference external" href="https://www.sqlite.org/pragma.html">wide variety of pragmas</a> to control
the database configuration and library behaviour.  See the <a class="reference internal" href="tips.html"><span class="doc">Tips</span></a> for maintaining
your schema.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># WAL mode is good for write performance</span>
<span class="n">connection</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;journal_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;wal&quot;</span><span class="p">)</span>

<span class="c1"># Foreign keys are off by default, so turn them on</span>
<span class="n">connection</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;foreign_keys&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># You can use this to see if any other connection (including other processes) has</span>
<span class="c1"># changed the database</span>
<span class="n">connection</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;data_version&quot;</span><span class="p">)</span>

<span class="c1"># Useful at startup to detect some database corruption</span>
<span class="n">check</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;integrity_check&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">check</span> <span class="o">!=</span> <span class="s2">&quot;ok&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Integrity check errors&quot;</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tracing-execution">
<span id="example-exectrace"></span><span id="index-11"></span><h2>Tracing execution<a class="headerlink" href="#tracing-execution" title="Link to this heading"></a></h2>
<p>You can trace execution of SQL statements and their bindings.  This
involves code changes and is <a class="reference internal" href="execution.html#tracing"><span class="std std-ref">described in more detail here</span></a>.</p>
<p>There are simpler convenient mechanisms for <a class="reference internal" href="#example-trace"><span class="std std-ref">individual
statement tracing</span></a>, <a class="reference internal" href="#example-showresourceusage"><span class="std std-ref">summarising a block of
code</span></a>, and <a class="reference internal" href="#example-trace-v2"><span class="std std-ref">SQLite’s interface</span></a> which is used by them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_tracer</span><span class="p">(</span>
    <span class="n">cursor</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Cursor</span><span class="p">,</span>
    <span class="n">statement</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bindings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">apsw</span><span class="o">.</span><span class="n">Bindings</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s2">&quot;Called just before executing each statement&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SQL:&quot;</span><span class="p">,</span> <span class="n">statement</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bindings:&quot;</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># if you return False then execution is aborted</span>


<span class="c1"># you can trace a single cursor</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">exec_trace</span> <span class="o">=</span> <span class="n">my_tracer</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        drop table if exists bar;</span>
<span class="sd">        create table bar(x,y,z);</span>
<span class="sd">        select * from point where x=?;</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
<span class="p">)</span>

<span class="c1"># if set on a connection then all cursors are traced</span>
<span class="n">connection</span><span class="o">.</span><span class="n">exec_trace</span> <span class="o">=</span> <span class="n">my_tracer</span>
<span class="c1"># and clearing it</span>
<span class="n">connection</span><span class="o">.</span><span class="n">exec_trace</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">SQL: drop table if exists bar;</span>
<span class="go">Bindings: ()</span>
<span class="go">SQL: create table bar(x,y,z);</span>
<span class="go">Bindings: ()</span>
<span class="go">SQL: select * from point where x=?;</span>
<span class="go">Bindings: (3,)</span>
</pre></div>
</div>
</section>
<section id="tracing-returned-rows">
<span id="example-rowtrace"></span><span id="index-12"></span><h2>Tracing returned rows<a class="headerlink" href="#tracing-returned-rows" title="Link to this heading"></a></h2>
<p>You can trace returned rows, including modifying what is returned or
skipping it completely.  See <a class="reference internal" href="execution.html#tracing"><span class="std std-ref">more about tracing</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">row_tracer</span><span class="p">(</span>
    <span class="n">cursor</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Cursor</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValues</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValues</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Called with each row of results before they are handed off.  You can return None to</span>
<span class="sd">    cause the row to be skipped or a different set of values to return&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Row:&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">row</span>


<span class="c1"># you can trace a single cursor</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">row_trace</span> <span class="o">=</span> <span class="n">row_tracer</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select x,y from point where x&gt;4&quot;</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># if set on a connection then all cursors are traced</span>
<span class="n">connection</span><span class="o">.</span><span class="n">row_trace</span> <span class="o">=</span> <span class="n">row_tracer</span>
<span class="c1"># and clearing it</span>
<span class="n">connection</span><span class="o">.</span><span class="n">row_trace</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">Row: (7, 8)</span>
<span class="go">Row: (5, 5)</span>
</pre></div>
</div>
</section>
<section id="defining-scalar-functions">
<span id="example-scalar"></span><span id="index-13"></span><h2>Defining scalar functions<a class="headerlink" href="#defining-scalar-functions" title="Link to this heading"></a></h2>
<p>Scalar functions take one or more values and return one value.  They
are registered by calling <a class="reference internal" href="connection.html#apsw.Connection.create_scalar_function" title="apsw.Connection.create_scalar_function"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.create_scalar_function()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ilove7</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="s2">&quot;A scalar function&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ilove7 got </span><span class="si">{</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="si">}</span><span class="s2"> but I love 7&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">7</span>


<span class="n">connection</span><span class="o">.</span><span class="n">create_scalar_function</span><span class="p">(</span><span class="s2">&quot;seven&quot;</span><span class="p">,</span> <span class="n">ilove7</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select seven(x,y) from point where x&gt;4&quot;</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">ilove7 got (7, 8) but I love 7</span>
<span class="go">row (7,)</span>
<span class="go">ilove7 got (5, 5) but I love 7</span>
<span class="go">row (7,)</span>
</pre></div>
</div>
</section>
<section id="defining-aggregate-functions">
<span id="example-aggregate"></span><span id="index-14"></span><h2>Defining aggregate functions<a class="headerlink" href="#defining-aggregate-functions" title="Link to this heading"></a></h2>
<p>Aggregate functions are called multiple times with matching rows,
and then provide a final value.  An example is calculating an
average.  They are registered by calling
<a class="reference internal" href="connection.html#apsw.Connection.create_aggregate_function" title="apsw.Connection.create_aggregate_function"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.create_aggregate_function()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">longest</span><span class="p">:</span>
    <span class="c1"># Find which value when represented as a string is</span>
    <span class="c1"># the longest</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longest</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Called with each matching row</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">longest</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">longest</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Called at the very end</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">longest</span>


<span class="n">connection</span><span class="o">.</span><span class="n">create_aggregate_function</span><span class="p">(</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span> <span class="n">longest</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select longest(event) from log&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">transmission started</span>
</pre></div>
</div>
</section>
<section id="defining-window-functions">
<span id="example-window"></span><span id="index-15"></span><h2>Defining window functions<a class="headerlink" href="#defining-window-functions" title="Link to this heading"></a></h2>
<p>Window functions input values come from a “window” around a row of
interest.  Four methods are called as the window moves to add,
remove, get the current value, and finalize.</p>
<p>An example is calculating an average of values in the window to
compare to the row.  They are registered by calling
<a class="reference internal" href="connection.html#apsw.Connection.create_window_function" title="apsw.Connection.create_window_function"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.create_window_function()</span></code></a>.</p>
<p>This is the Python equivalent to the C based example in the <a class="reference external" href="https://www.sqlite.org/windowfunctions.html#user_defined_aggregate_window_functions">SQLite
documentation</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SumInt</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">+=</span> <span class="n">arg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inverse&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">-=</span> <span class="n">arg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">final</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>


<span class="n">connection</span><span class="o">.</span><span class="n">create_window_function</span><span class="p">(</span><span class="s2">&quot;sumint&quot;</span><span class="p">,</span> <span class="n">SumInt</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CREATE TABLE t3(x, y);</span>
<span class="sd">        INSERT INTO t3 VALUES(&#39;a&#39;, 4),</span>
<span class="sd">                             (&#39;b&#39;, 5),</span>
<span class="sd">                             (&#39;c&#39;, 3),</span>
<span class="sd">                             (&#39;d&#39;, 8),</span>
<span class="sd">                             (&#39;e&#39;, 1);</span>
<span class="sd">        -- Use the window function</span>
<span class="sd">        SELECT x, sumint(y) OVER (</span>
<span class="sd">        ORDER BY x ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING</span>
<span class="sd">        ) AS sum_y</span>
<span class="sd">        FROM t3 ORDER BY x;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ROW&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">step 4</span>
<span class="go">step 5</span>
<span class="go">value 9</span>
<span class="go">ROW (&#39;a&#39;, 9)</span>
<span class="go">step 3</span>
<span class="go">value 12</span>
<span class="go">ROW (&#39;b&#39;, 12)</span>
<span class="go">inverse 4</span>
<span class="go">step 8</span>
<span class="go">value 16</span>
<span class="go">ROW (&#39;c&#39;, 16)</span>
<span class="go">inverse 5</span>
<span class="go">step 1</span>
<span class="go">value 12</span>
<span class="go">ROW (&#39;d&#39;, 12)</span>
<span class="go">inverse 3</span>
<span class="go">value 9</span>
<span class="go">ROW (&#39;e&#39;, 9)</span>
<span class="go">final 9</span>
</pre></div>
</div>
</section>
<section id="defining-collations-sorting">
<span id="example-collation"></span><span id="index-16"></span><h2>Defining collations (sorting)<a class="headerlink" href="#defining-collations-sorting" title="Link to this heading"></a></h2>
<p>How you sort can depend on the languages or values involved.  You
register a collation by calling <a class="reference internal" href="connection.html#apsw.Connection.create_collation" title="apsw.Connection.create_collation"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.create_collation()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example sorting mechanisms understands some text followed by a</span>
<span class="c1"># number and ensures the number portion gets sorted correctly</span>

<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table names(name)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
    <span class="s2">&quot;insert into names values(?)&quot;</span><span class="p">,</span>
    <span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;file1&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;file7&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;file17&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;file20&quot;</span><span class="p">,),</span>
        <span class="p">(</span><span class="s2">&quot;file3&quot;</span><span class="p">,),</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standard sorting&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from names order by name&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">str_num_collate</span><span class="p">(</span>
    <span class="n">s1</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span><span class="p">,</span> <span class="n">s2</span><span class="p">:</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLiteValue</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># return -1 if s1&lt;s2, +1 if s1&gt;s2 else 0 for equal</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parts</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="s2">&quot;Converts str into list of alternating str and int parts&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="n">ps1</span> <span class="o">=</span> <span class="n">parts</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
    <span class="n">ps2</span> <span class="o">=</span> <span class="n">parts</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span>

    <span class="c1"># compare</span>
    <span class="k">if</span> <span class="n">ps1</span> <span class="o">&lt;</span> <span class="n">ps2</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">ps1</span> <span class="o">&gt;</span> <span class="n">ps2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="n">connection</span><span class="o">.</span><span class="n">create_collation</span><span class="p">(</span><span class="s2">&quot;strnum&quot;</span><span class="p">,</span> <span class="n">str_num_collate</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using strnum&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select * from names order by name collate strnum&quot;</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">Standard sorting</span>
<span class="go">(&#39;file1&#39;,)</span>
<span class="go">(&#39;file17&#39;,)</span>
<span class="go">(&#39;file20&#39;,)</span>
<span class="go">(&#39;file3&#39;,)</span>
<span class="go">(&#39;file7&#39;,)</span>

<span class="go">Using strnum</span>
<span class="go">(&#39;file1&#39;,)</span>
<span class="go">(&#39;file3&#39;,)</span>
<span class="go">(&#39;file7&#39;,)</span>
<span class="go">(&#39;file17&#39;,)</span>
<span class="go">(&#39;file20&#39;,)</span>
</pre></div>
</div>
</section>
<section id="accessing-results-by-column-name">
<span id="example-colnames"></span><span id="index-17"></span><h2>Accessing results by column name<a class="headerlink" href="#accessing-results-by-column-name" title="Link to this heading"></a></h2>
<p>You can access results by column name using <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html#module-dataclasses" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">dataclasses</span></code></a>.
APSW provides <a class="reference internal" href="ext.html#apsw.ext.DataClassRowFactory" title="apsw.ext.DataClassRowFactory"><code class="xref py py-class docutils literal notranslate"><span class="pre">apsw.ext.DataClassRowFactory</span></code></a> for names.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">apsw.ext</span>

<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create table books(id, title, author, year);</span>
<span class="sd">    insert into books values(7, &#39;Animal Farm&#39;, &#39;George Orwell&#39;, 1945);</span>
<span class="sd">    insert into books values(37, &#39;The Picture of Dorian Gray&#39;, &#39;Oscar Wilde&#39;, 1890);</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="c1"># Normally you use column numbers</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;select title, id, year from books where author=?&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;Oscar Wilde&quot;</span><span class="p">,),</span>
<span class="p">):</span>
    <span class="c1"># this is very fragile</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># Turn on dataclasses - frozen makes them read-only</span>
<span class="n">connection</span><span class="o">.</span><span class="n">row_trace</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">DataClassRowFactory</span><span class="p">(</span>
    <span class="n">dataclass_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;frozen&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Now with dataclasses</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Same query - note using AS to set column name</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SELECT title,</span>
<span class="sd">           id AS book_id,</span>
<span class="sd">           year AS book_year</span>
<span class="sd">           FROM books WHERE author = ?&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;Oscar Wilde&quot;</span><span class="p">,),</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">book_id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">book_year</span><span class="p">)</span>

<span class="c1"># clear</span>
<span class="n">connection</span><span class="o">.</span><span class="n">row_trace</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">title The Picture of Dorian Gray</span>
<span class="go">id 37</span>
<span class="go">year 1890</span>

<span class="go">Now with dataclasses</span>

<span class="go">title The Picture of Dorian Gray</span>
<span class="go">id 37</span>
<span class="go">year 1890</span>
</pre></div>
</div>
</section>
<section id="type-conversion-into-out-of-database">
<span id="example-type-conversion"></span><span id="index-18"></span><h2>Type conversion into/out of database<a class="headerlink" href="#type-conversion-into-out-of-database" title="Link to this heading"></a></h2>
<p>You can use <a class="reference internal" href="ext.html#apsw.ext.TypesConverterCursorFactory" title="apsw.ext.TypesConverterCursorFactory"><code class="xref py py-class docutils literal notranslate"><span class="pre">apsw.ext.TypesConverterCursorFactory</span></code></a> to do
conversion, both for types you define and for other types.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">apsw.ext</span>

<span class="n">registrar</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">TypesConverterCursorFactory</span><span class="p">()</span>
<span class="n">connection</span><span class="o">.</span><span class="n">cursor_factory</span> <span class="o">=</span> <span class="n">registrar</span>


<span class="c1"># A type we define - deriving from SQLiteTypeAdapter automatically registers conversion</span>
<span class="c1"># to a SQLite value</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Point</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">SQLiteTypeAdapter</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Point(</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_sqlite_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># called to convert Point into something SQLite supports</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="si">}</span><span class="s2">;</span><span class="si">{</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># This converter will be registered</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_from_sqlite</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Point</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)))</span>


<span class="c1"># Existing types</span>
<span class="k">def</span><span class="w"> </span><span class="nf">complex_to_sqlite_value</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="nb">complex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">real</span><span class="w"> </span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">imag</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">datetime_to_sqlite_value</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="c1"># Represent as floating point UTC value no matter</span>
    <span class="c1"># what timezone is used. Also consider other</span>
    <span class="c1"># formats like ISO8601.</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>


<span class="c1"># ... require manual registration</span>
<span class="n">registrar</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="nb">complex</span><span class="p">,</span> <span class="n">complex_to_sqlite_value</span><span class="p">)</span>
<span class="n">registrar</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime_to_sqlite_value</span>
<span class="p">)</span>

<span class="c1"># conversion from a SQLite value requires registration</span>
<span class="n">registrar</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="n">Point</span><span class="o">.</span><span class="n">convert_from_sqlite</span><span class="p">)</span>


<span class="c1"># ... and for stdlib types</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sqlite_to_complex</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">complex</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">complex</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sqlite_to_datetime</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
    <span class="c1"># Keep the UTC values coming back from the database</span>
    <span class="c1"># as UTC</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>


<span class="n">registrar</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;COMPLEX&quot;</span><span class="p">,</span> <span class="n">sqlite_to_complex</span><span class="p">)</span>
<span class="n">registrar</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">,</span> <span class="n">sqlite_to_datetime</span><span class="p">)</span>

<span class="c1"># note that the type names are case sensitive and must match the</span>
<span class="c1"># registration</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;create table conversion(p POINT, c COMPLEX, t TIMESTAMP)&quot;</span>
<span class="p">)</span>

<span class="c1"># convert going into database</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mf">5.2</span><span class="p">,</span> <span class="mf">7.6</span><span class="p">),</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="n">j</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;insert into conversion values(?, ?, ?)&quot;</span><span class="p">,</span> <span class="n">test_data</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inserted&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>

<span class="c1"># and coming back out</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;querying data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from conversion&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;column </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># clear registrar</span>
<span class="n">connection</span><span class="o">.</span><span class="n">cursor_factory</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Cursor</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">inserted (Point(5.2, 7.6), (3+4j), datetime.datetime(2025, 2, 18, 7, 32, 56, 377644))</span>
<span class="go">querying data</span>
<span class="go">column 0 = Point(5.2, 7.6)</span>
<span class="go">column 1 = (3+4j)</span>
<span class="go">column 2 = datetime.datetime(2025, 2, 18, 15, 32, 56, 377644, tzinfo=datetime.timezone.utc)</span>
</pre></div>
</div>
</section>
<section id="runtime-python-objects">
<span id="example-pyobject"></span><span id="index-19"></span><h2>Runtime Python objects<a class="headerlink" href="#runtime-python-objects" title="Link to this heading"></a></h2>
<p>While only <a class="reference internal" href="tips.html#types"><span class="std std-ref">5 types</span></a> can be stored, you can pass any
Python objects <a class="reference internal" href="tips.html#pyobject"><span class="std std-ref">to and from your functions</span></a> at
runtime.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python set which isn&#39;t a supported SQLite type</span>
<span class="c1"># containing items like a complex number and stdout which</span>
<span class="c1"># definitely aren&#39;t SQLite compatible</span>
<span class="n">py_value</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">5</span><span class="n">j</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">}</span>

<span class="c1"># Trying to pass it as a value gives TypeError</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">py_value</span><span class="p">,))</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

<span class="c1"># Now wrap it and it works</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;select ?&quot;</span><span class="p">,</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(</span><span class="n">py_value</span><span class="p">),))</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># It is still null at the SQL level</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;select typeof(?)&quot;</span><span class="p">,</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;select typeof(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(</span><span class="n">py_value</span><span class="p">),)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># Lets make a set which SQLite knows nothing about</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_set</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;make_set got </span><span class="si">{</span><span class="n">args</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># this will return a set, so we also need to mark it</span>
    <span class="k">return</span> <span class="n">apsw</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>


<span class="n">connection</span><span class="o">.</span><span class="n">create_scalar_function</span><span class="p">(</span><span class="s2">&quot;make_set&quot;</span><span class="p">,</span> <span class="n">make_set</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;select make_set(?, ?, ?)&quot;</span><span class="p">,</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;select make_set(?, ?, ?)&quot;</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="c1"># these aren&#39;t SQLite types</span>
            <span class="n">apsw</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="n">j</span><span class="p">),</span>
            <span class="n">apsw</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">),</span>
            <span class="c1"># but a string is</span>
            <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">Bad binding argument type supplied - argument #1: type set</span>
<span class="go">select ? {1, 2, &#39;three&#39;, (4+5j), &lt;_io.StringIO object at 0x7452b51977c0&gt;}</span>
<span class="go">select typeof(?) null</span>
<span class="go">make_set got ((3+4j), &lt;_io.TextIOWrapper name=&#39;&lt;stdin&gt;&#39; mode=&#39;r&#39; encoding=&#39;utf-8&#39;&gt;, &#39;hello&#39;)</span>
<span class="go">select make_set(?, ?, ?) {&#39;hello&#39;, &lt;_io.TextIOWrapper name=&#39;&lt;stdin&gt;&#39; mode=&#39;r&#39; encoding=&#39;utf-8&#39;&gt;, (3+4j)}</span>
</pre></div>
</div>
</section>
<section id="query-limiting">
<span id="example-query-limit"></span><span id="index-20"></span><h2>Query limiting<a class="headerlink" href="#query-limiting" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="ext.html#apsw.ext.query_limit" title="apsw.ext.query_limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.query_limit()</span></code></a> limits rows and time in a block
across all the queries within the block</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">apsw.ext</span>

<span class="c1"># Use this to make many (virtual) rows</span>
<span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">make_virtual_module</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;generate_series&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">generate_series</span>
<span class="p">)</span>

<span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">query_limit</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">row_limit</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="c1"># 11 rows will come from this</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">number</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;select * from generate_series(0, 10)&quot;</span>
    <span class="p">):</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="c1"># next query would be 1,000 but we will hit</span>
    <span class="c1"># the limit</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">number</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;select * from generate_series(0, 999)&quot;</span>
    <span class="p">):</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

<span class="c1"># lets see what we got</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># We can also time limit</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
<span class="k">with</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">query_limit</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">number</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;select * from generate_series(0, 1000000000)&quot;</span>
    <span class="p">):</span>
        <span class="k">pass</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds, we hit </span><span class="si">{</span><span class="n">number</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># We used the default &quot;no exception&quot; exception.  Lets have an explicit exception.</span>
<span class="c1"># with both row and time limits ...</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">query_limit</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="n">row_limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">row_exception</span><span class="o">=</span><span class="ne">IndexError</span><span class="p">,</span>
        <span class="n">timeout_exception</span><span class="o">=</span><span class="ne">TimeoutError</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">number</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;select * from generate_series(0, 1000000000)&quot;</span>
        <span class="p">):</span>
            <span class="k">pass</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exc</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">len(rows)=20</span>
<span class="go">After 0.200 seconds, we hit number=232929</span>
<span class="go">exc=IndexError(&#39;query row limit hit&#39;)</span>
</pre></div>
</div>
</section>
<section id="query-details">
<span id="example-query-details"></span><span id="index-21"></span><h2>Query details<a class="headerlink" href="#query-details" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="ext.html#apsw.ext.query_info" title="apsw.ext.query_info"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.query_info()</span></code></a> can provide a lot of information about a
query (without running it)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">apsw.ext</span>

<span class="c1"># test tables</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create table customers(</span>
<span class="sd">        id INTEGER PRIMARY KEY,</span>
<span class="sd">        name CHAR,</span>
<span class="sd">        address CHAR);</span>
<span class="sd">    create table orders(</span>
<span class="sd">        id INTEGER PRIMARY KEY,</span>
<span class="sd">        customer_id INTEGER,</span>
<span class="sd">        item MY_OWN_TYPE);</span>
<span class="sd">    create index cust_addr on customers(address);</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT * FROM orders</span>
<span class="s2">    JOIN customers ON orders.customer_id=customers.id</span>
<span class="s2">    WHERE address = ?;</span>
<span class="s2">    SELECT 7;&quot;&quot;&quot;</span>

<span class="c1"># ask for all information available</span>
<span class="n">qd</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">query_info</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">actions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># which tables/views etc and how they are accessed</span>
    <span class="n">explain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># shows low level VDBE</span>
    <span class="n">explain_query_plan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># how SQLite solves the query</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">bindings_count&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">bindings_count</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">bindings_names&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">bindings_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">expanded_sql&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">expanded_sql</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">first_query&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">first_query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">query_remaining&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">query_remaining</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">is_explain&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">is_explain</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">is_readonly&quot;</span><span class="p">,</span> <span class="n">qd</span><span class="o">.</span><span class="n">is_readonly</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">description&quot;</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qd</span><span class="p">,</span> <span class="s2">&quot;description_full&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">description_full&quot;</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">description_full</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">query_plan&quot;</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">query_plan</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 5 actions&quot;</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">actions</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 5 explain&quot;</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">qd</span><span class="o">.</span><span class="n">explain</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">query</span>
<span class="go">    SELECT * FROM orders</span>
<span class="go">    JOIN customers ON orders.customer_id=customers.id</span>
<span class="go">    WHERE address = ?;</span>
<span class="go">    SELECT 7;</span>

<span class="go">bindings_count 1</span>

<span class="go">bindings_names (None,)</span>

<span class="go">expanded_sql None</span>

<span class="go">first_query</span>
<span class="go">    SELECT * FROM orders</span>
<span class="go">    JOIN customers ON orders.customer_id=customers.id</span>
<span class="go">    WHERE address = ?;</span>


<span class="go">query_remaining SELECT 7;</span>

<span class="go">is_explain 0</span>

<span class="go">is_readonly True</span>

<span class="go">description</span>
<span class="go">((&#39;id&#39;, &#39;INTEGER&#39;),</span>
<span class="go"> (&#39;customer_id&#39;, &#39;INTEGER&#39;),</span>
<span class="go"> (&#39;item&#39;, &#39;MY_OWN_TYPE&#39;),</span>
<span class="go"> (&#39;id&#39;, &#39;INTEGER&#39;),</span>
<span class="go"> (&#39;name&#39;, &#39;CHAR&#39;),</span>
<span class="go"> (&#39;address&#39;, &#39;CHAR&#39;))</span>

<span class="go">description_full</span>
<span class="go">None</span>

<span class="go">query_plan</span>
<span class="go">QueryPlan(detail=&#39;QUERY PLAN&#39;,</span>
<span class="go">          sub=[QueryPlan(detail=&#39;SCAN orders&#39;, sub=None),</span>
<span class="go">               QueryPlan(detail=&#39;SEARCH customers USING INTEGER PRIMARY KEY &#39;</span>
<span class="go">                                &#39;(rowid=?)&#39;,</span>
<span class="go">                         sub=None)])</span>

<span class="go">First 5 actions</span>
<span class="go">[QueryAction(action=21,</span>
<span class="go">             action_name=&#39;SQLITE_SELECT&#39;,</span>
<span class="go">             column_name=None,</span>
<span class="go">             database_name=None,</span>
<span class="go">             file_name=None,</span>
<span class="go">             function_name=None,</span>
<span class="go">             module_name=None,</span>
<span class="go">             operation=None,</span>
<span class="go">             pragma_name=None,</span>
<span class="go">             pragma_value=None,</span>
<span class="go">             table_name=None,</span>
<span class="go">             trigger_name=None,</span>
<span class="go">             trigger_or_view=None,</span>
<span class="go">             view_name=None),</span>
<span class="go"> QueryAction(action=20,</span>
<span class="go">             action_name=&#39;SQLITE_READ&#39;,</span>
<span class="go">             column_name=&#39;id&#39;,</span>
<span class="go">             database_name=&#39;main&#39;,</span>
<span class="go">             file_name=None,</span>
<span class="go">             function_name=None,</span>
<span class="go">             module_name=None,</span>
<span class="go">             operation=None,</span>
<span class="go">             pragma_name=None,</span>
<span class="go">             pragma_value=None,</span>
<span class="go">             table_name=&#39;orders&#39;,</span>
<span class="go">             trigger_name=None,</span>
<span class="go">             trigger_or_view=None,</span>
<span class="go">             view_name=None),</span>
<span class="go"> QueryAction(action=20,</span>
<span class="go">             action_name=&#39;SQLITE_READ&#39;,</span>
<span class="go">             column_name=&#39;customer_id&#39;,</span>
<span class="go">             database_name=&#39;main&#39;,</span>
<span class="go">             file_name=None,</span>
<span class="go">             function_name=None,</span>
<span class="go">             module_name=None,</span>
<span class="go">             operation=None,</span>
<span class="go">             pragma_name=None,</span>
<span class="go">             pragma_value=None,</span>
<span class="go">             table_name=&#39;orders&#39;,</span>
<span class="go">             trigger_name=None,</span>
<span class="go">             trigger_or_view=None,</span>
<span class="go">             view_name=None),</span>
<span class="go"> QueryAction(action=20,</span>
<span class="go">             action_name=&#39;SQLITE_READ&#39;,</span>
<span class="go">             column_name=&#39;item&#39;,</span>
<span class="go">             database_name=&#39;main&#39;,</span>
<span class="go">             file_name=None,</span>
<span class="go">             function_name=None,</span>
<span class="go">             module_name=None,</span>
<span class="go">             operation=None,</span>
<span class="go">             pragma_name=None,</span>
<span class="go">             pragma_value=None,</span>
<span class="go">             table_name=&#39;orders&#39;,</span>
<span class="go">             trigger_name=None,</span>
<span class="go">             trigger_or_view=None,</span>
<span class="go">             view_name=None),</span>
<span class="go"> QueryAction(action=20,</span>
<span class="go">             action_name=&#39;SQLITE_READ&#39;,</span>
<span class="go">             column_name=&#39;id&#39;,</span>
<span class="go">             database_name=&#39;main&#39;,</span>
<span class="go">             file_name=None,</span>
<span class="go">             function_name=None,</span>
<span class="go">             module_name=None,</span>
<span class="go">             operation=None,</span>
<span class="go">             pragma_name=None,</span>
<span class="go">             pragma_value=None,</span>
<span class="go">             table_name=&#39;customers&#39;,</span>
<span class="go">             trigger_name=None,</span>
<span class="go">             trigger_or_view=None,</span>
<span class="go">             view_name=None)]</span>

<span class="go">First 5 explain</span>
<span class="go">[VDBEInstruction(addr=0,</span>
<span class="go">                 opcode=&#39;Init&#39;,</span>
<span class="go">                 comment=None,</span>
<span class="go">                 p1=0,</span>
<span class="go">                 p2=17,</span>
<span class="go">                 p3=0,</span>
<span class="go">                 p4=None,</span>
<span class="go">                 p5=0),</span>
<span class="go"> VDBEInstruction(addr=1,</span>
<span class="go">                 opcode=&#39;OpenRead&#39;,</span>
<span class="go">                 comment=None,</span>
<span class="go">                 p1=0,</span>
<span class="go">                 p2=12,</span>
<span class="go">                 p3=0,</span>
<span class="go">                 p4=&#39;3&#39;,</span>
<span class="go">                 p5=0),</span>
<span class="go"> VDBEInstruction(addr=2,</span>
<span class="go">                 opcode=&#39;OpenRead&#39;,</span>
<span class="go">                 comment=None,</span>
<span class="go">                 p1=1,</span>
<span class="go">                 p2=11,</span>
<span class="go">                 p3=0,</span>
<span class="go">                 p4=&#39;3&#39;,</span>
<span class="go">                 p5=0),</span>
<span class="go"> VDBEInstruction(addr=3,</span>
<span class="go">                 opcode=&#39;Rewind&#39;,</span>
<span class="go">                 comment=None,</span>
<span class="go">                 p1=0,</span>
<span class="go">                 p2=16,</span>
<span class="go">                 p3=0,</span>
<span class="go">                 p4=None,</span>
<span class="go">                 p5=0),</span>
<span class="go"> VDBEInstruction(addr=4,</span>
<span class="go">                 opcode=&#39;Column&#39;,</span>
<span class="go">                 comment=None,</span>
<span class="go">                 p1=0,</span>
<span class="go">                 p2=1,</span>
<span class="go">                 p3=1,</span>
<span class="go">                 p4=None,</span>
<span class="go">                 p5=0)]</span>
</pre></div>
</div>
</section>
<section id="blob-i-o">
<span id="example-blob-io"></span><span id="index-22"></span><h2>Blob I/O<a class="headerlink" href="#blob-i-o" title="Link to this heading"></a></h2>
<p>BLOBS (binary large objects) are supported by SQLite.  Note that you
cannot change the size of one, but you can allocate one filled with
zeroes, and then later open it and read / write the contents similar
to a file, without having the entire blob in memory.  Use
<a class="reference internal" href="connection.html#apsw.Connection.blob_open" title="apsw.Connection.blob_open"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.blob_open()</span></code></a> to open a blob.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table blobby(x,y)&quot;</span><span class="p">)</span>
<span class="c1"># Add a blob we will fill in later</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into blobby values(1, zeroblob(10000))&quot;</span><span class="p">)</span>
<span class="c1"># Or as a binding</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;insert into blobby values(2, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">zeroblob</span><span class="p">(</span><span class="mi">20000</span><span class="p">),)</span>
<span class="p">)</span>
<span class="c1"># Open a blob for writing.  We need to know the rowid</span>
<span class="n">rowid</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select ROWID from blobby where x=1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
<span class="n">blob</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">blob_open</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;blobby&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">rowid</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">blob</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="n">blob</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
<span class="n">blob</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="c1"># seek relative to the end</span>
<span class="n">blob</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">blob</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;hello world, again&quot;</span><span class="p">)</span>
<span class="n">blob</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="backup-an-open-database">
<span id="example-backup"></span><span id="index-23"></span><h2>Backup an open database<a class="headerlink" href="#backup-an-open-database" title="Link to this heading"></a></h2>
<p>You can <a class="reference internal" href="backup.html#backup"><span class="std std-ref">backup</span></a> a database that is open.  The pages are copied in
batches of your choosing and allow continued use of the source
database.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will copy a disk database into this memory database</span>
<span class="n">destination</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>

<span class="c1"># Copy into destination</span>
<span class="k">with</span> <span class="n">destination</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">backup</span><span class="p">:</span>
    <span class="c1"># The source database can change while doing the backup</span>
    <span class="c1"># and the backup will still pick up those changes</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">backup</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
        <span class="n">backup</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># copy up to 7 pages each time</span>
        <span class="c1"># monitor progress</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">backup</span><span class="o">.</span><span class="n">remaining</span><span class="p">,</span> <span class="n">backup</span><span class="o">.</span><span class="n">page_count</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">15 22</span>
<span class="go">8 22</span>
<span class="go">1 22</span>
<span class="go">0 22</span>
</pre></div>
</div>
</section>
<section id="authorizer-control-what-sql-can-do">
<span id="example-authorizer"></span><span id="index-24"></span><h2>Authorizer (control what SQL can do)<a class="headerlink" href="#authorizer-control-what-sql-can-do" title="Link to this heading"></a></h2>
<p>You can allow, deny, or ignore what SQL does.  Use
<a class="reference internal" href="connection.html#apsw.Connection.authorizer" title="apsw.Connection.authorizer"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Connection.authorizer</span></code></a> to set an authorizer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">auth</span><span class="p">(</span>
    <span class="n">operation</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">p1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">p2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">db_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">trigger_or_view</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Called when each operation is prepared.  We can return SQLITE_OK, SQLITE_DENY or</span>
<span class="sd">    SQLITE_IGNORE&quot;&quot;&quot;</span>
    <span class="c1"># find the operation name</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_authorizer_function</span><span class="p">[</span><span class="n">operation</span><span class="p">],</span>
        <span class="n">p1</span><span class="p">,</span>
        <span class="n">p2</span><span class="p">,</span>
        <span class="n">db_name</span><span class="p">,</span>
        <span class="n">trigger_or_view</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">operation</span> <span class="o">==</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_CREATE_TABLE</span>
        <span class="ow">and</span> <span class="n">p1</span>
        <span class="ow">and</span> <span class="n">p1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;private&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_DENY</span>  <span class="c1"># not allowed to create tables whose names start with private</span>

    <span class="k">return</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OK</span>  <span class="c1"># always allow</span>


<span class="n">connection</span><span class="o">.</span><span class="n">authorizer</span> <span class="o">=</span> <span class="n">auth</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into names values(&#39;foo&#39;)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select name from names limit 1&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table private_stuff(secret)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created secret table!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c1"># Clear authorizer</span>
<span class="n">connection</span><span class="o">.</span><span class="n">authorizer</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">SQLITE_INSERT names None main None</span>
<span class="go">SQLITE_SELECT None None None None</span>
<span class="go">SQLITE_READ names name main None</span>
<span class="go">SQLITE_INSERT sqlite_master None main None</span>
<span class="go">SQLITE_CREATE_TABLE private_stuff None main None</span>
<span class="go">not authorized</span>
</pre></div>
</div>
</section>
<section id="progress-handler">
<span id="example-progress-handler"></span><span id="index-25"></span><h2>Progress handler<a class="headerlink" href="#progress-handler" title="Link to this heading"></a></h2>
<p>Some operations (eg joins, sorting) can take many operations to
complete.  Register a progress handler callback with
<a class="reference internal" href="connection.html#apsw.Connection.set_progress_handler" title="apsw.Connection.set_progress_handler"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.set_progress_handler()</span></code></a> which lets you provide
feedback and allows cancelling.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a table with random numbers</span>
<span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table numbers(x)&quot;</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
        <span class="s2">&quot;insert into numbers values(?)&quot;</span><span class="p">,</span>
        <span class="p">((</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999999999</span><span class="p">),)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">progress_handler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;progress handler called&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># returning True aborts</span>


<span class="c1"># register handler every 50 vdbe instructions</span>
<span class="n">connection</span><span class="o">.</span><span class="n">set_progress_handler</span><span class="p">(</span><span class="n">progress_handler</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Sorting the numbers to find the biggest</span>
<span class="k">for</span> <span class="n">max_num</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select max(x) from numbers&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">max_num</span><span class="p">)</span>

<span class="c1"># Clear handler</span>
<span class="n">connection</span><span class="o">.</span><span class="n">set_progress_handler</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">progress handler called</span>
<span class="go">(9901161753,)</span>
</pre></div>
</div>
</section>
<section id="file-control">
<span id="example-filecontrol"></span><span id="index-26"></span><h2>File Control<a class="headerlink" href="#file-control" title="Link to this heading"></a></h2>
<p>We can get/set low level information using the
<a class="reference internal" href="connection.html#apsw.Connection.file_control" title="apsw.Connection.file_control"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.file_control()</span></code></a> interface.  In this example we get
the <a class="reference external" href="https://sqlite.org/c3ref/c_fcntl_begin_atomic_write.html#sqlitefcntldataversion">data version</a>.
There is a <a class="reference external" href="https://sqlite.org/pragma.html#pragma_data_version">pragma</a> but it
doesn’t change for commits on the same connection.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We use ctypes to provide the correct C level data types and pointers</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_data_version</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="c1"># unsigned 32 bit integer</span>
    <span class="n">data_version</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">file_control</span><span class="p">(</span>
        <span class="s2">&quot;main&quot;</span><span class="p">,</span>  <span class="c1"># or an attached database name</span>
        <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_FCNTL_DATA_VERSION</span><span class="p">,</span>  <span class="c1"># code</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">addressof</span><span class="p">(</span><span class="n">data_version</span><span class="p">),</span>
    <span class="p">)</span>  <span class="c1"># pass C level pointer</span>
    <span class="k">assert</span> <span class="n">ok</span><span class="p">,</span> <span class="s2">&quot;SQLITE_FCNTL_DATA_VERSION was not understood!&quot;</span>
    <span class="k">return</span> <span class="n">data_version</span><span class="o">.</span><span class="n">value</span>


<span class="c1"># Show starting values</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;fcntl&quot;</span><span class="p">,</span>
    <span class="n">get_data_version</span><span class="p">(</span><span class="n">connection</span><span class="p">),</span>
    <span class="s2">&quot;pragma&quot;</span><span class="p">,</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;data_version&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># See the fcntl value versus pragma value</span>
<span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="p">(</span>
    <span class="s2">&quot;create table fcntl_example(x)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;begin ; insert into fcntl_example values(3)&quot;</span><span class="p">,</span>
    <span class="c1"># we can see the version doesn&#39;t change inside a transaction</span>
    <span class="s2">&quot;insert into fcntl_example values(4)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;commit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pragma user_version=1234&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;fcntl&quot;</span><span class="p">,</span>
        <span class="n">get_data_version</span><span class="p">(</span><span class="n">connection</span><span class="p">),</span>
        <span class="s2">&quot;pragma&quot;</span><span class="p">,</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;data_version&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">fcntl 40 pragma 2</span>
<span class="go">create table fcntl_example(x)</span>
<span class="go">fcntl 41 pragma 2</span>
<span class="go">begin ; insert into fcntl_example values(3)</span>
<span class="go">fcntl 41 pragma 2</span>
<span class="go">insert into fcntl_example values(4)</span>
<span class="go">fcntl 41 pragma 2</span>
<span class="go">commit</span>
<span class="go">fcntl 42 pragma 2</span>
<span class="go">pragma user_version=1234</span>
<span class="go">fcntl 43 pragma 2</span>
</pre></div>
</div>
</section>
<section id="commit-hook">
<span id="example-commit-hook"></span><span id="index-27"></span><h2>Commit hook<a class="headerlink" href="#commit-hook" title="Link to this heading"></a></h2>
<p>A commit hook can allow or veto commits.  Register a commit hook
with  <a class="reference internal" href="connection.html#apsw.Connection.set_commit_hook" title="apsw.Connection.set_commit_hook"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.set_commit_hook()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_commit_hook</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in commit hook&quot;</span><span class="p">)</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;commits okay at this time&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># let commit go ahead</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no commits out of hours&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># abort commits outside of 8am through 6pm</span>


<span class="n">connection</span><span class="o">.</span><span class="n">set_commit_hook</span><span class="p">(</span><span class="n">my_commit_hook</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;create table example(x,y,z);</span>
<span class="sd">                           insert into example values (3,4,5)&quot;&quot;&quot;</span>
        <span class="p">)</span>
<span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ConstraintError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;commit was not allowed&quot;</span><span class="p">)</span>

<span class="n">connection</span><span class="o">.</span><span class="n">set_commit_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">in commit hook</span>
<span class="go">no commits out of hours</span>
<span class="go">commit was not allowed</span>
</pre></div>
</div>
</section>
<section id="update-hook">
<span id="example-update-hook"></span><span id="index-28"></span><h2>Update hook<a class="headerlink" href="#update-hook" title="Link to this heading"></a></h2>
<p>Update hooks let you know that data has been added, changed, or
removed.  For example you could use this to discard cached
information.  Register a hook using
<a class="reference internal" href="connection.html#apsw.Connection.set_update_hook" title="apsw.Connection.set_update_hook"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.set_update_hook()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_update_hook</span><span class="p">(</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rowid</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">op</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_authorizer_function</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Updated: </span><span class="si">{</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="si">}</span><span class="s2"> db </span><span class="si">{</span><span class="w"> </span><span class="n">db_name</span><span class="w"> </span><span class="si">}</span><span class="s2">, table </span><span class="si">{</span><span class="w"> </span><span class="n">table_name</span><span class="w"> </span><span class="si">}</span><span class="s2">, rowid </span><span class="si">{</span><span class="w"> </span><span class="n">rowid</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<span class="n">connection</span><span class="o">.</span><span class="n">set_update_hook</span><span class="p">(</span><span class="n">my_update_hook</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into names values(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;file93&quot;</span><span class="p">,))</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;update names set name=? where name=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;file94&quot;</span><span class="p">,</span> <span class="s2">&quot;file93&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;delete from names where name=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;file94&quot;</span><span class="p">,))</span>

<span class="c1"># Clear the hook</span>
<span class="n">connection</span><span class="o">.</span><span class="n">set_update_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">Updated: SQLITE_INSERT db main, table names, rowid 7</span>
<span class="go">Updated: SQLITE_UPDATE db main, table names, rowid 7</span>
<span class="go">Updated: SQLITE_DELETE db main, table names, rowid 7</span>
</pre></div>
</div>
</section>
<section id="virtual-tables">
<span id="example-virtual-tables"></span><span id="index-29"></span><h2>Virtual tables<a class="headerlink" href="#virtual-tables" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="vtable.html#virtualtables"><span class="std std-ref">Virtual tables</span></a> let you provide data on demand
as a SQLite table so you can use SQL queries against that data.
Writing your own virtual table requires understanding how to return
less than all the data via the <a class="reference external" href="https://www.sqlite.org/vtab.html#the_xbestindex_method">BestIndex</a> method.</p>
<p>You can export a Python function as a virtual table in 3 lines of
code using <a class="reference internal" href="ext.html#apsw.ext.make_virtual_module" title="apsw.ext.make_virtual_module"><code class="xref py py-func docutils literal notranslate"><span class="pre">apsw.ext.make_virtual_module()</span></code></a>, being able to
provide both positional and keyword arguments.</p>
<p>For the first example you’ll find <a class="reference internal" href="ext.html#apsw.ext.generate_series" title="apsw.ext.generate_series"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.generate_series()</span></code></a>
useful instead.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Yield a row at a time</span>
<span class="k">def</span><span class="w"> </span><span class="nf">table_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span>


<span class="c1"># set column names</span>
<span class="n">table_range</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,)</span>
<span class="c1"># set how to access what table_range returns</span>
<span class="n">table_range</span><span class="o">.</span><span class="n">column_access</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">VTColumnAccess</span><span class="o">.</span><span class="n">By_Index</span>

<span class="c1"># register it</span>
<span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">make_virtual_module</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="n">table_range</span><span class="p">)</span>

<span class="c1"># see it work.  we can provide both positional and keyword</span>
<span class="c1"># arguments</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM range(90) WHERE step=2&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>

<span class="c1"># the parameters are hidden columns so &#39;*&#39; doesn&#39;t select them</span>
<span class="c1"># but you can ask</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT *, start, stop, step FROM range(89) WHERE step=3&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>

<span class="c1"># Expose the unicode database.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unicodedata</span>

<span class="c1"># A more complex example exporting unicodedata module</span>

<span class="c1"># The methods we will call on each codepoint</span>
<span class="n">unicode_methods</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;decimal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;digit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;numeric&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">,</span>
    <span class="s2">&quot;combining&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bidirectional&quot;</span><span class="p">,</span>
    <span class="s2">&quot;east_asian_width&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mirrored&quot;</span><span class="p">,</span>
    <span class="s2">&quot;decomposition&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># the function we will turn into a virtual table returning</span>
<span class="c1"># each row as a dict</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unicode_data</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxunicode</span><span class="p">):</span>
    <span class="c1"># some methods raise ValueError on some codepoints</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="n">meth</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">unicodedata</span><span class="p">,</span> <span class="n">meth</span><span class="p">)(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">call</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unicode_methods</span><span class="p">}</span>


<span class="c1"># setup column names and access</span>
<span class="n">unicode_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">unicode_methods</span>
<span class="n">unicode_data</span><span class="o">.</span><span class="n">column_access</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">VTColumnAccess</span><span class="o">.</span><span class="n">By_Name</span>

<span class="c1"># register</span>
<span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">make_virtual_module</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;unicode_data&quot;</span><span class="p">,</span> <span class="n">unicode_data</span><span class="p">)</span>

<span class="c1"># how many codepoints are in each category?</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT count(*), category FROM unicode_data</span>
<span class="s2">       WHERE stop = 0xffff  -- BMP only</span>
<span class="s2">       GROUP BY category</span>
<span class="s2">       ORDER BY category</span>
<span class="s2">       LIMIT 10&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>


<span class="c1"># A more complex example - given a list of directories return information</span>
<span class="c1"># about the files within them recursively</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_files_info</span><span class="p">(</span>
    <span class="n">directories</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">ignore_symlinks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">directories</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="k">as</span> <span class="n">sd</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ignore_symlinks</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="k">yield from</span> <span class="n">get_files_info</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                        <span class="n">ignore_symlinks</span><span class="o">=</span><span class="n">ignore_symlinks</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="p">{</span>
                        <span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="n">root</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="o">**</span><span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">get_files_info</span><span class="o">.</span><span class="n">stat_columns</span>
                        <span class="p">},</span>
                    <span class="p">}</span>


<span class="c1"># which stat columns do we want?</span>
<span class="n">get_files_info</span><span class="o">.</span><span class="n">stat_columns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
    <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;st_&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># setup columns and access by providing an example of the first entry returned</span>
<span class="p">(</span>
    <span class="n">get_files_info</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">get_files_info</span><span class="o">.</span><span class="n">column_access</span><span class="p">,</span>
<span class="p">)</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">get_files_info</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)))</span>

<span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">make_virtual_module</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;files_info&quot;</span><span class="p">,</span> <span class="n">get_files_info</span><span class="p">)</span>

<span class="c1"># all the sys.path directories</span>
<span class="n">bindings</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">p</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1">#  except our current one</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Find the 3 biggest files that aren&#39;t libraries</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT st_size, directory, name</span>
<span class="s2">            FROM files_info(?)</span>
<span class="s2">            WHERE extension NOT IN (&#39;.a&#39;, &#39;.so&#39;)</span>
<span class="s2">            ORDER BY st_size DESC</span>
<span class="s2">            LIMIT 3&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">bindings</span><span class="p">))</span>

<span class="c1"># Find the 3 oldest Python files</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT DATE(st_ctime, &#39;auto&#39;) AS date, directory, name</span>
<span class="s2">            FROM files_info(?)</span>
<span class="s2">            WHERE extension=&#39;.py&#39;</span>
<span class="s2">            ORDER BY st_size DESC</span>
<span class="s2">            LIMIT 3&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">bindings</span><span class="p">))</span>

<span class="c1"># find space used by filename extension</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT extension, SUM(st_size) as total_size</span>
<span class="s2">            FROM files_info(?)</span>
<span class="s2">            GROUP BY extension</span>
<span class="s2">            ORDER BY extension&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">bindings</span><span class="p">))</span>

<span class="c1"># unregister a virtual table by passing None</span>
<span class="n">connection</span><span class="o">.</span><span class="n">create_module</span><span class="p">(</span><span class="s2">&quot;files_info&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">┌───────┐</span>
<span class="go">│ value │</span>
<span class="go">│ 90    │</span>
<span class="go">│ 92    │</span>
<span class="go">│ 94    │</span>
<span class="go">│ 96    │</span>
<span class="go">│ 98    │</span>
<span class="go">│ 100   │</span>
<span class="go">└───────┘</span>

<span class="go">┌───────┬───────┬──────┬──────┐</span>
<span class="go">│ value │ start │ stop │ step │</span>
<span class="go">│ 89    │ 89    │ 100  │ 3    │</span>
<span class="go">│ 92    │ 89    │ 100  │ 3    │</span>
<span class="go">│ 95    │ 89    │ 100  │ 3    │</span>
<span class="go">│ 98    │ 89    │ 100  │ 3    │</span>
<span class="go">└───────┴───────┴──────┴──────┘</span>

<span class="go">┌──────────┬──────────┐</span>
<span class="go">│ count(*) │ category │</span>
<span class="go">│ 65       │ Cc       │</span>
<span class="go">│ 43       │ Cf       │</span>
<span class="go">│ 1454     │ Cn       │</span>
<span class="go">│ 6400     │ Co       │</span>
<span class="go">│ 2048     │ Cs       │</span>
<span class="go">│ 1445     │ Ll       │</span>
<span class="go">│ 236      │ Lm       │</span>
<span class="go">│ 46126    │ Lo       │</span>
<span class="go">│ 31       │ Lt       │</span>
<span class="go">│ 1127     │ Lu       │</span>
<span class="go">└──────────┴──────────┘</span>

<span class="go">┌─────────┬──────────────────────────────────────────┬─────────────────────────┐</span>
<span class="go">│ st_size │                directory                 │          name           │</span>
<span class="go">├─────────┼──────────────────────────────────────────┼─────────────────────────┤</span>
<span class="go">│ 815083  │ /usr/lib/python3.12/pydoc_data           │ topics.py               │</span>
<span class="go">├─────────┼──────────────────────────────────────────┼─────────────────────────┤</span>
<span class="go">│ 509199  │ /usr/lib/python3.12/pydoc_data/          │ topics.cpython-312.pyc  │</span>
<span class="go">│         │ __pycache__                              │                         │</span>
<span class="go">├─────────┼──────────────────────────────────────────┼─────────────────────────┤</span>
<span class="go">│ 245940  │ /usr/lib/python3.12/tkinter/__pycache__  │ __init__.cpython-312.p- │</span>
<span class="go">│         │                                          │ yc                      │</span>
<span class="go">└─────────┴──────────────────────────────────────────┴─────────────────────────┘</span>

<span class="go">┌────────────┬────────────────────────────────┬───────────────┐</span>
<span class="go">│    date    │           directory            │     name      │</span>
<span class="go">│ 2025-01-21 │ /usr/lib/python3.12/pydoc_data │ topics.py     │</span>
<span class="go">│ 2025-01-21 │ /usr/lib/python3.12            │ _pydecimal.py │</span>
<span class="go">│ 2025-01-21 │ /usr/lib/python3.12/tkinter    │ __init__.py   │</span>
<span class="go">└────────────┴────────────────────────────────┴───────────────┘</span>

<span class="go">┌────────────┬────────────┐</span>
<span class="go">│ extension  │ total_size │</span>
<span class="go">│            │ 436917     │</span>
<span class="go">│ .a         │ 97345022   │</span>
<span class="go">│ .allowlist │ 72         │</span>
<span class="go">│ .bootstrap │ 1804       │</span>
<span class="go">│ .c         │ 10948      │</span>
<span class="go">│ .cfg       │ 341        │</span>
<span class="go">│ .csh       │ 934        │</span>
<span class="go">│ .css       │ 1325       │</span>
<span class="go">│ .fish      │ 2209       │</span>
<span class="go">│ .in        │ 3504       │</span>
<span class="go">│ .ini       │ 997        │</span>
<span class="go">│ .json      │ 2162       │</span>
<span class="go">│ .local     │ 2136       │</span>
<span class="go">│ .o         │ 9360       │</span>
<span class="go">│ .ps1       │ 9033       │</span>
<span class="go">│ .py        │ 11265551   │</span>
<span class="go">│ .pyc       │ 11429603   │</span>
<span class="go">│ .rst       │ 9561       │</span>
<span class="go">│ .sh        │ 2643       │</span>
<span class="go">│ .so        │ 26583424   │</span>
<span class="go">│ .sql       │ 1001       │</span>
<span class="go">│ .stdlib    │ 12562      │</span>
<span class="go">│ .supp      │ 70         │</span>
<span class="go">│ .txt       │ 13936      │</span>
<span class="go">└────────────┴────────────┘</span>
</pre></div>
</div>
</section>
<section id="vfs-virtual-file-system">
<span id="example-vfs"></span><span id="index-30"></span><h2>VFS - Virtual File System<a class="headerlink" href="#vfs-virtual-file-system" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="vfs.html#vfs"><span class="std std-ref">VFS</span></a> lets you control how SQLite accesses storage.  APSW
makes it easy to “inherit” from an existing VFS and monitor or alter
data as it flows through.</p>
<p><a class="reference internal" href="vfs.html#apsw.URIFilename" title="apsw.URIFilename"><code class="xref py py-class docutils literal notranslate"><span class="pre">URI</span></code></a> are shown as a way to receive parameters
when opening/creating a database file, and <a class="reference internal" href="vfs.html#apsw.VFSFcntlPragma" title="apsw.VFSFcntlPragma"><code class="xref py py-class docutils literal notranslate"><span class="pre">pragmas</span></code></a>
for receiving parameters once a database is open.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example VFS obfuscates the database file contents by xor all</span>
<span class="c1"># bytes with 0xa5.</span>


<span class="k">def</span><span class="w"> </span><span class="nf">obfuscate</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">x</span> <span class="o">^</span> <span class="mh">0xA5</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>


<span class="c1"># Inheriting from a base of &quot;&quot; means the default vfs</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ObfuscatedVFS</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">VFS</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vfsname</span><span class="o">=</span><span class="s2">&quot;obfuscated&quot;</span><span class="p">,</span> <span class="n">basevfs</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vfs_name</span> <span class="o">=</span> <span class="n">vfsname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_vfs</span> <span class="o">=</span> <span class="n">basevfs</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vfs_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_vfs</span><span class="p">)</span>

    <span class="c1"># We want to return our own file implementation, but also</span>
    <span class="c1"># want it to inherit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="n">in_flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_open_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">in_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xOpen flags&quot;</span><span class="p">,</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_flags</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">URIFilename</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   uri filename&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>
            <span class="c1"># We can look at uri parameters</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   fast is&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">uri_parameter</span><span class="p">(</span><span class="s2">&quot;fast&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   level is&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">uri_int</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   warp is&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">uri_boolean</span><span class="p">(</span><span class="s2">&quot;warp&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;   notpresent is&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">uri_parameter</span><span class="p">(</span><span class="s2">&quot;notpresent&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># all of them</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   all uris&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   filename&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ObfuscatedVFSFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_vfs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>


<span class="c1"># The file implementation where we override xRead and xWrite to call our</span>
<span class="c1"># encryption routine</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ObfuscatedVFSFile</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">VFSFile</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inheritfromvfsname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inheritfromvfsname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xRead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obfuscate</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">xRead</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xWrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">xWrite</span><span class="p">(</span><span class="n">obfuscate</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xFileControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">!=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_FCNTL_PRAGMA</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">xFileControl</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span>
        <span class="c1"># implement our own pragma</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">VFSFcntlPragma</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pragma received </span><span class="si">{</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="w"> </span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># what do we understand?</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;my_custom_pragma&quot;</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># We did not understand</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># To register the VFS we just instantiate it</span>
<span class="n">obfuvfs</span> <span class="o">=</span> <span class="n">ObfuscatedVFS</span><span class="p">()</span>

<span class="c1"># Lets see what vfs are now available?</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VFS available&quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">vfs_names</span><span class="p">())</span>

<span class="c1"># Make an obfuscated db, passing in some URI parameters</span>
<span class="c1"># default open flags</span>
<span class="n">open_flags</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_READWRITE</span> <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_CREATE</span>
<span class="c1"># add in using URI parameters</span>
<span class="n">open_flags</span> <span class="o">|=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_OPEN_URI</span>

<span class="c1"># uri parameters are after the ? separated by &amp;</span>
<span class="n">obfudb</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span>
    <span class="s2">&quot;file:myobfudb?fast=speed&amp;level=7&amp;warp=on&amp;another=true&quot;</span><span class="p">,</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">open_flags</span><span class="p">,</span>
    <span class="n">vfs</span><span class="o">=</span><span class="n">obfuvfs</span><span class="o">.</span><span class="n">vfs_name</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Check it works</span>
<span class="n">obfudb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table foo(x,y); insert into foo values(1,2)&quot;</span><span class="p">)</span>

<span class="c1"># Check it really is obfuscated on disk</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;What is on disk&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;myobfudb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()[:</span><span class="mi">20</span><span class="p">]))</span>

<span class="c1"># And unobfuscating it</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Unobfuscated disk&quot;</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">(</span><span class="n">obfuscate</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;myobfudb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()[:</span><span class="mi">20</span><span class="p">])),</span>
<span class="p">)</span>

<span class="c1"># Custom pragma</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;pragma returned&quot;</span><span class="p">,</span> <span class="n">obfudb</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;my_custom_pragma&quot;</span><span class="p">,</span> <span class="s2">&quot;my value&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Tidy up</span>
<span class="n">obfudb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;myobfudb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">VFS available [&#39;unix&#39;, &#39;obfuscated&#39;, &#39;memdb&#39;, &#39;unix-excl&#39;, &#39;unix-dotfile&#39;, &#39;unix-none&#39;]</span>
<span class="go">xOpen flags SQLITE_OPEN_CREATE | SQLITE_OPEN_MAIN_DB | SQLITE_OPEN_READWRITE | SQLITE_OPEN_URI</span>
<span class="go">   uri filename /space/apsw/myobfudb</span>
<span class="go">   fast is speed</span>
<span class="go">   level is 7</span>
<span class="go">   warp is True</span>
<span class="go">   notpresent is None</span>
<span class="go">   all uris (&#39;fast&#39;, &#39;level&#39;, &#39;warp&#39;, &#39;another&#39;)</span>
<span class="go">pragma received journal_mode = wal</span>
<span class="go">xOpen flags SQLITE_OPEN_CREATE | SQLITE_OPEN_MAIN_JOURNAL | SQLITE_OPEN_READWRITE</span>
<span class="go">   filename /space/apsw/myobfudb-journal</span>
<span class="go">pragma received foreign_keys = ON</span>
<span class="go">pragma received optimize = 65538</span>
<span class="go">xOpen flags SQLITE_OPEN_CREATE | SQLITE_OPEN_READWRITE | SQLITE_OPEN_WAL</span>
<span class="go">   filename /space/apsw/myobfudb-wal</span>
<span class="go">pragma received recursive_triggers = ON</span>
<span class="go">What is on disk b&#39;\xf6\xf4\xe9\xcc\xd1\xc0\x85\xc3\xca\xd7\xc8\xc4\xd1\x85\x96\xa5\xb5\xa5\xa7\xa7&#39;</span>
<span class="go">Unobfuscated disk b&#39;SQLite format 3\x00\x10\x00\x02\x02&#39;</span>
<span class="go">pragma received my_custom_pragma = my value</span>
<span class="go">pragma returned orange</span>
</pre></div>
</div>
</section>
<section id="limits">
<span id="example-limits"></span><span id="index-31"></span><h2>Limits<a class="headerlink" href="#limits" title="Link to this heading"></a></h2>
<p>SQLite lets you see and update various limits via
<a class="reference internal" href="connection.html#apsw.Connection.limit" title="apsw.Connection.limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.limit()</span></code></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print some limits</span>
<span class="k">for</span> <span class="n">limit</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;LENGTH&quot;</span><span class="p">,</span> <span class="s2">&quot;COLUMN&quot;</span><span class="p">,</span> <span class="s2">&quot;ATTACHED&quot;</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;SQLITE_LIMIT_&quot;</span> <span class="o">+</span> <span class="n">limit</span>
    <span class="n">max_name</span> <span class="o">=</span> <span class="s2">&quot;SQLITE_MAX_&quot;</span> <span class="o">+</span> <span class="n">limit</span>  <span class="c1"># compile time limit</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">apsw</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>
    <span class="c1"># To get the maximum, set to 0x7fffffff and then read value back</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">apsw</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="mh">0x7FFFFFFF</span><span class="p">)</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">apsw</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">max_name</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>

<span class="c1"># Set limit for size of a string</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table testlimit(s)&quot;</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="s2">&quot;insert into testlimit values(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,)</span>
<span class="p">)</span>  <span class="c1"># 1024 char string</span>
<span class="n">connection</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_LIMIT_LENGTH</span><span class="p">,</span> <span class="mi">1023</span><span class="p">)</span>  <span class="c1"># limit is now 1023</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;insert into testlimit values(?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;string exceeding limit was inserted&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">apsw</span><span class="o">.</span><span class="n">TooBigError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Caught toobig exception&quot;</span><span class="p">)</span>

<span class="c1"># reset back to largest value</span>
<span class="n">connection</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_LIMIT_LENGTH</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">SQLITE_LIMIT_LENGTH 1000000000</span>
<span class="go">SQLITE_MAX_LENGTH   1000000000</span>
<span class="go">SQLITE_LIMIT_COLUMN 2000</span>
<span class="go">SQLITE_MAX_COLUMN   2000</span>
<span class="go">SQLITE_LIMIT_ATTACHED 125</span>
<span class="go">SQLITE_MAX_ATTACHED   125</span>
<span class="go">Caught toobig exception</span>
</pre></div>
</div>
</section>
<section id="shell">
<span id="example-shell"></span><span id="index-32"></span><h2>Shell<a class="headerlink" href="#shell" title="Link to this heading"></a></h2>
<p>APSW includes a <a class="reference internal" href="shell.html#shell"><span class="std std-ref">shell</span></a>  like the one in <a class="reference external" href="https://sqlite.org/cli.html">SQLite</a>, and is also extensible from
Python.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">apsw.shell</span>

<span class="c1"># Here we use the shell to do a csv export and then dump part of the</span>
<span class="c1"># database</span>

<span class="c1"># Export to a StringIO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="n">shell</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">Shell</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>

<span class="c1"># How to execute a dot command</span>
<span class="n">shell</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="s2">&quot;.mode csv&quot;</span><span class="p">)</span>
<span class="n">shell</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="s2">&quot;.headers on&quot;</span><span class="p">)</span>

<span class="c1"># How to execute SQL</span>
<span class="n">shell</span><span class="o">.</span><span class="n">process_sql</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create table csvtest(column1, column2 INTEGER);</span>
<span class="sd">    create index faster on csvtest(column1);</span>
<span class="sd">    insert into csvtest values(3, 4);</span>
<span class="sd">    insert into csvtest values(&#39;a b&#39;, NULL);</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="c1"># Or let the shell figure out SQL vs dot command</span>
<span class="n">shell</span><span class="o">.</span><span class="n">process_complete_line</span><span class="p">(</span><span class="s2">&quot;select * from csvtest&quot;</span><span class="p">)</span>

<span class="c1"># see the result</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

<span class="c1"># reset output</span>
<span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># make a dump of the same table</span>
<span class="n">shell</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="s2">&quot;.dump csvtest%&quot;</span><span class="p">)</span>

<span class="c1"># see the result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dump output</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">column1,column2</span>
<span class="go">3,4</span>
<span class="go">a b,</span>


<span class="go">Dump output</span>

<span class="go">-- SQLite dump (by APSW 3.49.1.0)</span>
<span class="go">-- SQLite version 3.49.1</span>
<span class="go">-- Date: Tue Feb 18 07:32:57 2025</span>
<span class="go">-- Tables like: csvtest%</span>
<span class="go">-- Database: /space/apsw/dbfile</span>
<span class="go">-- User: rogerb @ clamps</span>

<span class="go">-- The values of various per-database settings</span>
<span class="go">PRAGMA page_size=4096;</span>
<span class="go">-- PRAGMA encoding=&#39;UTF-8&#39;;</span>
<span class="go">-- PRAGMA auto_vacuum=NONE;</span>
<span class="go">-- PRAGMA max_page_count=4294967294;</span>

<span class="go">BEGIN TRANSACTION;</span>

<span class="go">-- Table  csvtest</span>
<span class="go">DROP TABLE IF EXISTS csvtest;</span>
<span class="go">CREATE TABLE csvtest(column1, column2 INTEGER);</span>
<span class="go">INSERT INTO csvtest VALUES(3,4);</span>
<span class="go">INSERT INTO csvtest VALUES(&#39;a b&#39;,NULL);</span>
<span class="go">-- Triggers and indices on  csvtest</span>
<span class="go">CREATE INDEX faster on csvtest(column1);</span>

<span class="go">-- Database header</span>
<span class="go">pragma user_version=1234;</span>

<span class="go">COMMIT TRANSACTION;</span>
</pre></div>
</div>
</section>
<section id="statistics">
<span id="example-status"></span><span id="index-33"></span><h2>Statistics<a class="headerlink" href="#statistics" title="Link to this heading"></a></h2>
<p>SQLite provides statistics by <a class="reference internal" href="apsw.html#apsw.status" title="apsw.status"><code class="xref py py-meth docutils literal notranslate"><span class="pre">status()</span></code></a>.  Use <a class="reference internal" href="connection.html#apsw.Connection.status" title="apsw.Connection.status"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.status()</span></code></a>
for per connection statistics.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">current_usage</span><span class="p">,</span> <span class="n">max_usage</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_STATUS_MEMORY_USED</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLite memory usage </span><span class="si">{</span><span class="w"> </span><span class="n">current_usage</span><span class="w"> </span><span class="si">}</span><span class="s2"> max </span><span class="si">{</span><span class="w"> </span><span class="n">max_usage</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">schema_used</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_DBSTATUS_SCHEMA_USED</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="w"> </span><span class="n">schema_used</span><span class="w"> </span><span class="si">}</span><span class="s2"> bytes used to store schema for this connection&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">SQLite memory usage 507888 max 2498888</span>
<span class="go">5768 bytes used to store schema for this connection</span>
</pre></div>
</div>
</section>
<section id="tracing">
<span id="example-trace-v2"></span><span id="index-34"></span><h2>Tracing<a class="headerlink" href="#tracing" title="Link to this heading"></a></h2>
<p>This shows using <a class="reference internal" href="connection.html#apsw.Connection.trace_v2" title="apsw.Connection.trace_v2"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.trace_v2()</span></code></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># From https://www.sqlite.org/lang_with.html</span>
<span class="c1"># Outlandish Recursive Query Examples</span>

<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;WITH RECURSIVE</span>
<span class="s2">            xaxis(x) AS (VALUES(-2.0) UNION ALL SELECT x+0.05 FROM xaxis WHERE x&lt;1.2),</span>
<span class="s2">            yaxis(y) AS (VALUES(-1.0) UNION ALL SELECT y+0.1 FROM yaxis WHERE y&lt;1.0),</span>
<span class="s2">            m(iter, cx, cy, x, y) AS (</span>
<span class="s2">                SELECT 0, x, y, 0.0, 0.0 FROM xaxis, yaxis</span>
<span class="s2">                UNION ALL</span>
<span class="s2">                SELECT iter+1, cx, cy, x*x-y*y + cx, 2.0*x*y + cy FROM m</span>
<span class="s2">                WHERE (x*x + y*y) &lt; 4.0 AND iter&lt;28</span>
<span class="s2">            ),</span>
<span class="s2">            m2(iter, cx, cy) AS (</span>
<span class="s2">                SELECT max(iter), cx, cy FROM m GROUP BY cx, cy</span>
<span class="s2">            ),</span>
<span class="s2">            a(t) AS (</span>
<span class="s2">                SELECT group_concat( substr(&#39; .+*#&#39;, 1+min(iter/7,4), 1), &#39;&#39;)</span>
<span class="s2">                FROM m2 GROUP BY cy</span>
<span class="s2">            )</span>
<span class="s2">            SELECT group_concat(rtrim(t),x&#39;0a&#39;) FROM a;&quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">trace_hook</span><span class="p">(</span><span class="n">trace</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># check the sql and connection are as expected and remove from trace</span>
    <span class="c1"># so we don&#39;t print them</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sql&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> <span class="o">==</span> <span class="n">query</span>
        <span class="ow">and</span> <span class="n">trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">connection</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;code is &quot;</span><span class="p">,</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_trace_codes</span><span class="p">[</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]])</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>


<span class="n">connection</span><span class="o">.</span><span class="n">trace_v2</span><span class="p">(</span>
    <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_TRACE_STMT</span>
    <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_TRACE_PROFILE</span>
    <span class="o">|</span> <span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_TRACE_ROW</span><span class="p">,</span>
    <span class="n">trace_hook</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># We will get one each of the trace events</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># Turn off tracing</span>
<span class="n">connection</span><span class="o">.</span><span class="n">trace_v2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">code is  SQLITE_TRACE_STMT</span>
<span class="go">{&#39;code&#39;: 1, &#39;id&#39;: 706049952, &#39;total_changes&#39;: 146, &#39;trigger&#39;: False}</span>
<span class="go">code is  SQLITE_TRACE_ROW</span>
<span class="go">{&#39;code&#39;: 4, &#39;id&#39;: 706049952}</span>
<span class="go">code is  SQLITE_TRACE_PROFILE</span>
<span class="go">{&#39;code&#39;: 2,</span>
<span class="go"> &#39;id&#39;: 706049952,</span>
<span class="go"> &#39;nanoseconds&#39;: 18000000,</span>
<span class="go"> &#39;stmt_status&#39;: {&#39;SQLITE_STMTSTATUS_AUTOINDEX&#39;: 0,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_FILTER_HIT&#39;: 0,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_FILTER_MISS&#39;: 0,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_FULLSCAN_STEP&#39;: 1365,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_MEMUSED&#39;: 15880,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_REPREPARE&#39;: 0,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_RUN&#39;: 1,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_SORT&#39;: 2,</span>
<span class="go">                 &#39;SQLITE_STMTSTATUS_VM_STEP&#39;: 1015351},</span>
<span class="go"> &#39;total_changes&#39;: 146}</span>
</pre></div>
</div>
</section>
<section id="system-and-sqlite-resource-usage-in-a-block">
<span id="example-showresourceusage"></span><span id="index-35"></span><h2>System and SQLite resource usage in a block<a class="headerlink" href="#system-and-sqlite-resource-usage-in-a-block" title="Link to this heading"></a></h2>
<p>Use <a class="reference internal" href="ext.html#apsw.ext.ShowResourceUsage" title="apsw.ext.ShowResourceUsage"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.ShowResourceUsage()</span></code></a> to see what resources a
block of code does.  We use the same query from above.</p>
<p>Only statistics that have changed are shown in the summary. There are
20 SQLite values tracked including caching, and 20 system values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">ShowResourceUsage</span><span class="p">(</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;thread&quot;</span>
<span class="p">):</span>
    <span class="c1"># some SQLite work</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
    <span class="c1"># and some non-SQLite work - the imports cause filesystem access</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span><span class="o">,</span><span class="w"> </span><span class="nn">tokenize</span><span class="o">,</span><span class="w"> </span><span class="nn">uuid</span><span class="o">,</span><span class="w"> </span><span class="nn">fractions</span><span class="o">,</span><span class="w"> </span><span class="nn">pydoc</span><span class="o">,</span><span class="w"> </span><span class="nn">decimal</span>

    <span class="c1"># and take some wall clock time</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">            Total CPU consumption 0.021</span>
<span class="go">                       Wall clock 1.322</span>
<span class="go">           Block input operations 384</span>
<span class="go">        Maximum resident set size 208</span>
<span class="go">             Page faults - no I/O 70</span>
<span class="go">     Involuntary context switches 7</span>
<span class="go">       Voluntary context switches 5</span>
<span class="go">                Time in user mode 0.021</span>
<span class="go">           SQLite full table scan 1,365</span>
<span class="go">           SQLite sort operations 2</span>
<span class="go">             SQLite vm operations 1,015,351</span>
<span class="go">      SQLite statements completed 1</span>
<span class="go">SQLite allocations lookaside full 17,272</span>
</pre></div>
</div>
</section>
<section id="sql-statement-tracing-in-a-block">
<span id="example-trace"></span><span id="index-36"></span><h2>SQL statement tracing in a block<a class="headerlink" href="#sql-statement-tracing-in-a-block" title="Link to this heading"></a></h2>
<p>Use <a class="reference internal" href="ext.html#apsw.ext.Trace" title="apsw.ext.Trace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.Trace()</span></code></a> to see SQL statements inside a block of
code.  This also shows behind the scenes SQL.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use None instead of stdout and no information is printed or gathered</span>
<span class="k">with</span> <span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="n">vtable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># APSW does a savepoint behind the scenes to wrap the block</span>
    <span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
        <span class="c1"># Some regular SQL</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table multi(x)&quot;</span><span class="p">)</span>
        <span class="c1"># executemany runs the same statement repeatedly</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="s2">&quot;insert into multi values(?)&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">,)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># See how many rows were processed</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from multi limit 2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="c1"># You can also see how many rows were changed</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;delete from multi where x &lt; 4&quot;</span><span class="p">)</span>
        <span class="c1"># To implement the table, SQLIte issues the pragma behind the</span>
        <span class="c1"># scenes.  Note how the output shows this statement starting,</span>
        <span class="c1"># the pragma, and then this statement ending.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;select count(*) from pragma_function_list&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">&gt; SAVEPOINT &quot;_apsw-0&quot;</span>
<span class="go">    Time: 0.000</span>
<span class="go">&gt; create table multi(x)</span>
<span class="go">    Time: 0.000</span>
<span class="go">&gt; insert into multi values(?)</span>
<span class="go">    Time: 0.000  Rows: 1  Changes: 1</span>
<span class="go">&gt; insert into multi values(?)</span>
<span class="go">    Time: 0.000  Changes: 1</span>
<span class="go">&gt; insert into multi values(?)</span>
<span class="go">    Time: 0.000  Changes: 1</span>
<span class="go">&gt; insert into multi values(?)</span>
<span class="go">    Time: 0.000  Changes: 1</span>
<span class="go">&gt; insert into multi values(?)</span>
<span class="go">    Time: 0.000  Changes: 1</span>
<span class="go">&gt; select * from multi limit 2</span>
<span class="go">    Time: 0.000  Rows: 2</span>
<span class="go">&gt; delete from multi where x &lt; 4</span>
<span class="go">    Time: 0.000  Changes: 4</span>
<span class="go">&gt; select count(*) from pragma_function_list</span>
<span class="go">V PRAGMA function_list</span>
<span class="go">    Time: 0.000  Rows: 209  VmStep: 1,467  Mem: 79.7KB</span>
<span class="go">&lt; select count(*) from pragma_function_list</span>
<span class="go">    Time: 0.000  Rows: 1  VmStep: 429</span>
<span class="go">&gt; RELEASE SAVEPOINT &quot;_apsw-0&quot;</span>
<span class="go">    Time: 0.007</span>
</pre></div>
</div>
</section>
<section id="formatting-query-results-table">
<span id="example-format-query"></span><span id="index-37"></span><h2>Formatting query results table<a class="headerlink" href="#formatting-query-results-table" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="ext.html#apsw.ext.format_query_table" title="apsw.ext.format_query_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.format_query_table()</span></code></a> makes it easy
to format the results of a query in an automatic
adjusting table, colour, sanitizing strings,
truncation etc.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a table with some dummy data</span>
<span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CREATE TABLE dummy(quantity, [spaces in name], last);</span>
<span class="sd">    INSERT INTO dummy VALUES(3, &#39;some regular text to make this row interesting&#39;, x&#39;030709&#39;);</span>
<span class="sd">    INSERT INTO dummy VALUES(3.14, &#39;Tiếng Việt&#39;, null);</span>
<span class="sd">    INSERT INTO dummy VALUES(&#39;&#39;, ?, &#39; &#39;);</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;special </span><span class="se">\t\n\f\0</span><span class="s2"> cha</span><span class="se">\\</span><span class="s2">rs&quot;</span><span class="p">,),</span>
<span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM dummy&quot;</span>
<span class="c1"># default</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>

<span class="c1"># no unicode boxes and maximum sanitize the text</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;use_unicode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;string_sanitize&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

<span class="c1"># lets have unicode boxes and make things narrow</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;use_unicode&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;string_sanitize&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;text_width&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

<span class="c1"># have the values in SQL syntax</span>
<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;quote&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">format_query_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">┌──────────┬────────────────────────────────────────────────┬─────────────┐</span>
<span class="go">│ quantity │                 spaces in name                 │    last     │</span>
<span class="go">├──────────┼────────────────────────────────────────────────┼─────────────┤</span>
<span class="go">│ 3        │ some regular text to make this row interesting │ [ 3 bytes ] │</span>
<span class="go">├──────────┼────────────────────────────────────────────────┼─────────────┤</span>
<span class="go">│ 3.14     │ Tiếng Việt                                     │ (null)      │</span>
<span class="go">├──────────┼────────────────────────────────────────────────┼─────────────┤</span>
<span class="go">│          │ special                                        │             │</span>
<span class="go">│          │ \0 cha\\rs                                     │             │</span>
<span class="go">└──────────┴────────────────────────────────────────────────┴─────────────┘</span>

<span class="go">+----------+------------------------------------------------+-------------+</span>
<span class="go">| quantity |                 spaces in name                 |    last     |</span>
<span class="go">+----------+------------------------------------------------+-------------+</span>
<span class="go">| 3        | some.regular.text.to.make.this.row.interesting | [ 3 bytes ] |</span>
<span class="go">+----------+------------------------------------------------+-------------+</span>
<span class="go">| 3.14     | Ti.ng.Vi.t                                     | (null)      |</span>
<span class="go">+----------+------------------------------------------------+-------------+</span>
<span class="go">|          | special..                                      | .           |</span>
<span class="go">|          | ...cha\rs                                      |             |</span>
<span class="go">+----------+------------------------------------------------+-------------+</span>

<span class="go">┌─────┬────────────────┬─────┐</span>
<span class="go">│ qu- │ spaces in name │ la- │</span>
<span class="go">│ an- │                │ st  │</span>
<span class="go">│ ti- │                │     │</span>
<span class="go">│ ty  │                │     │</span>
<span class="go">├─────┼────────────────┼─────┤</span>
<span class="go">│ 3   │ some regular   │ [ 3 │</span>
<span class="go">│     │ text to make   │ by- │</span>
<span class="go">│     │ this row       │ te- │</span>
<span class="go">│     │ interesting    │ s ] │</span>
<span class="go">├─────┼────────────────┼─────┤</span>
<span class="go">│ 3.- │ Tiếng Việt     │ (n- │</span>
<span class="go">│ 14  │                │ ul- │</span>
<span class="go">│     │                │ l)  │</span>
<span class="go">├─────┼────────────────┼─────┤</span>
<span class="go">│     │ special        │     │</span>
<span class="go">│     │ \0 cha\\rs     │     │</span>
<span class="go">└─────┴────────────────┴─────┘</span>

<span class="go">┌──────────┬──────────────────────────────────────────────────┬───────────┐</span>
<span class="go">│ quantity │                  spaces in name                  │   last    │</span>
<span class="go">├──────────┼──────────────────────────────────────────────────┼───────────┤</span>
<span class="go">│ 3        │ &#39;some regular text to make this row interesting&#39; │ X&#39;030709&#39; │</span>
<span class="go">├──────────┼──────────────────────────────────────────────────┼───────────┤</span>
<span class="go">│ 3.14     │ &#39;Tiếng Việt&#39;                                     │ NULL      │</span>
<span class="go">├──────────┼──────────────────────────────────────────────────┼───────────┤</span>
<span class="go">│ &#39;&#39;       │ &#39;special                                         │ &#39; &#39;       │</span>
<span class="go">│          │ \0 cha\\rs&#39;                                      │           │</span>
<span class="go">└──────────┴──────────────────────────────────────────────────┴───────────┘</span>
</pre></div>
</div>
</section>
<section id="cleanup">
<span id="example-cleanup"></span><span id="index-38"></span><h2>Cleanup<a class="headerlink" href="#cleanup" title="Link to this heading"></a></h2>
<p>As a general rule you do not need to do any cleanup.  Standard
Python garbage collection will take of everything.  Even if the
process crashes with a connection in the middle of a transaction,
the next time SQLite opens that database it will automatically
rollback the incomplete transaction.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can close connections manually</span>
<span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tips.html" class="btn btn-neutral float-left" title="Tips" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="install.html" class="btn btn-neutral float-right" title="Installation and customization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="copyright.html">Copyright</a> 2004-2025, Roger Binns &lt;rogerb@rogerbinns.com&gt;.
      <span class="lastupdated">Last updated on Feb 18, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2NR9GDCQLT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2NR9GDCQLT', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>